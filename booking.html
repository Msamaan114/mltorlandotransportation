<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Book in 3 Steps | MLT Orlando Transportation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Book private transportation in Orlando. Choose route, add details, review, and pay securely with Square." />

  <!-- Use your existing site header styling -->
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* Page-only styling (scoped so it won‚Äôt mess with your site CSS) */
    .b-wrap { max-width: 1100px; margin: 0 auto; padding: 2rem 5vw 4rem; }
    .b-grid { display: grid; grid-template-columns: 1fr; gap: 18px; align-items: start; }
    @media (min-width: 980px) { .b-grid { grid-template-columns: 1.2fr .8fr; } }

    .b-card { background: #fff; border-radius: 16px; box-shadow: 0 10px 30px rgba(2,6,23,.08); overflow: hidden; border: 1px solid #e5e7eb; }
    .b-head { padding: 16px 16px 12px; border-bottom: 1px solid #e5e7eb; }
    .b-head h1, .b-head h2 { font-size: 18px; margin: 0 0 6px; }
    .b-head p { font-size: 13px; color: #475569; margin: 0; }

    .b-body { padding: 16px; }

    .b-stepper { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 14px; }
    .b-step { border: 1px solid #e5e7eb; background: #f8fafc; border-radius: 14px; padding: 10px 12px; font-size: 12px; color: #334155;
      display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .b-step.active { border-color: #93c5fd; box-shadow: 0 0 0 4px rgba(59,130,246,.10); }
    .b-badge { background: #0ea5e9; color: #fff; font-weight: 800; border-radius: 999px; padding: 4px 10px; font-size: 12px; }

    .b-muted { color: #64748b; font-size: 12px; }
    .b-danger { color: #b91c1c; }
    .b-ok { color: #166534; }

    .b-section { margin-top: 16px; }
    .b-section:first-child { margin-top: 0; }
    .b-section-title { font-weight: 800; font-size: 14px; margin-bottom: 10px; color: #0f172a; }

    .b-row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 700px) { .b-row.two { grid-template-columns: 1fr 1fr; } }
    @media (min-width: 700px) { .b-row.two.b-wide-narrow { grid-template-columns: 1.35fr .65fr; } } /* phone bigger, passengers smaller */

    .b-label { font-size: 12px; color: #334155; margin-bottom: 6px; display: block; }
    .b-input, .b-select, .b-textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #fff;
      font-size: 14px;
      outline: none;
    }
    .b-input:focus, .b-select:focus, .b-textarea:focus { border-color: #93c5fd; box-shadow: 0 0 0 4px rgba(59,130,246,.12); }
    .b-textarea { min-height: 130px; resize: vertical; }

    .b-note { margin-top: 10px; background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px; border-radius: 14px; font-size: 12px; color: #334155; }
    .b-note a { text-decoration: underline; }

    .b-btnrow { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    .b-btn { border: 0; border-radius: 999px; padding: 12px 14px; font-weight: 900; cursor: pointer; font-size: 14px; flex: 1; min-width: 160px; }
    .b-btn-primary { background: #0ea5e9; color: #fff; }
    .b-btn-secondary { background: #111827; color: #fff; }
    .b-btn-ghost { background: #e2e8f0; color: #0f172a; }
    .b-btn-secondary[disabled] { background: #9ca3af; cursor: not-allowed; }

    .b-panel { display: none; }
    .b-panel.active { display: block; }

    .b-summary { border: 1px solid #e5e7eb; border-radius: 14px; padding: 12px; background: #fff; }
    .b-summary .line { display: flex; justify-content: space-between; gap: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
    .b-summary .line:last-child { border-bottom: 0; }
    .b-summary .k { color: #64748b; }
    .b-summary .v { font-weight: 800; text-align: right; }

    .b-side { padding: 16px; }
    .b-side .box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px; border-radius: 14px; margin-bottom: 12px; }
    .b-side .box p { font-size: 12px; color: #334155; margin: 6px 0; }

    /* Phone layout */
    .b-phone-grid { display: grid; grid-template-columns: 170px minmax(0, 1fr); gap: 10px; }
    @media (max-width: 520px) { .b-phone-grid { grid-template-columns: 1fr; } }

    /* Child seats alignment */
    .b-seats-grid { display: grid; grid-template-columns: 1fr; gap: 10px; align-items: end; }
    @media (min-width: 700px) { .b-seats-grid { grid-template-columns: 1fr 1fr 1fr; } }
    .b-seats-grid .seat-col label { margin-bottom: 6px; display: block; }

    /* Quick note buttons */
    .b-quickrow { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
    .b-quickbtn {
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      cursor: pointer;
      flex: 0 0 auto;
    }
    .b-quickbtn:hover { filter: brightness(.98); }

    /* Modal */
    .b-modal-overlay {
      position: fixed; inset: 0;
      background: rgba(2,6,23,.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }
    .b-modal-overlay.show { display: flex; }
    .b-modal {
      width: 100%;
      max-width: 520px;
      background: #fff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 60px rgba(2,6,23,.25);
      overflow: hidden;
    }
    .b-modal-head { padding: 14px 16px; border-bottom: 1px solid #e5e7eb; }
    .b-modal-head h3 { margin: 0; font-size: 16px; }
    .b-modal-body { padding: 16px; }
    .b-modal-actions { padding: 14px 16px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; }
    .b-modal-actions .b-btn { min-width: 0; }
    .b-inline { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media(min-width: 700px){ .b-inline.two { grid-template-columns: 1fr 1fr; } }
  </style>
</head>

<body>
  <!-- Top contact bar (same as index.html) -->
  <div class="top-bar">
    <div class="top-bar-inner">
      <span>Private Orlando transportation from MCO &amp; SFB to Disney, Universal &amp; Cape Canaveral.</span>

      <div class="top-bar-right">
        <span>
          Call: <a href="tel:14073690643">407-369-0643</a> ¬∑
          Email: <a href="mailto:mltorlando@yahoo.com">mltorlando@yahoo.com</a>
        </span>

        <div class="social-top">
          <a href="https://facebook.com/" target="_blank" rel="noopener">
            <img src="facebook-icon.jpeg" alt="Facebook" />
          </a>
          <a href="https://wa.me/14073690643" target="_blank" rel="noopener">
            <img src="whatsapp-icon.jpeg" alt="WhatsApp" />
          </a>
          <a href="https://www.instagram.com/mltorlando?igsh=ODV0Y2pocXJ0bjk4" target="_blank" rel="noopener">
            <img src="instagram-icon.jpeg" alt="Instagram" />
          </a>
        </div>
      </div>
    </div>
  </div>

  <header>
    <div class="nav">
      <!-- UPDATED: logo is now clickable -->
      <a class="logo" href="index.html">MLT Orlando Transportation</a>

      <nav>
        <a href="index.html">Home</a>
        <a href="services.html">Services</a>
        <a href="owner.html">Owner</a>
        <a href="private-airport.html">Private Airport</a>
        <a href="child-seats.html">Child Seats</a>
        <a href="service-areas.html">Service Areas</a>
        <a href="rates.html">Rates</a>
        <a href="cancellation.html">Cancellation</a>
        <a href="why-us.html">Why Us</a>
        <a href="booking.html">Booking</a>
      </nav>
    </div>
  </header>

  <main class="b-wrap">
    <div class="b-grid">
      <!-- MAIN -->
      <div class="b-card">
        <div class="b-head">
          <h1>Book in 3 Steps</h1>
          <p>Step 1: Details ‚Üí Step 2: Review ‚Üí Step 3: Pay &amp; Confirm</p>
        </div>

        <div class="b-body">
          <div class="b-stepper">
            <div class="b-step active" id="s1">
              <span><strong>Step 1</strong><br><span class="b-muted">Trip details</span></span>
              <span class="b-badge">1</span>
            </div>
            <div class="b-step" id="s2">
              <span><strong>Step 2</strong><br><span class="b-muted">Review</span></span>
              <span class="b-badge" id="b2" style="opacity:.35;">2</span>
            </div>
            <div class="b-step" id="s3">
              <span><strong>Step 3</strong><br><span class="b-muted">Payment</span></span>
              <span class="b-badge" id="b3" style="opacity:.35;">3</span>
            </div>
          </div>

          <form id="bookingForm" novalidate>
            <!-- STEP 1 -->
            <section class="b-panel active" id="p1">

              <div class="b-section">
                <div class="b-section-title">Passenger info</div>

                <div class="b-row two">
                  <div>
                    <label class="b-label" for="passengerName">Passenger name</label>
                    <input class="b-input" id="passengerName" type="text" placeholder="Full name" required />
                  </div>
                  <div>
                    <label class="b-label" for="email">Email (same as payment)</label>
                    <input class="b-input" id="email" type="email" placeholder="name@example.com" required />
                  </div>
                </div>

                <!-- Phone bigger + passengers smaller -->
                <div class="b-row two b-wide-narrow" style="margin-top:10px;">
                  <div>
                    <label class="b-label">Mobile / WhatsApp number</label>
                    <div class="b-phone-grid">
                      <select class="b-select" id="countryCode" aria-label="Country code">
                        <option value="+1" selected>üá∫üá∏ +1 (US)</option>
                        <option value="+44">üá¨üáß +44 (UK)</option>
                        <option value="+61">üá¶üá∫ +61 (AU)</option>
                        <option value="+20">üá™üá¨ +20 (EG)</option>
                        <option value="+971">üá¶üá™ +971 (UAE)</option>
                        <option value="+966">üá∏üá¶ +966 (KSA)</option>
                        <option value="+49">üá©üá™ +49 (DE)</option>
                        <option value="+33">üá´üá∑ +33 (FR)</option>
                        <option value="+39">üáÆüáπ +39 (IT)</option>
                        <option value="+34">üá™üá∏ +34 (ES)</option>
                        <option value="+91">üáÆüá≥ +91 (IN)</option>
                        <option value="+55">üáßüá∑ +55 (BR)</option>
                        <option value="+81">üáØüáµ +81 (JP)</option>
                        <option value="+82">üá∞üá∑ +82 (KR)</option>
                      </select>
                      <input class="b-input" id="phone" type="tel" placeholder="Phone number (no country code)" required />
                    </div>
                    <div class="b-muted" style="margin-top:6px;">Example: select +44 then enter 7400 123456</div>
                  </div>

                  <div>
                    <label class="b-label" for="passengers">Passengers</label>
                    <input class="b-input" id="passengers" type="text" placeholder="e.g. 4" />
                    <div class="b-muted" style="margin-top:6px;">Optional: ‚Äú2 adults, 2 kids‚Äù.</div>
                  </div>
                </div>
              </div>

              <div class="b-section">
                <div class="b-section-title">Pickup date &amp; time</div>
                <div class="b-row two">
                  <div>
                    <label class="b-label" for="pickupDate">Pickup date</label>
                    <input class="b-input" id="pickupDate" type="date" required />
                  </div>
                  <div>
                    <label class="b-label" for="pickupTime">Pickup time (local)</label>
                    <input class="b-input" id="pickupTime" type="time" required />
                  </div>
                </div>
                <div class="b-note" id="urgencyNote" style="display:none;"></div>
              </div>

              <div class="b-section">
                <div class="b-section-title">Route &amp; price</div>

                <div class="b-row two">
                  <div>
                    <label class="b-label" for="routeSelect">Route</label>
                    <select class="b-select" id="routeSelect" required></select>
                  </div>
                  <div>
                    <label class="b-label" for="vehicleSelect">Vehicle</label>
                    <select class="b-select" id="vehicleSelect" required></select>
                  </div>
                </div>

                <div class="b-row two" style="margin-top:10px;">
                  <div>
                    <label class="b-label" for="tripType">Trip type</label>
                    <select class="b-select" id="tripType" required>
                      <option value="oneway">One-way</option>
                      <option value="round">Round trip</option>
                      <option value="hourly">Hourly charter</option>
                    </select>
                  </div>
                  <div>
                    <label class="b-label" id="priceLabel" for="priceDisplay">Total (USD)</label>
                    <input class="b-input" id="priceDisplay" readonly />
                  </div>
                </div>

                <!-- Hourly only -->
                <div class="b-row two" style="margin-top:10px; display:none;" id="hourlyRow">
                  <div>
                    <label class="b-label" for="hours">Hours (3‚Äì24)</label>
                    <select class="b-select" id="hours"></select>
                  </div>
                  <div>
                    <label class="b-label">Hourly rate</label>
                    <input class="b-input" id="hourlyRateDisplay" readonly />
                  </div>
                </div>

                <div class="b-note b-muted">
                  You can also book from <a href="rates.html"><strong>Rates</strong></a> ‚Äî if you come from there, your route will auto-fill.
                </div>
              </div>

              <div class="b-section">
                <div class="b-section-title">Locations &amp; trip details</div>

                <div class="b-row">
                  <div>
                    <label class="b-label" for="pickupLocation">Pickup location</label>
                    <input class="b-input" id="pickupLocation" type="text" list="locationSuggestions"
                      placeholder="Example: MCO arrivals / Hotel name / Full address" required />
                  </div>
                </div>

                <div class="b-row two" style="margin-top:10px;">
                  <div>
                    <label class="b-label" for="flight">Airline &amp; flight number (optional)</label>
                    <input class="b-input" id="flight" type="text" placeholder="Example: Delta 1234" />
                  </div>
                  <div>
                    <label class="b-label" for="destination">Destination</label>
                    <input class="b-input" id="destination" type="text" list="locationSuggestions"
                      placeholder="Example: Disney resort / Address" required />
                  </div>
                </div>

                <div class="b-row two" style="margin-top:10px;">
                  <div>
                    <label class="b-label" for="luggage">Luggage details (optional)</label>
                    <input class="b-input" id="luggage" type="text" placeholder="Example: 3 large, 2 carry-ons, 1 stroller" />
                  </div>

                  <!-- Child seats aligned -->
                  <div>
                    <label class="b-label">Child seats (optional)</label>
                    <div class="b-seats-grid">
                      <div class="seat-col">
                        <label class="b-muted" for="seatRear">Rear-facing</label>
                        <select class="b-select" id="seatRear">
                          <option value="0" selected>0</option><option value="1">1</option><option value="2">2</option>
                          <option value="3">3</option><option value="4">4</option>
                        </select>
                      </div>
                      <div class="seat-col">
                        <label class="b-muted" for="seatForward">Forward-facing</label>
                        <select class="b-select" id="seatForward">
                          <option value="0" selected>0</option><option value="1">1</option><option value="2">2</option>
                          <option value="3">3</option><option value="4">4</option>
                        </select>
                      </div>
                      <div class="seat-col">
                        <label class="b-muted" for="seatBooster">Booster</label>
                        <select class="b-select" id="seatBooster">
                          <option value="0" selected>0</option><option value="1">1</option><option value="2">2</option>
                          <option value="3">3</option><option value="4">4</option>
                        </select>
                      </div>
                    </div>
                    <div class="b-muted" style="margin-top:6px;">Tip: Add child ages in Notes.</div>
                  </div>
                </div>

                <!-- Optional stop (shorter labels so it fits) -->
                <div class="b-row two" style="margin-top:10px;">
                  <div>
                    <label class="b-label" for="stopType">Add a stop (optional)</label>
                    <select class="b-select" id="stopType">
                      <option value="none" selected>No stop</option>
                      <option value="stop5">Stop only (+$5)</option>
                      <option value="wait20">Stop + wait 30 min (+$20)</option>
                    </select>
                    <div class="b-muted" style="margin-top:6px;">Stop can be a hotel or grocery store along the way.</div>
                  </div>

                  <div id="stopLocationWrap" style="display:none;">
                    <label class="b-label" for="stopLocationSelect">Stop location</label>
                    <select class="b-select" id="stopLocationSelect">
                      <option value="" selected>Select‚Ä¶</option>
                      <option value="Publix">Publix</option>
                      <option value="Walmart">Walmart</option>
                      <option value="Target">Target</option>
                      <option value="Hotel">Hotel</option>
                      <option value="Other">Other</option>
                    </select>

                    <div id="stopOtherWrap" style="display:none; margin-top:10px;">
                      <label class="b-label" for="stopOtherLocation">Where do you want to stop?</label>
                      <input class="b-input" id="stopOtherLocation" type="text" list="locationSuggestions"
                        placeholder="Type the stop location (hotel/store/address)" />
                    </div>
                  </div>
                </div>

                <!-- Notes with modal prompts -->
                <div class="b-row" style="margin-top:10px;">
                  <div>
                    <label class="b-label" for="notes">Additional notes (optional)</label>

                    <div class="b-quickrow">
                      <button type="button" class="b-quickbtn" id="btnTail">‚úàÔ∏è Private jet tail #</button>
                      <button type="button" class="b-quickbtn" id="btnPets">üêæ Pets</button>
                      <button type="button" class="b-quickbtn" id="btnWheel">‚ôø Wheelchair / Mobility</button>
                      <button type="button" class="b-quickbtn" id="btnSign">ü™ß Sign name</button>
                      <button type="button" class="b-quickbtn" id="btnAssist">ü§ù Assistance</button>
                    </div>

                    <textarea class="b-textarea" id="notes"
                      placeholder="Examples: private jet tail number, pets, wheelchair, terminal/gate, special instructions, child ages, etc."></textarea>

                    <div class="b-muted" style="margin-top:6px;">
                      Quick notes will insert a line here ‚Äî if you don‚Äôt have the info now, it will insert ‚Äú____‚Äù so you can fill it later.
                    </div>
                  </div>
                </div>

                <!-- RETURN TRIP INFO moved AFTER everything in pickup area -->
                <div class="b-section" id="returnSection" style="display:none; margin-top:16px;">
                  <div class="b-section-title">Return trip information (Round trip)</div>

                  <div class="b-row two">
                    <div>
                      <label class="b-label" for="returnDate">Return pickup date</label>
                      <input class="b-input" id="returnDate" type="date" />
                    </div>
                    <div>
                      <label class="b-label" for="returnTime">Return pickup time (local)</label>
                      <input class="b-input" id="returnTime" type="time" />
                    </div>
                  </div>

                  <div class="b-row two" style="margin-top:10px;">
                    <div>
                      <label class="b-label" for="returnPickupLocation">Return pickup location</label>
                      <input class="b-input" id="returnPickupLocation" type="text" list="locationSuggestions"
                        placeholder="Example: Your hotel / address" />
                    </div>
                    <div>
                      <label class="b-label" for="returnDestination">Return destination</label>
                      <input class="b-input" id="returnDestination" type="text" list="locationSuggestions"
                        placeholder="Example: MCO Airport" />
                    </div>
                  </div>

                  <div class="b-row" style="margin-top:10px;">
                    <div>
                      <label class="b-label" for="returnFlight">Return flight (optional)</label>
                      <input class="b-input" id="returnFlight" type="text" placeholder="Example: JetBlue 456" />
                    </div>
                  </div>

                  <div class="b-note b-muted">
                    If you don‚Äôt know return details yet, you can leave blanks ‚Äî we‚Äôll confirm with you.
                  </div>
                </div>

              </div>

              <div class="b-btnrow">
                <button class="b-btn b-btn-primary" type="button" id="to2">Continue to Review</button>
              </div>
            </section>

            <!-- STEP 2 -->
            <section class="b-panel" id="p2">
              <div class="b-section-title">Review your booking</div>
              <div class="b-summary" id="summary"></div>

              <div class="b-btnrow">
                <button class="b-btn b-btn-ghost" type="button" id="back1">Back</button>
                <button class="b-btn b-btn-secondary" type="button" id="to3">Confirm &amp; Continue to Payment</button>
              </div>

              <div class="b-note b-muted">
                After you pay, Square will send a payment receipt to your email.
              </div>
            </section>

            <!-- STEP 3 -->
            <section class="b-panel" id="p3">
              <div class="b-section-title">Payment</div>
              <div class="b-note" id="payNote"></div>

              <div class="b-btnrow">
                <button class="b-btn b-btn-ghost" type="button" id="back2">Back</button>
                <button class="b-btn b-btn-secondary" type="button" id="payBtn">Pay with Square</button>
              </div>

              <div class="b-note" id="paymentMsg"></div>
            </section>
          </form>
        </div>
      </div>

      <!-- SIDE -->
      <aside class="b-card">
        <div class="b-head">
          <h2>Need help?</h2>
          <p>Contact us any time.</p>
        </div>
        <div class="b-side">
          <div class="box">
            <p><strong>Phone:</strong> <a href="tel:14073690643" style="text-decoration:underline;">407-369-0643</a></p>
            <p><strong>Email:</strong> <a href="mailto:mltorlando@yahoo.com" style="text-decoration:underline;">mltorlando@yahoo.com</a></p>
          </div>
          <div class="box">
            <p class="b-muted"><strong>Tip:</strong> If your pickup is within 8 hours, please contact us to confirm availability before payment.</p>
          </div>
        </div>
      </aside>
    </div>

    <!-- Suggestions -->
    <datalist id="locationSuggestions">
      <option value="MCO - Orlando International Airport"></option>
      <option value="SFB - Orlando Sanford International Airport"></option>
      <option value="Walt Disney World Resort"></option>
      <option value="Universal Orlando Resort"></option>
      <option value="International Drive (I-Drive)"></option>
      <option value="SeaWorld Orlando"></option>
      <option value="Orange County Convention Center"></option>
      <option value="Port Canaveral"></option>
      <option value="Lake Buena Vista"></option>
      <option value="Golden Oak"></option>
      <option value="Bay Lake"></option>
      <option value="Windermere"></option>
      <option value="Winter Park"></option>
      <option value="Publix"></option>
      <option value="Walmart"></option>
      <option value="Target"></option>
    </datalist>
  </main>

  <!-- Modal -->
  <div class="b-modal-overlay" id="modalOverlay" aria-hidden="true">
    <div class="b-modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="b-modal-head">
        <h3 id="modalTitle">Add note</h3>
      </div>
      <div class="b-modal-body" id="modalBody"></div>
      <div class="b-modal-actions">
        <button class="b-btn b-btn-ghost" type="button" id="modalCancel">Cancel</button>
        <button class="b-btn b-btn-primary" type="button" id="modalAdd">Add</button>
      </div>
    </div>
  </div>

<script>
  // =========================
  // ROUTE PRICING (from your Rates page)
  // =========================
  const ROUTES = [
    {
      id: "MCO-Universal-Idrive-Seaworld-Convention",
      label: "MCO ‚Üî Universal / I-Drive / SeaWorld / Convention Center",
      kind: "transfer",
      vehicles: {
        "Sedan": { oneway: 110, round: 210 },
        "SUV": { oneway: 120, round: 230 },
        "8-passenger van": { oneway: 140, round: 260 },
        "14-passenger van": { oneway: 170, round: 310 },
      }
    },
    {
      id: "MCO-Disney-LBV-BayLake-GoldenOak",
      label: "MCO ‚Üî Disney / Lake Buena Vista / Bay Lake / Golden Oak",
      kind: "transfer",
      vehicles: {
        "Sedan": { oneway: 120, round: 220 },
        "SUV": { oneway: 130, round: 240 },
        "8-passenger van": { oneway: 150, round: 280 },
        "14-passenger van": { oneway: 180, round: 330 },
      }
    },
    {
      id: "MCO-Windermere-WinterPark",
      label: "MCO ‚Üî Windermere / Winter Park",
      kind: "transfer",
      vehicles: {
        "Sedan": { oneway: 130, round: 240 },
        "SUV": { oneway: 140, round: 260 },
        "8-passenger van": { oneway: 160, round: 300 },
        "14-passenger van": { oneway: 190, round: 340 },
      }
    },
    {
      id: "MCO-Port-Canaveral",
      label: "MCO / Orlando ‚Üî Port Canaveral",
      kind: "transfer",
      vehicles: {
        "Sedan": { oneway: 210, round: 400 },
        "SUV": { oneway: 230, round: 440 },
        "8-passenger van": { oneway: 260, round: 500 },
        "14-passenger van": { oneway: 290, round: 560 },
      }
    },
    {
      id: "SFB-Universal-Idrive-Seaworld-Convention",
      label: "SFB ‚Üî I-Drive / Convention / Universal / SeaWorld",
      kind: "transfer",
      vehicles: {
        "Sedan": { oneway: 160, round: 300 },
        "SUV": { oneway: 175, round: 330 },
        "8-passenger van": { oneway: 200, round: 380 },
        "14-passenger van": { oneway: 225, round: 420 },
      }
    },
    {
      id: "SFB-Disney-LBV-BayLake-GoldenOak",
      label: "SFB ‚Üî Disney / Lake Buena Vista / Bay Lake / Golden Oak",
      kind: "transfer",
      vehicles: {
        "Sedan": { oneway: 175, round: 330 },
        "SUV": { oneway: 190, round: 360 },
        "8-passenger van": { oneway: 220, round: 420 },
        "14-passenger van": { oneway: 245, round: 470 },
      }
    },
    {
      id: "Hourly-Orlando",
      label: "Hourly Charter (within Orlando) ‚Äî 3 hour minimum",
      kind: "hourly",
      vehicles: {
        "Sedan": { hourly: 70 },
        "SUV": { hourly: 85 },
        "8-passenger van": { hourly: 95 },
        "14-passenger van": { hourly: 120 },
      }
    }
  ];

  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);
  const esc = (s) => String(s || "").replaceAll("<","&lt;").replaceAll(">","&gt;");

  function isFinitePositive(n){ const x = Number(n); return Number.isFinite(x) && x > 0; }

  function getPickupDateTimeLocal() {
    const d = $("pickupDate").value;
    const t = $("pickupTime").value;
    if (!d || !t) return null;
    const dt = new Date(d + "T" + t);
    return isNaN(dt.getTime()) ? null : dt;
  }
  function hoursUntil(dt) {
    const now = new Date();
    return (dt.getTime() - now.getTime()) / (1000 * 60 * 60);
  }

  function seatSummary() {
    const rear = Number($("seatRear").value || 0);
    const fwd  = Number($("seatForward").value || 0);
    const boo  = Number($("seatBooster").value || 0);
    if (!rear && !fwd && !boo) return "None";
    return `Rear-facing: ${rear}, Forward-facing: ${fwd}, Booster: ${boo}`;
  }

  function fullPhone() {
    const cc = $("countryCode").value || "";
    const p = ($("phone").value || "").trim();
    return (cc && p) ? `${cc} ${p}` : p;
  }

  function getStopFee() {
    const t = $("stopType").value;
    if (t === "stop5") return 5;
    if (t === "wait20") return 20;
    return 0;
  }

  function getRouteObj() {
    const id = $("routeSelect").value;
    return ROUTES.find(r => r.id === id) || null;
  }

  function fillRoutes() {
    const sel = $("routeSelect");
    sel.innerHTML = "";
    for (const r of ROUTES) {
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = r.label;
      sel.appendChild(opt);
    }
  }

  function fillVehicles(routeObj) {
    const sel = $("vehicleSelect");
    sel.innerHTML = "";
    const names = Object.keys(routeObj.vehicles);
    for (const v of names) {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    }
  }

  function getBaseAmount() {
    const r = getRouteObj();
    if (!r) return 0;
    const v = $("vehicleSelect").value;
    const prices = r.vehicles[v];
    if (!prices) return 0;

    if (r.kind === "hourly") {
      const rate = Number(prices.hourly || 0);
      const hrs = Number($("hours").value || 3);
      return rate * hrs;
    }

    const tt = $("tripType").value;
    if (tt === "round") return Number(prices.round || 0);
    if (tt === "oneway") return Number(prices.oneway || 0);
    return 0;
  }

  // =========================
  // Populate Hours dropdown
  // =========================
  for (let h = 3; h <= 24; h++) {
    const opt = document.createElement("option");
    opt.value = String(h);
    opt.textContent = String(h);
    $("hours").appendChild(opt);
  }

  // =========================
  // Stop UI
  // =========================
  function refreshStopUI() {
    const type = $("stopType").value;
    const wrap = $("stopLocationWrap");
    const otherWrap = $("stopOtherWrap");
    const sel = $("stopLocationSelect");
    const other = $("stopOtherLocation");

    if (type === "none") {
      wrap.style.display = "none";
      otherWrap.style.display = "none";
      sel.value = "";
      other.value = "";
      return;
    }

    wrap.style.display = "block";
    // show text input only for Hotel/Other
    if (sel.value === "Hotel" || sel.value === "Other") {
      otherWrap.style.display = "block";
      other.placeholder = sel.value === "Hotel"
        ? "Hotel name / address"
        : "Type the stop location (hotel/store/address)";
    } else {
      otherWrap.style.display = "none";
      other.value = "";
    }
  }

  $("stopType").addEventListener("change", () => {
    refreshStopUI();
    refreshPrice();
  });
  $("stopLocationSelect").addEventListener("change", () => {
    refreshStopUI();
  });

  // =========================
  // Return visibility
  // =========================
  function syncReturnVisibility() {
    const r = getRouteObj();
    const isHourly = r && r.kind === "hourly";
    if (isHourly) {
      $("returnSection").style.display = "none";
      return;
    }
    $("returnSection").style.display = ($("tripType").value === "round") ? "block" : "none";
  }

  // =========================
  // Price UI
  // =========================
  function refreshTripUI() {
    const r = getRouteObj();
    if (!r) return;

    if (r.kind === "hourly") {
      $("tripType").value = "hourly";
      $("tripType").disabled = true;
      $("hourlyRow").style.display = "grid";
      $("returnSection").style.display = "none";
      $("priceLabel").textContent = "Total (USD)";
      const rate = r.vehicles[$("vehicleSelect").value]?.hourly || 0;
      $("hourlyRateDisplay").value = `$${Number(rate).toFixed(2)} / hr`;
    } else {
      $("tripType").disabled = false;
      $("hourlyRow").style.display = "none";
      $("hourlyRateDisplay").value = "";
      syncReturnVisibility();
    }

    refreshPrice();
  }

  function refreshPrice() {
    const base = getBaseAmount();
    const stopFee = getStopFee();
    const total = base + stopFee;

    if (!isFinitePositive(base)) {
      $("priceDisplay").value = "";
      return;
    }
    $("priceDisplay").value = `$${total.toFixed(2)}` + (stopFee ? ` (includes stop +$${stopFee})` : "");
  }

  // =========================
  // Prefill from URL (if coming from Rates)
  // =========================
  function prefillFromUrl() {
    const params = new URLSearchParams(location.search);
    const route = params.get("route");
    const vehicle = params.get("vehicle");
    const trip = params.get("trip");

    if (route && ROUTES.some(r => r.id === route)) $("routeSelect").value = route;
    const r = getRouteObj();
    if (r) {
      fillVehicles(r);

      if (vehicle) {
        const candidates = Array.from($("vehicleSelect").options).map(o => o.value);
        const mapped =
          (vehicle === "Van8") ? "8-passenger van" :
          (vehicle === "Van14") ? "14-passenger van" :
          vehicle;
        if (candidates.includes(mapped)) $("vehicleSelect").value = mapped;
      }

      if (r.kind === "hourly") {
        $("tripType").value = "hourly";
      } else if (trip === "round" || trip === "roundtrip") {
        $("tripType").value = "round";
      } else {
        $("tripType").value = "oneway";
      }
    }

    refreshTripUI();
  }

  // =========================
  // Init route/vehicle UI
  // =========================
  fillRoutes();
  $("routeSelect").value = ROUTES[0].id;
  fillVehicles(getRouteObj());
  prefillFromUrl();

  $("routeSelect").addEventListener("change", () => {
    const r = getRouteObj();
    if (!r) return;
    fillVehicles(r);
    refreshTripUI();
  });
  $("vehicleSelect").addEventListener("change", refreshTripUI);
  $("tripType").addEventListener("change", () => { refreshTripUI(); syncReturnVisibility(); });
  $("hours").addEventListener("change", refreshPrice);

  // Init stop UI
  refreshStopUI();

  // =========================
  // Short notice note
  // =========================
  const urgencyNote = $("urgencyNote");
  function refreshUrgency() {
    const dt = getPickupDateTimeLocal();
    const within8 = dt ? hoursUntil(dt) <= 8 : false;
    if (dt && within8) {
      urgencyNote.style.display = "block";
      urgencyNote.innerHTML = `<span class="b-danger"><strong>Short notice:</strong> pickup is within 8 hours. Please contact us to confirm availability before paying.</span>`;
    } else {
      urgencyNote.style.display = "none";
      urgencyNote.innerHTML = "";
    }
  }
  $("pickupDate").addEventListener("change", refreshUrgency);
  $("pickupTime").addEventListener("change", refreshUrgency);
  refreshUrgency();

  // =========================
  // Steps UI
  // =========================
  const p1 = $("p1"), p2 = $("p2"), p3 = $("p3");
  const s1 = $("s1"), s2 = $("s2"), s3 = $("s3");
  const b2 = $("b2"), b3 = $("b3");

  function setStep(n){
    p1.classList.toggle("active", n===1);
    p2.classList.toggle("active", n===2);
    p3.classList.toggle("active", n===3);
    s1.classList.toggle("active", n===1);
    s2.classList.toggle("active", n===2);
    s3.classList.toggle("active", n===3);
    b2.style.opacity = n>=2 ? "1" : ".35";
    b3.style.opacity = n>=3 ? "1" : ".35";
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function val(id){ return ($(id).value || "").trim(); }

  function getStopLocationText() {
    if ($("stopType").value === "none") return "";
    const sel = $("stopLocationSelect").value;
    if (!sel) return "";
    if (sel === "Hotel") return `Hotel: ${val("stopOtherLocation") || "____"}`;
    if (sel === "Other") return `${val("stopOtherLocation") || "____"}`;
    return sel;
  }

  function validateStep1(){
    const required = ["passengerName","email","phone","pickupDate","pickupTime","pickupLocation","destination"];
    for (const id of required) {
      const el = $(id);
      if (!el.value.trim()) { el.focus(); return {ok:false, msg:"Please complete all required fields."}; }
    }

    // short notice check (block payment flow)
    const dt = getPickupDateTimeLocal();
    const within8 = dt ? hoursUntil(dt) <= 8 : false;
    if (within8) return {ok:false, msg:"Pickup is within 8 hours. Please contact us before payment."};

    // Route + price must exist
    const base = getBaseAmount();
    if (!isFinitePositive(base)) return {ok:false, msg:"Please select a valid route / vehicle / trip type."};

    // Stop validation
    if ($("stopType").value !== "none") {
      const sel = $("stopLocationSelect").value;
      if (!sel) return {ok:false, msg:"Please select the stop location (or choose No stop)."};
      if ((sel === "Hotel" || sel === "Other") && !val("stopOtherLocation")) {
        $("stopOtherLocation").focus();
        return {ok:false, msg:"Please type where you want to stop."};
      }
    }

    return {ok:true};
  }

  function buildBookingData(cid){
    const rObj = getRouteObj();
    const stopFee = getStopFee();
    const base = getBaseAmount();
    const total = base + stopFee;

    const trip = (rObj?.kind === "hourly") ? "hourly" : $("tripType").value;

    const booking = {
      confirmation_id: cid,
      passenger_name: val("passengerName"),
      email: val("email"),
      phone: fullPhone(),
      passengers: val("passengers"),
      pickup_date: val("pickupDate"),
      pickup_time: val("pickupTime"),
      pickup_location: val("pickupLocation"),
      destination: val("destination"),
      flight: val("flight"),
      luggage: val("luggage"),
      child_seats: seatSummary(),
      notes: val("notes"),

      route_id: rObj?.id || "",
      route_label: rObj?.label || "",
      vehicle: $("vehicleSelect").value || "",
      trip_type: trip,

      hourly_hours: (trip === "hourly") ? Number($("hours").value || 3) : "",
      stop_type: $("stopType").value,
      stop_location: getStopLocationText(),
      stop_fee: stopFee ? stopFee.toFixed(2) : "0.00",

      base_amount_usd: base.toFixed(2),
      total_amount_usd: total.toFixed(2),
    };

    if (trip === "round") {
      booking.return_date = val("returnDate");
      booking.return_time = val("returnTime");
      booking.return_pickup_location = val("returnPickupLocation");
      booking.return_destination = val("returnDestination");
      booking.return_flight = val("returnFlight");
    }

    return booking;
  }

  function renderSummary(data){
    const lines = [
      ["Confirmation #", data.confirmation_id],
      ["Name", data.passenger_name],
      ["Email", data.email],
      ["Phone", data.phone],
      ["Passengers", data.passengers || "-"],
      ["Pickup", `${data.pickup_date} ${data.pickup_time}`],
      ["Route", data.route_label],
      ["Vehicle", data.vehicle],
      ["Trip", data.trip_type],
    ];

    if (data.trip_type === "hourly") lines.push(["Hours", String(data.hourly_hours)]);
    if (data.stop_type !== "none") lines.push(["Stop", `${data.stop_location} (+$${data.stop_fee})`]);
    lines.push(["Total", `$${data.total_amount_usd}`]);

    lines.push(["Pickup location", data.pickup_location]);
    lines.push(["Destination", data.destination]);
    lines.push(["Flight", data.flight || "-"]);
    lines.push(["Luggage", data.luggage || "-"]);
    lines.push(["Child seats", data.child_seats || "None"]);

    if (data.trip_type === "round") {
      const rInfo =
        (data.return_date || data.return_time || data.return_pickup_location || data.return_destination) ?
        `${data.return_date || "____"} ${data.return_time || "____"} | ${data.return_pickup_location || "____"} ‚Üí ${data.return_destination || "____"} | Flight: ${data.return_flight || "‚Äî"}` :
        "Not provided (we will confirm with you)";
      lines.push(["Return", rInfo]);
    }

    lines.push(["Notes", data.notes || "-"]);

    $("summary").innerHTML = lines.map(([k,v]) => `
      <div class="line"><div class="k">${esc(k)}</div><div class="v">${esc(v)}</div></div>
    `).join("");
  }

  $("to2").addEventListener("click", () => {
    const v = validateStep1();
    if (!v.ok) return alert(v.msg);

    const cid = "MLT-" + Date.now() + "-" + Math.random().toString(16).slice(2,8).toUpperCase();
    const data = buildBookingData(cid);

    localStorage.setItem("mltBooking:" + cid, JSON.stringify(data));
    localStorage.setItem("mltLastCid", cid);

    renderSummary(data);
    setStep(2);
  });

  $("back1").addEventListener("click", () => setStep(1));

  $("to3").addEventListener("click", () => {
    const cid = localStorage.getItem("mltLastCid") || "";
    const saved = cid ? localStorage.getItem("mltBooking:" + cid) : null;
    const data = saved ? JSON.parse(saved) : null;
    if (!data) return alert("Missing saved booking data. Please go back and try again.");

    $("payNote").innerHTML =
      `You will be redirected to Square for secure payment.<br>
       <span class="b-muted">Confirmation #: <strong>${esc(data.confirmation_id)}</strong></span><br>
       <span class="b-muted">Total: <strong>$${esc(data.total_amount_usd)}</strong></span>`;

    setStep(3);
  });

  $("back2").addEventListener("click", () => setStep(2));

  // =========================
  // Payment (uses your existing /api/create-square-link)
  // =========================
  const payBtn = $("payBtn");
  const paymentMsg = $("paymentMsg");

  payBtn.addEventListener("click", async () => {
    paymentMsg.innerHTML = "";
    payBtn.disabled = true;
    payBtn.textContent = "Creating payment link...";

    try {
      const cid = localStorage.getItem("mltLastCid") || "";
      const saved = cid ? localStorage.getItem("mltBooking:" + cid) : null;
      const booking = saved ? JSON.parse(saved) : null;
      if (!booking) throw new Error("Missing booking data. Please go back and try again.");

      const amount = Number(booking.total_amount_usd);
      if (!Number.isFinite(amount) || amount <= 0) throw new Error("Invalid total amount.");

      const note =
        `CID:${booking.confirmation_id} | ${booking.passenger_name} | ${booking.route_label} | ${booking.vehicle} | ${booking.trip_type} | ` +
        `${booking.pickup_date} ${booking.pickup_time} | ${booking.pickup_location} -> ${booking.destination} | ` +
        (booking.stop_type !== "none" ? `Stop:${booking.stop_location} | ` : "") +
        `Phone:${booking.phone} | Email:${booking.email}`;

      const r = await fetch("/api/create-square-link", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount,
          currency: "USD",
          name: "MLT Orlando Transportation",
          note
        }),
      });

      const data = await r.json().catch(() => ({}));

      if (!data.ok) {
        paymentMsg.innerHTML =
          `<span class="b-danger"><strong>Error:</strong> ${esc(data.error || "Could not create payment link.")}</span>` +
          (data.details ? `<div class="b-note"><pre style="white-space:pre-wrap">${esc(JSON.stringify(data.details, null, 2))}</pre></div>` : "");
        payBtn.disabled = false;
        payBtn.textContent = "Pay with Square";
        return;
      }

      paymentMsg.innerHTML = `<span class="b-ok"><strong>Success:</strong> Redirecting to Square‚Ä¶</span>`;
      window.location.href = data.url;

    } catch (e) {
      paymentMsg.innerHTML = `<span class="b-danger"><strong>Error:</strong> ${esc(e.message || "Failed. Please try again.")}</span>`;
      payBtn.disabled = false;
      payBtn.textContent = "Pay with Square";
    }
  });

  // =========================
  // Modal-driven quick notes
  // =========================
  const modalOverlay = $("modalOverlay");
  const modalTitle = $("modalTitle");
  const modalBody = $("modalBody");
  const modalCancel = $("modalCancel");
  const modalAdd = $("modalAdd");

  let modalState = null;

  function openModal(state) {
    modalState = state;
    modalTitle.textContent = state.title;
    modalBody.innerHTML = state.render();

    modalOverlay.classList.add("show");
    modalOverlay.setAttribute("aria-hidden", "false");

    setTimeout(() => {
      const first = modalBody.querySelector("input,select,textarea");
      if (first) first.focus();
    }, 0);
  }

  function closeModal() {
    modalOverlay.classList.remove("show");
    modalOverlay.setAttribute("aria-hidden", "true");
    modalBody.innerHTML = "";
    modalState = null;
  }

  function addNoteLine(line) {
    const ta = $("notes");
    const current = (ta.value || "").trim();
    const cleaned = (line || "").trim();
    if (!cleaned) return;
    if (current.includes(cleaned)) return;
    ta.value = current ? (current + "\n" + cleaned) : cleaned;
    ta.focus();
  }

  modalCancel.addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", (e) => { if (e.target === modalOverlay) closeModal(); });

  modalAdd.addEventListener("click", () => {
    if (!modalState) return;
    addNoteLine(modalState.buildLine());
    closeModal();
  });

  // Tail number
  $("btnTail").addEventListener("click", () => {
    openModal({
      title: "Private jet tail number",
      render: () => `
        <div class="b-inline">
          <div>
            <label class="b-label" for="mTail">Tail number (optional)</label>
            <input class="b-input" id="mTail" placeholder="Example: N123AB" />
            <div class="b-muted" style="margin-top:6px;">If you don‚Äôt have it now, leave blank and we‚Äôll insert ‚Äú____‚Äù.</div>
          </div>
        </div>
      `,
      buildLine: () => {
        const v = (document.getElementById("mTail").value || "").trim();
        return `Private jet tail number: ${v || "____"}`;
      }
    });
  });

  // Pets
  $("btnPets").addEventListener("click", () => {
    openModal({
      title: "Pets traveling with you",
      render: () => `
        <div class="b-inline two">
          <div>
            <label class="b-label" for="mPets">Pets (optional)</label>
            <input class="b-input" id="mPets" placeholder="Example: 2 small dogs" />
            <div class="b-muted" style="margin-top:6px;">Type how many + what kind (or leave blank).</div>
          </div>
          <div>
            <label class="b-label" for="mPetCarrier">Carrier / leash?</label>
            <select class="b-select" id="mPetCarrier">
              <option value="">(optional)</option>
              <option value="Carrier">Carrier</option>
              <option value="Leash">Leash</option>
              <option value="Both">Both</option>
            </select>
          </div>
        </div>
      `,
      buildLine: () => {
        const v = (document.getElementById("mPets").value || "").trim();
        const carrier = (document.getElementById("mPetCarrier").value || "").trim();
        const base = `Pets: ${v || "____"}`;
        return carrier ? `${base} | ${carrier}` : base;
      }
    });
  });

  // Wheelchair / mobility
  $("btnWheel").addEventListener("click", () => {
    openModal({
      title: "Wheelchair / mobility aid",
      render: () => `
        <div class="b-inline two">
          <div>
            <label class="b-label" for="mMobType">Type</label>
            <select class="b-select" id="mMobType">
              <option value="Wheelchair (folding)">Wheelchair (folding)</option>
              <option value="Wheelchair (powered)">Wheelchair (powered)</option>
              <option value="Walker">Walker</option>
              <option value="Stroller">Stroller</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="b-label" for="mMobNotes">Details (optional)</label>
            <input class="b-input" id="mMobNotes" placeholder="Example: needs trunk space / assistance" />
            <div class="b-muted" style="margin-top:6px;">Leave blank if not sure ‚Äî we‚Äôll insert ‚Äú____‚Äù.</div>
          </div>
        </div>
      `,
      buildLine: () => {
        const type = (document.getElementById("mMobType").value || "").trim();
        const notes = (document.getElementById("mMobNotes").value || "").trim();
        return `Mobility aid: ${type}${notes ? ` | ${notes}` : " | ____"}`;
      }
    });
  });

  // Sign name (updated note text per your request)
  $("btnSign").addEventListener("click", () => {
    openModal({
      title: "Meet & greet sign name",
      render: () => `
        <div class="b-inline">
          <div>
            <label class="b-label" for="mSign">Name for the sign (optional)</label>
            <input class="b-input" id="mSign" placeholder="Example: JOHN SMITH" />
            <div class="b-muted" style="margin-top:6px;">Only if you prefer a different name than the reservation name.</div>
          </div>
        </div>
      `,
      buildLine: () => {
        const v = (document.getElementById("mSign").value || "").trim();
        return `Meet & greet sign name: ${v || "____"}`;
      }
    });
  });

  // Assistance
  $("btnAssist").addEventListener("click", () => {
    openModal({
      title: "Pickup assistance / extra time",
      render: () => `
        <div class="b-inline two">
          <div>
            <label class="b-label" for="mAssistType">Assistance type</label>
            <select class="b-select" id="mAssistType">
              <option value="Elderly assistance">Elderly assistance</option>
              <option value="Extra time needed">Extra time needed</option>
              <option value="Help with luggage">Help with luggage</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="b-label" for="mAssistNotes">Details (optional)</label>
            <input class="b-input" id="mAssistNotes" placeholder="Example: 10 minutes extra / door pickup" />
            <div class="b-muted" style="margin-top:6px;">Leave blank if not sure ‚Äî we‚Äôll insert ‚Äú____‚Äù.</div>
          </div>
        </div>
      `,
      buildLine: () => {
        const type = (document.getElementById("mAssistType").value || "").trim();
        const notes = (document.getElementById("mAssistNotes").value || "").trim();
        return `Assistance: ${type}${notes ? ` | ${notes}` : " | ____"}`;
      }
    });
  });

  // Final sync (return visibility)
  syncReturnVisibility();
</script>
</body>
</html>
