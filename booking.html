<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Book in 3 Steps | MLT Orlando Transportation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Book your ride in 3 steps: details, review, payment, confirmation." />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { background: #f3f4f6; color: #020617; line-height: 1.55; }
    a { color: inherit; text-decoration: none; }
    header { background: #020617; color: #fff; padding: 16px; }
    .nav { max-width: 1100px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    .brand { font-weight: 800; letter-spacing: .5px; }
    .links { display: flex; gap: 14px; flex-wrap: wrap; font-size: 14px; opacity: .95; }
    .links a { padding: 6px 10px; border-radius: 10px; }
    .links a:hover { background: rgba(255,255,255,.08); }

    main { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 18px; }
    @media (min-width: 980px) { .grid { grid-template-columns: 1.2fr .8fr; } }

    .card { background: #fff; border-radius: 16px; box-shadow: 0 10px 30px rgba(2,6,23,.08); overflow: hidden; }
    .card .head { padding: 16px 16px 12px; border-bottom: 1px solid #e5e7eb; }
    .card .head h1, .card .head h2 { font-size: 18px; margin-bottom: 6px; }
    .card .head p { font-size: 13px; color: #475569; }

    .body { padding: 16px; }

    .stepper { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 14px; }
    .step {
      border: 1px solid #e5e7eb;
      background: #f8fafc;
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12px;
      color: #334155;
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
    .step.active { border-color: #93c5fd; box-shadow: 0 0 0 4px rgba(59,130,246,.10); }
    .badge { background: #0ea5e9; color:#fff; font-weight:800; border-radius:999px; padding: 4px 10px; font-size: 12px; }
    .muted { color: #64748b; font-size: 12px; }
    .danger { color: #b91c1c; }
    .ok { color: #166534; }

    form { padding: 0; }
    .section { margin-top: 16px; }
    .section:first-child { margin-top: 0; }
    .section-title { font-weight: 750; font-size: 14px; margin-bottom: 10px; color: #0f172a; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 700px) { .row.two { grid-template-columns: 1fr 1fr; } }

    label { font-size: 12px; color: #334155; margin-bottom: 6px; display: block; }
    input, select, textarea {
      width: 100%;
      padding: 12px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #fff;
      font-size: 14px;
      outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: #93c5fd; box-shadow: 0 0 0 4px rgba(59,130,246,.12); }
    textarea { min-height: 100px; resize: vertical; }

    .note {
      margin-top: 10px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      padding: 12px;
      border-radius: 14px;
      font-size: 12px;
      color: #334155;
    }

    .btnrow { display:flex; gap:10px; margin-top: 14px; flex-wrap: wrap; }
    button {
      border: 0;
      border-radius: 999px;
      padding: 12px 14px;
      font-weight: 800;
      cursor: pointer;
      font-size: 14px;
      flex: 1;
      min-width: 160px;
    }
    .btn-primary { background: #0ea5e9; color: #fff; }
    .btn-primary:hover { filter: brightness(.97); }
    .btn-secondary { background: #111827; color: #fff; }
    .btn-secondary:hover { filter: brightness(.97); }
    .btn-ghost { background: #e2e8f0; color: #0f172a; }
    .btn-ghost:hover { filter: brightness(.98); }
    .btn-secondary[disabled] { background:#9ca3af; cursor:not-allowed; }

    .panel { display:none; }
    .panel.active { display:block; }

    .summary { border: 1px solid #e5e7eb; border-radius: 14px; padding: 12px; background:#fff; }
    .summary .line { display:flex; justify-content: space-between; gap: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
    .summary .line:last-child { border-bottom: 0; }
    .summary .k { color:#64748b; }
    .summary .v { font-weight: 700; text-align: right; }

    .side { padding: 16px; }
    .side h3 { font-size: 14px; margin-bottom: 10px; }
    .side .box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px; border-radius: 14px; margin-bottom: 12px; }
    .side .box p { font-size: 12px; color: #334155; margin: 6px 0; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
  </style>
</head>

<body>
<header>
  <div class="nav">
    <div class="brand">MLT ORLANDO TRANSPORTATION</div>
    <nav class="links">
      <a href="index.html">Home</a>
      <a href="services.html">Services</a>
      <a href="owner.html">Owner</a>
      <a href="private-airport.html">Private Airport</a>
      <a href="child-seats.html">Child Seats</a>
      <a href="service-areas.html">Service Areas</a>
      <a href="rates.html">Rates</a>
    </nav>
  </div>
</header>

<main>
  <div class="grid">
    <div class="card">
      <div class="head">
        <h1>Book in 3 Steps</h1>
        <p>Step 1: Details → Step 2: Review → Step 3: Pay &amp; Confirm</p>
      </div>

      <div class="body">
        <div class="stepper">
          <div class="step" id="s1"><span><strong>Step 1</strong><br><span class="muted">Trip details</span></span><span class="badge" id="b1">1</span></div>
          <div class="step" id="s2"><span><strong>Step 2</strong><br><span class="muted">Review</span></span><span class="badge" id="b2" style="opacity:.35;">2</span></div>
          <div class="step" id="s3"><span><strong>Step 3</strong><br><span class="muted">Payment</span></span><span class="badge" id="b3" style="opacity:.35;">3</span></div>
        </div>

        <form id="bookingForm" novalidate>
          <!-- Panel 1 -->
          <section class="panel active" id="panel1">
            <div class="section">
              <div class="section-title">Passenger info</div>
              <div class="row two">
                <div>
                  <label for="passengerName">Passenger name</label>
                  <input id="passengerName" name="passenger_name" type="text" placeholder="Full name" required />
                </div>
                <div>
                  <label for="email">Email (same as payment)</label>
                  <input id="email" name="email" type="email" placeholder="name@example.com" required />
                </div>
              </div>
              <div class="row two" style="margin-top:10px;">
                <div>
                  <label for="phone">Mobile / WhatsApp number</label>
                  <input id="phone" name="phone" type="tel" placeholder="(407) 000-0000" required />
                </div>
                <div>
                  <label for="passengers">Number of passengers</label>
                  <input id="passengers" name="passengers" type="text" placeholder="e.g. 2 adults, 2 children" />
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-title">Pickup date &amp; time</div>
              <div class="row two">
                <div>
                  <label for="pickupDate">Pickup date</label>
                  <input id="pickupDate" name="pickup_date" type="date" required />
                </div>
                <div>
                  <label for="pickupTime">Pickup time (local)</label>
                  <input id="pickupTime" name="pickup_time" type="time" required />
                </div>
              </div>
              <div class="note" id="urgencyNote" style="display:none;"></div>
            </div>

            <div class="section">
              <div class="section-title">Route &amp; price (auto-filled from Rates)</div>

              <div class="row two">
                <div>
                  <label for="routeDisplay">Route</label>
                  <input id="routeDisplay" type="text" readonly />
                </div>
                <div>
                  <label for="vehicleDisplay">Vehicle</label>
                  <input id="vehicleDisplay" type="text" readonly />
                </div>
              </div>

              <div class="row two" style="margin-top:10px;">
                <div>
                  <label for="tripTypeDisplay">Trip type</label>
                  <input id="tripTypeDisplay" type="text" readonly />
                </div>
                <div>
                  <label for="totalPrice">Total price (USD)</label>
                  <input id="totalPrice" type="text" readonly />
                </div>
              </div>

              <div class="note">
                If these are empty, go to <a href="rates.html" style="text-decoration: underline;"><strong>Rates</strong></a> and select a route to auto-fill.
              </div>
            </div>

            <div class="section">
              <div class="section-title">Locations &amp; trip details</div>
              <div class="row">
                <div>
                  <label for="pickupLocation">Pickup location (airport, hotel, or address)</label>
                  <input id="pickupLocation" name="pickup_location" type="text" required />
                </div>
              </div>

              <div class="row two" style="margin-top:10px;">
                <div>
                  <label for="flight">Airline &amp; flight number (if flying)</label>
                  <input id="flight" name="flight" type="text" />
                </div>
                <div>
                  <label for="destination">Destination address / hotel</label>
                  <input id="destination" name="destination" type="text" required />
                </div>
              </div>

              <div class="row two" style="margin-top:10px;">
                <div>
                  <label for="luggage">Luggage details</label>
                  <input id="luggage" name="luggage" type="text" />
                </div>
                <div>
                  <label for="childSeats">Child seats</label>
                  <input id="childSeats" name="child_seats" type="text" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div>
                  <label for="notes">Additional notes</label>
                  <textarea id="notes" name="notes"></textarea>
                </div>
              </div>
            </div>

            <div class="btnrow">
              <button class="btn-primary" type="button" id="toStep2">Continue to Review</button>
            </div>

            <div class="note">
              <p><strong>Short notice policy:</strong> if pickup is within 8 hours, we must confirm availability before payment.</p>
            </div>
          </section>

          <!-- Panel 2 -->
          <section class="panel" id="panel2">
            <div class="section-title">Review your booking</div>
            <div class="summary" id="summaryBox"></div>

            <div class="btnrow">
              <button class="btn-ghost" type="button" id="backTo1">Back</button>
              <button class="btn-secondary" type="button" id="toStep3">Confirm &amp; Continue to Payment</button>
            </div>

            <div class="note">
              When you pay, you’ll be redirected to a confirmation page and we’ll receive your reservation email.
            </div>
          </section>

          <!-- Panel 3 -->
          <section class="panel" id="panel3">
            <div class="section-title">Payment</div>
            <div class="note" id="payRules"></div>

            <div class="btnrow">
              <button class="btn-ghost" type="button" id="backTo2">Back</button>
              <button class="btn-secondary" type="button" id="payBtn">Pay with Square</button>
            </div>

            <div class="note" id="paymentMsg"></div>
          </section>

        </form>
      </div>
    </div>

    <aside class="card">
      <div class="head">
        <h2>Need help?</h2>
        <p>Contact us any time.</p>
      </div>
      <div class="side">
        <div class="box">
          <h3>Contact</h3>
          <p><strong>Phone:</strong> <a href="tel:14073690643" style="text-decoration: underline;">407-369-0643</a></p>
          <p><strong>Email:</strong> <a href="mailto:mltorlando@yahoo.com" style="text-decoration: underline;">mltorlando@yahoo.com</a></p>
        </div>
        <div class="box">
          <h3>Note</h3>
          <p class="muted">API endpoint: <span class="kbd">/api/create-square-link</span></p>
          <p class="muted">Confirmation endpoint: <span class="kbd">/api/confirm-booking</span></p>
        </div>
      </div>
    </aside>
  </div>
</main>

<script>
  // --- URL param helper
  function qs(name) { return new URLSearchParams(window.location.search).get(name); }

  // Prefill from Rates page params
  const route = qs("route") || qs("Route") || "";
  const vehicle = qs("vehicle") || qs("Vehicle") || "";
  const trip = qs("trip") || qs("Trip") || qs("trip_type") || "";
  const price = qs("price") || qs("Price") || "";

  document.getElementById("routeDisplay").value = route;
  document.getElementById("vehicleDisplay").value = vehicle;
  document.getElementById("tripTypeDisplay").value = trip;
  document.getElementById("totalPrice").value = price ? `$${Number(price).toFixed(2)}` : "";

  // --- Time policy
  function getPickupDateTimeLocal() {
    const d = document.getElementById("pickupDate").value;
    const t = document.getElementById("pickupTime").value;
    if (!d || !t) return null;
    const dt = new Date(d + "T" + t);
    return isNaN(dt.getTime()) ? null : dt;
  }
  function hoursUntil(dt) {
    const now = new Date();
    return (dt.getTime() - now.getTime()) / (1000 * 60 * 60);
  }

  const urgencyNote = document.getElementById("urgencyNote");
  function refreshUrgency() {
    const dt = getPickupDateTimeLocal();
    const within8 = dt ? hoursUntil(dt) <= 8 : false;
    if (dt && within8) {
      urgencyNote.style.display = "block";
      urgencyNote.innerHTML = `<span class="danger"><strong>Short notice:</strong> pickup is within 8 hours. Please contact us to confirm availability before paying.</span>`;
    } else {
      urgencyNote.style.display = "none";
      urgencyNote.innerHTML = "";
    }
  }
  document.getElementById("pickupDate").addEventListener("change", refreshUrgency);
  document.getElementById("pickupTime").addEventListener("change", refreshUrgency);
  refreshUrgency();

  function isFinitePositiveNumber(x) {
    const n = Number(x);
    return Number.isFinite(n) && n > 0;
  }

  // --- Step handling
  const p1 = document.getElementById("panel1");
  const p2 = document.getElementById("panel2");
  const p3 = document.getElementById("panel3");
  const s1 = document.getElementById("s1");
  const s2 = document.getElementById("s2");
  const s3 = document.getElementById("s3");
  const b2 = document.getElementById("b2");
  const b3 = document.getElementById("b3");

  function setStep(n) {
    p1.classList.toggle("active", n === 1);
    p2.classList.toggle("active", n === 2);
    p3.classList.toggle("active", n === 3);

    s1.classList.toggle("active", n === 1);
    s2.classList.toggle("active", n === 2);
    s3.classList.toggle("active", n === 3);

    b2.style.opacity = n >= 2 ? "1" : ".35";
    b3.style.opacity = n >= 3 ? "1" : ".35";
  }

  function readForm() {
    const get = (id) => document.getElementById(id)?.value?.trim() || "";
    return {
      booking_id: get("bookingIdHidden") || "",
      passenger_name: get("passengerName"),
      email: get("email"),
      phone: get("phone"),
      passengers: get("passengers"),
      pickup_date: get("pickupDate"),
      pickup_time: get("pickupTime"),
      route,
      vehicle,
      trip_type: trip,
      price_usd: price,
      pickup_location: get("pickupLocation"),
      destination: get("destination"),
      flight: get("flight"),
      luggage: get("luggage"),
      child_seats: get("childSeats"),
      notes: get("notes"),
    };
  }

  function validateStep1() {
    const requiredIds = ["passengerName","email","phone","pickupDate","pickupTime","pickupLocation","destination"];
    for (const id of requiredIds) {
      const el = document.getElementById(id);
      if (!el || !el.value.trim()) {
        el?.focus();
        return { ok: false, msg: "Please complete all required fields." };
      }
    }
    if (!isFinitePositiveNumber(price)) {
      return { ok: false, msg: "Please select your route/vehicle from the Rates page so the price is filled in." };
    }
    const dt = getPickupDateTimeLocal();
    const within8 = dt ? hoursUntil(dt) <= 8 : false;
    if (within8) {
      return { ok: false, msg: "Your pickup is within 8 hours. Please contact us to confirm availability before paying." };
    }
    return { ok: true };
  }

  function renderSummary() {
    const d = readForm();
    const lines = [
      ["Booking name", d.passenger_name],
      ["Email", d.email],
      ["Phone", d.phone],
      ["Passengers", d.passengers || "-"],
      ["Pickup", `${d.pickup_date} ${d.pickup_time}`],
      ["Route", d.route || "-"],
      ["Vehicle", d.vehicle || "-"],
      ["Trip type", d.trip_type || "-"],
      ["Total price", d.price_usd ? `$${Number(d.price_usd).toFixed(2)}` : "-"],
      ["Pickup location", d.pickup_location],
      ["Destination", d.destination],
      ["Flight", d.flight || "-"],
      ["Luggage", d.luggage || "-"],
      ["Child seats", d.child_seats || "-"],
      ["Notes", d.notes || "-"],
    ];

    const box = document.getElementById("summaryBox");
    box.innerHTML = lines.map(([k,v]) => `
      <div class="line"><div class="k">${k}</div><div class="v">${String(v).replaceAll("<","&lt;")}</div></div>
    `).join("");
  }

  document.getElementById("toStep2").addEventListener("click", () => {
    const v = validateStep1();
    if (!v.ok) {
      alert(v.msg);
      return;
    }
    renderSummary();
    setStep(2);
  });

  document.getElementById("backTo1").addEventListener("click", () => setStep(1));

  document.getElementById("toStep3").addEventListener("click", () => {
    // Generate and store booking before payment
    const bookingId = `MLT-${Date.now()}-${Math.random().toString(16).slice(2,8).toUpperCase()}`;
    const booking = readForm();
    booking.booking_id = bookingId;

    localStorage.setItem("mlt_pending_booking", JSON.stringify({
      bookingId,
      booking,
      createdAt: new Date().toISOString(),
    }));

    // Payment rules note
    document.getElementById("payRules").innerHTML =
      `You will be redirected to Square for secure payment. After payment, you’ll return here for confirmation.<br><span class="muted">Confirmation #: <strong>${bookingId}</strong></span>`;

    setStep(3);
  });

  document.getElementById("backTo2").addEventListener("click", () => setStep(2));

  // --- Payment link creation + redirect
  const payBtn = document.getElementById("payBtn");
  const paymentMsg = document.getElementById("paymentMsg");

  payBtn.addEventListener("click", async () => {
    paymentMsg.innerHTML = "";
    payBtn.disabled = true;
    payBtn.textContent = "Creating payment link...";

    try {
      const saved = JSON.parse(localStorage.getItem("mlt_pending_booking") || "{}");
      const bookingId = saved?.bookingId;
      const booking = saved?.booking;
      if (!bookingId || !booking) throw new Error("Missing pending booking");

      const amount = Number(price);
      if (!Number.isFinite(amount) || amount <= 0) throw new Error("Missing/invalid price");

      const note = `Booking ${bookingId} | ${booking.passenger_name} | ${route} | ${vehicle} | ${trip} | ${booking.pickup_date} ${booking.pickup_time}`;

      const r = await fetch("/api/create-square-link", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount,
          currency: "USD",
          name: "MLT Orlando Transportation",
          bookingId,
          buyerEmail: booking.email,
          buyerPhone: booking.phone,
          note,
          redirectPath: "/confirmation.html",
        }),
      });

      const data = await r.json();
      if (!data.ok) {
        console.log("Square error:", data);
        paymentMsg.innerHTML = `<span class="danger"><strong>Error:</strong> Could not create payment link. Please try again or contact us.</span>`;
        payBtn.textContent = "Pay with Square";
        payBtn.disabled = false;
        return;
      }

      paymentMsg.innerHTML = `<span class="ok"><strong>Success:</strong> Redirecting to secure payment...</span>`;
      window.location.href = data.url;
    } catch (e) {
      console.error(e);
      paymentMsg.innerHTML = `<span class="danger"><strong>Error:</strong> ${e.message || "Payment failed. Please try again."}</span>`;
      payBtn.textContent = "Pay with Square";
      payBtn.disabled = false;
    }
  });
</script>

</body>
</html>
