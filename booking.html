<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Book in 3 Steps | MLT Orlando Transportation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Match index.html -->
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* Booking-only look (namespaced) */
    body.booking-page { background:#f3f4f6; color:#020617; line-height:1.55; }

    .booking-wrap{ max-width:1100px; margin:24px auto; padding:0 16px; }
    .booking-grid{ display:grid; grid-template-columns:1fr; gap:18px; }
    @media(min-width:980px){ .booking-grid{ grid-template-columns:1.2fr .8fr; } }

    .booking-card{
      background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(2,6,23,.08);
      overflow:hidden;
    }
    .booking-head{ padding:16px 16px 12px; border-bottom:1px solid #e5e7eb; }
    .booking-head h1, .booking-head h2{ font-size:18px; margin-bottom:6px; }
    .booking-head p{ font-size:13px; color:#475569; }
    .booking-body{ padding:16px; }

    .booking-stepper{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:14px; }
    .booking-step{
      border:1px solid #e5e7eb; background:#f8fafc; border-radius:14px;
      padding:10px 12px; font-size:12px; color:#334155;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .booking-step.active{ border-color:#93c5fd; box-shadow:0 0 0 4px rgba(59,130,246,.10); }
    .step-badge{ background:#0ea5e9; color:#fff; font-weight:800; border-radius:999px; padding:4px 10px; font-size:12px; }

    .muted{ color:#64748b; font-size:12px; }
    .danger{ color:#b91c1c; }
    .ok{ color:#166534; }

    .booking-section{ margin-top:16px; }
    .booking-section:first-child{ margin-top:0; }
    .booking-section-title{ font-weight:750; font-size:14px; margin-bottom:10px; color:#0f172a; }

    .booking-row{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media(min-width:700px){ .booking-row.two{ grid-template-columns:1fr 1fr; } }

    .booking-page label{ font-size:12px; color:#334155; margin-bottom:6px; display:block; }
    .booking-page input,
    .booking-page select,
    .booking-page textarea{
      width:100%;
      padding:12px;
      border:1px solid #e5e7eb;
      border-radius:12px;
      background:#fff;
      font-size:14px;
      outline:none;
    }
    .booking-page input:focus,
    .booking-page select:focus,
    .booking-page textarea:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 4px rgba(59,130,246,.12);
    }
    .booking-page textarea{ min-height:100px; resize:vertical; }

    .booking-note{
      margin-top:10px;
      background:#f8fafc;
      border:1px solid #e2e8f0;
      padding:12px;
      border-radius:14px;
      font-size:12px;
      color:#334155;
    }

    .booking-btnrow{ display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }
    .booking-page button{
      border:0;
      border-radius:999px;
      padding:12px 14px;
      font-weight:800;
      cursor:pointer;
      font-size:14px;
      flex:1;
      min-width:160px;
    }
    .booking-btn-primary{ background:#0ea5e9; color:#fff; }
    .booking-btn-secondary{ background:#111827; color:#fff; }
    .booking-btn-ghost{ background:#e2e8f0; color:#0f172a; }
    .booking-btn-secondary[disabled]{ background:#9ca3af; cursor:not-allowed; }

    .booking-panel{ display:none; }
    .booking-panel.active{ display:block; }

    .booking-summary{ border:1px solid #e5e7eb; border-radius:14px; padding:12px; background:#fff; }
    .booking-summary .line{
      display:flex; justify-content:space-between; gap:12px;
      padding:8px 0; border-bottom:1px solid #f1f5f9; font-size:13px;
    }
    .booking-summary .line:last-child{ border-bottom:0; }
    .booking-summary .k{ color:#64748b; }
    .booking-summary .v{ font-weight:700; text-align:right; }

    .booking-side{ padding:16px; }
    .booking-side .box{
      background:#f8fafc; border:1px solid #e2e8f0; padding:12px; border-radius:14px;
      margin-bottom:12px;
    }
    .booking-side .box p{ font-size:12px; color:#334155; margin:6px 0; }

    /* Phone row: code + number */
    .phone-row{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:10px;
      align-items:end;
    }
    @media(max-width:520px){
      .phone-row{ grid-template-columns: 1fr; }
    }

    /* ‚úÖ Overrides for your global styles.css (prevents double-form styling & extra margins) */
    .booking-page form{
      background: transparent;
      border: 0;
      box-shadow: none;
      padding: 0;
    }
    .booking-page input,
    .booking-page select,
    .booking-page textarea{
      margin-bottom: 0; /* cancel global form field margin */
    }
  </style>
</head>

<body class="booking-page">

  <!-- Top contact bar (same as index.html) -->
  <div class="top-bar">
    <div class="top-bar-inner">
      <span>Private Orlando transportation from MCO &amp; SFB to Disney, Universal &amp; Cape Canaveral.</span>

      <div class="top-bar-right">
        <span>
          Call: <a href="tel:14073690643">407-369-0643</a> ¬∑
          Email: <a href="mailto:mltorlando@yahoo.com">mltorlando@yahoo.com</a>
        </span>

        <div class="social-top">
          <a href="https://facebook.com/" target="_blank" rel="noopener">
            <img src="facebook-icon.jpeg" alt="Facebook" />
          </a>
          <a href="https://wa.me/14073690643" target="_blank" rel="noopener">
            <img src="whatsapp-icon.jpeg" alt="WhatsApp" />
          </a>
          <a href="https://www.instagram.com/mltorlando?igsh=ODV0Y2pocXJ0bjk4" target="_blank" rel="noopener">
            <img src="instagram-icon.jpeg" alt="Instagram" />
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Header/nav (same as index.html) -->
  <header>
    <div class="nav">
      <div class="logo">MLT Orlando Transportation</div>
      <nav>
        <a href="index.html">Home</a>
        <a href="services.html">Services</a>
        <a href="owner.html">Owner</a>
        <a href="private-airport.html">Private Airport</a>
        <a href="child-seats.html">Child Seats</a>
        <a href="service-areas.html">Service Areas</a>
        <a href="rates.html">Rates</a>
        <a href="cancellation.html">Cancellation</a>
        <a href="why-us.html">Why Us</a>
        <a href="booking.html">Booking</a>
      </nav>
    </div>
  </header>

  <main class="booking-wrap">
    <div class="booking-grid">
      <div class="booking-card">
        <div class="booking-head">
          <h1>Book in 3 Steps</h1>
          <p>Step 1: Details ‚Üí Step 2: Review ‚Üí Step 3: Pay &amp; Confirm</p>
        </div>

        <div class="booking-body">
          <div class="booking-stepper">
            <div class="booking-step active" id="s1">
              <span><strong>Step 1</strong><br><span class="muted">Trip details</span></span>
              <span class="step-badge">1</span>
            </div>
            <div class="booking-step" id="s2">
              <span><strong>Step 2</strong><br><span class="muted">Review</span></span>
              <span class="step-badge" id="b2" style="opacity:.35;">2</span>
            </div>
            <div class="booking-step" id="s3">
              <span><strong>Step 3</strong><br><span class="muted">Payment</span></span>
              <span class="step-badge" id="b3" style="opacity:.35;">3</span>
            </div>
          </div>

          <!-- Suggestions lists -->
          <datalist id="locationSuggestions">
            <option value="MCO - Orlando International Airport"></option>
            <option value="SFB - Orlando Sanford International Airport"></option>
            <option value="Universal Orlando Resort"></option>
            <option value="International Drive (I-Drive) Hotel"></option>
            <option value="Orange County Convention Center"></option>
            <option value="SeaWorld Orlando"></option>
            <option value="Walt Disney World Resort"></option>
            <option value="Lake Buena Vista Hotel"></option>
            <option value="Port Canaveral Cruise Terminal"></option>
            <option value="Hyatt Regency Orlando"></option>
            <option value="Walt Disney World Swan and Dolphin"></option>
          </datalist>

          <form id="bookingForm" novalidate>
            <!-- STEP 1 -->
            <section class="booking-panel active" id="p1">

              <div class="booking-section">
                <div class="booking-section-title">Passenger info</div>

                <div class="booking-row two">
                  <div>
                    <label for="passengerName">Passenger name</label>
                    <input id="passengerName" type="text" placeholder="Example: John Smith" required />
                  </div>
                  <div>
                    <label for="email">Email (same as payment)</label>
                    <input id="email" type="email" placeholder="name@example.com" required />
                  </div>
                </div>

                <div class="booking-row two" style="margin-top:10px;">
                  <div>
                    <label for="phoneNumber">Mobile / WhatsApp number</label>
                    <div class="phone-row">
                      <div>
                        <label class="muted" for="countryCode">Country code</label>
                        <select id="countryCode">
                          <option value="+1" selected>üá∫üá∏/üá®üá¶ +1</option>
                          <option value="+44">üá¨üáß +44 (UK)</option>
                          <option value="+61">üá¶üá∫ +61 (Australia)</option>
                          <option value="+971">üá¶üá™ +971 (UAE)</option>
                          <option value="+966">üá∏üá¶ +966 (Saudi)</option>
                          <option value="+20">üá™üá¨ +20 (Egypt)</option>
                          <option value="+33">üá´üá∑ +33 (France)</option>
                          <option value="+49">üá©üá™ +49 (Germany)</option>
                          <option value="+39">üáÆüáπ +39 (Italy)</option>
                          <option value="+34">üá™üá∏ +34 (Spain)</option>
                          <option value="OTHER">Other‚Ä¶</option>
                        </select>
                      </div>

                      <div>
                        <label class="muted" for="phoneNumber">Number</label>
                        <input id="phoneNumber" type="tel" placeholder="Example: 407 555 0123" required />
                      </div>
                    </div>

                    <div id="customCodeWrap" style="display:none; margin-top:10px;">
                      <label for="customCountryCode">Custom country code</label>
                      <input id="customCountryCode" type="text" placeholder="Example: +81" />
                      <div class="muted" style="margin-top:6px;">Tip: include the ‚Äú+‚Äù.</div>
                    </div>
                  </div>

                  <div>
                    <label for="passengers">Number of passengers</label>
                    <input id="passengers" type="text" placeholder="Example: 2 adults, 2 children" />
                  </div>
                </div>
              </div>

              <div class="booking-section">
                <div class="booking-section-title">Pickup date &amp; time</div>
                <div class="booking-row two">
                  <div>
                    <label for="pickupDate">Pickup date</label>
                    <input id="pickupDate" type="date" required />
                  </div>
                  <div>
                    <label for="pickupTime">Pickup time (local)</label>
                    <input id="pickupTime" type="time" required />
                  </div>
                </div>
                <div class="booking-note" id="urgencyNote" style="display:none;"></div>
              </div>

              <div class="booking-section">
                <div class="booking-section-title">Route, vehicle &amp; price</div>

                <div class="booking-row two">
                  <div>
                    <label for="routeSelect">Route</label>
                    <select id="routeSelect" required></select>
                  </div>
                  <div>
                    <label for="vehicleSelect">Vehicle</label>
                    <select id="vehicleSelect" required></select>
                  </div>
                </div>

                <div class="booking-row two" style="margin-top:10px;">
                  <div>
                    <label for="tripTypeSelect">Trip type</label>
                    <select id="tripTypeSelect" required>
                      <option value="oneway">One-way</option>
                      <option value="round">Round trip</option>
                      <option value="hourly">Hourly charter</option>
                    </select>
                  </div>
                  <div>
                    <label id="priceLabel">Total price (USD)</label>
                    <input id="priceDisplay" readonly placeholder="$0.00" />
                    <div class="muted" id="priceBreakdown" style="margin-top:6px;"></div>
                  </div>
                </div>

                <!-- Hourly only -->
                <div class="booking-row two" style="margin-top:10px; display:none;" id="hourlyRow">
                  <div>
                    <label for="hours">Hours (3‚Äì24)</label>
                    <select id="hours"></select>
                  </div>
                  <div>
                    <label>Hourly rate</label>
                    <input id="hourlyRateDisplay" readonly />
                  </div>
                </div>

                <div class="booking-note">
                  You can book directly here. (Rates page is optional.)
                </div>
              </div>

              <!-- Return info (Round trip only) -->
              <div class="booking-section" id="returnSection" style="display:none;">
                <div class="booking-section-title">Return trip information (Round trip)</div>

                <div class="booking-row two">
                  <div>
                    <label for="returnDate">Return pickup date</label>
                    <input id="returnDate" type="date" />
                  </div>
                  <div>
                    <label for="returnTime">Return pickup time (local)</label>
                    <input id="returnTime" type="time" />
                  </div>
                </div>

                <div class="booking-row two" style="margin-top:10px;">
                  <div>
                    <label for="returnPickupLocation">Return pickup location</label>
                    <input id="returnPickupLocation" type="text" list="locationSuggestions" placeholder="Example: Your hotel / address" />
                  </div>
                  <div>
                    <label for="returnDestination">Return destination</label>
                    <input id="returnDestination" type="text" list="locationSuggestions" placeholder="Example: MCO Airport" />
                  </div>
                </div>

                <div class="booking-row" style="margin-top:10px;">
                  <div>
                    <label for="returnFlight">Return flight (optional)</label>
                    <input id="returnFlight" type="text" placeholder="Example: JetBlue 456" />
                  </div>
                </div>

                <div class="booking-note">
                  If you‚Äôre not sure yet, you can still continue ‚Äî we will confirm return details with you.
                </div>
              </div>

              <div class="booking-section">
                <div class="booking-section-title">Locations &amp; trip details</div>

                <div class="booking-row">
                  <div>
                    <label for="pickupLocation">Pickup location</label>
                    <input id="pickupLocation" type="text" list="locationSuggestions" placeholder="Example: MCO Airport / Hotel / Address" required />
                  </div>
                </div>

                <div class="booking-row two" style="margin-top:10px;">
                  <div>
                    <label for="flight">Airline &amp; flight number (optional)</label>
                    <input id="flight" type="text" placeholder="Example: Delta 1234" />
                  </div>
                  <div>
                    <label for="destination">Destination</label>
                    <input id="destination" type="text" list="locationSuggestions" placeholder="Example: Disney resort / Address" required />
                  </div>
                </div>

                <div class="booking-row two" style="margin-top:10px;">
                  <div>
                    <label for="luggage">Luggage details (optional)</label>
                    <input id="luggage" type="text" placeholder="Example: 3 large, 2 carry-ons, stroller" />
                  </div>

                  <div>
                    <label>Child seats (optional)</label>
                    <div class="booking-row two">
                      <div>
                        <label class="muted" for="rearQty">Rear-facing</label>
                        <select id="rearQty"></select>
                      </div>
                      <div>
                        <label class="muted" for="forwardQty">Forward-facing</label>
                        <select id="forwardQty"></select>
                      </div>
                    </div>
                    <div class="booking-row" style="margin-top:10px;">
                      <div>
                        <label class="muted" for="boosterQty">Booster</label>
                        <select id="boosterQty"></select>
                      </div>
                    </div>
                    <div class="muted" style="margin-top:6px;">Child seats are complimentary when requested.</div>
                  </div>
                </div>

                <!-- Optional Stop -->
                <div class="booking-section">
                  <div class="booking-section-title">Optional stop (on the way)</div>

                  <div class="booking-row">
                    <div>
                      <label>
                        <input type="checkbox" id="addStop" style="width:auto; margin-right:8px;" />
                        Add a stop (hotel / grocery store on the way)
                      </label>
                      <div class="muted">Stop only: $5 ‚Ä¢ Stop &amp; wait: $20 (30 min)</div>
                    </div>
                  </div>

                  <div id="stopDetails" style="display:none; margin-top:10px;">
                    <div class="booking-row two">
                      <div>
                        <label for="stopType">Stop type</label>
                        <select id="stopType">
                          <option value="stop">Stop only (+$5)</option>
                          <option value="wait">Stop &amp; wait 30 min (+$20)</option>
                        </select>
                      </div>
                      <div>
                        <label for="stopLocation">Stop location</label>
                        <input id="stopLocation" type="text" list="locationSuggestions" placeholder="Example: Publix / Hotel name / Address" />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="booking-row" style="margin-top:10px;">
                  <div>
                    <label for="notes">Additional notes (optional)</label>
                    <textarea id="notes" placeholder="Child ages, gate info, special requests‚Ä¶"></textarea>
                  </div>
                </div>
              </div>

              <div class="booking-btnrow">
                <button class="booking-btn-primary" type="button" id="to2">Continue to Review</button>
              </div>
            </section>

            <!-- STEP 2 -->
            <section class="booking-panel" id="p2">
              <div class="booking-section-title">Review your booking</div>
              <div class="booking-summary" id="summary"></div>

              <div class="booking-btnrow">
                <button class="booking-btn-ghost" type="button" id="back1">Back</button>
                <button class="booking-btn-secondary" type="button" id="to3">Confirm &amp; Continue to Payment</button>
              </div>

              <div class="booking-note">
                After you pay, Square will redirect you back to our confirmation page (if enabled in your API).
              </div>
            </section>

            <!-- STEP 3 -->
            <section class="booking-panel" id="p3">
              <div class="booking-section-title">Payment</div>
              <div class="booking-note" id="payNote"></div>

              <div class="booking-btnrow">
                <button class="booking-btn-ghost" type="button" id="back2">Back</button>
                <button class="booking-btn-secondary" type="button" id="payBtn">Pay with Square</button>
              </div>

              <div class="booking-note" id="paymentMsg"></div>
            </section>
          </form>
        </div>
      </div>

      <aside class="booking-card">
        <div class="booking-head">
          <h2>Need help?</h2>
          <p>Contact us any time.</p>
        </div>
        <div class="booking-side">
          <div class="box">
            <p><strong>Phone:</strong> <a href="tel:14073690643" style="text-decoration:underline;">407-369-0643</a></p>
            <p><strong>Email:</strong> <a href="mailto:mltorlando@yahoo.com" style="text-decoration:underline;">mltorlando@yahoo.com</a></p>
          </div>
        </div>
      </aside>
    </div>
  </main>

<script>
  // If your API is NOT on the same domain, set this:
  // const API_BASE = "https://YOUR-PROJECT.vercel.app";
  const API_BASE = "";

  // -------------------------
  // Rates table (from your rates.html)
  // -------------------------
  const ROUTES = [
    {
      id: "MCO-Universal-Idrive-Seaworld-Convention",
      label: "MCO ‚Üî Universal / I-Drive / SeaWorld / Convention Center",
      type: "transfer",
      prices: {
        Sedan: { oneway: 110, round: 210 },
        SUV: { oneway: 120, round: 230 },
        Van8: { oneway: 140, round: 260 },
        Van14:{ oneway: 170, round: 310 },
      }
    },
    {
      id: "MCO-Disney-LBV-BayLake-GoldenOak",
      label: "MCO ‚Üî Disney / Lake Buena Vista / Bay Lake / Golden Oak",
      type: "transfer",
      prices: {
        Sedan: { oneway: 120, round: 220 },
        SUV: { oneway: 130, round: 240 },
        Van8: { oneway: 150, round: 280 },
        Van14:{ oneway: 180, round: 330 },
      }
    },
    {
      id: "MCO-Windermere-WinterPark",
      label: "MCO ‚Üî Windermere / Winter Park",
      type: "transfer",
      prices: {
        Sedan: { oneway: 130, round: 240 },
        SUV: { oneway: 140, round: 260 },
        Van8: { oneway: 160, round: 300 },
        Van14:{ oneway: 190, round: 340 },
      }
    },
    {
      id: "MCO-Port-Canaveral",
      label: "MCO / Orlando ‚Üî Port Canaveral",
      type: "transfer",
      prices: {
        Sedan: { oneway: 210, round: 400 },
        SUV: { oneway: 230, round: 440 },
        Van8: { oneway: 260, round: 500 },
        Van14:{ oneway: 290, round: 560 },
      }
    },
    {
      id: "SFB-Universal-Idrive-Seaworld-Convention",
      label: "SFB ‚Üî Universal / I-Drive / SeaWorld / Convention Center",
      type: "transfer",
      prices: {
        Sedan: { oneway: 160, round: 300 },
        SUV: { oneway: 175, round: 330 },
        Van8: { oneway: 200, round: 380 },
        Van14:{ oneway: 225, round: 420 },
      }
    },
    {
      id: "SFB-Disney-LBV-BayLake-GoldenOak",
      label: "SFB ‚Üî Disney / Lake Buena Vista / Bay Lake / Golden Oak",
      type: "transfer",
      prices: {
        Sedan: { oneway: 175, round: 330 },
        SUV: { oneway: 190, round: 360 },
        Van8: { oneway: 220, round: 420 },
        Van14:{ oneway: 245, round: 470 },
      }
    },
    {
      id: "Hourly-Orlando",
      label: "Hourly Charter (within Orlando)",
      type: "hourly",
      hourlyRates: {
        Sedan: 70,
        SUV: 85,
        Van8: 95,
        Van14: 120,
      }
    }
  ];

  const VEHICLES = [
    { key: "Sedan", label: "Sedan (up to 3)" },
    { key: "SUV", label: "SUV (up to 5)" },
    { key: "Van8", label: "8-passenger van (up to 8)" },
    { key: "Van14", label: "14-passenger van (up to 14)" },
  ];

  const routeSelect = document.getElementById("routeSelect");
  const vehicleSelect = document.getElementById("vehicleSelect");
  const tripTypeSelect = document.getElementById("tripTypeSelect");
  const priceDisplay = document.getElementById("priceDisplay");
  const priceLabel = document.getElementById("priceLabel");
  const priceBreakdown = document.getElementById("priceBreakdown");

  const hourlyRow = document.getElementById("hourlyRow");
  const hoursSel = document.getElementById("hours");
  const hourlyRateDisplay = document.getElementById("hourlyRateDisplay");

  const returnSection = document.getElementById("returnSection");

  const addStop = document.getElementById("addStop");
  const stopDetails = document.getElementById("stopDetails");
  const stopType = document.getElementById("stopType");
  const stopLocation = document.getElementById("stopLocation");

  const countryCode = document.getElementById("countryCode");
  const customCodeWrap = document.getElementById("customCodeWrap");
  const customCountryCode = document.getElementById("customCountryCode");

  // child seats qty selects
  const rearQty = document.getElementById("rearQty");
  const forwardQty = document.getElementById("forwardQty");
  const boosterQty = document.getElementById("boosterQty");

  function fillQty(sel) {
    for (let i = 0; i <= 6; i++) {
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = i === 0 ? "0 (none)" : String(i);
      sel.appendChild(opt);
    }
  }
  fillQty(rearQty); fillQty(forwardQty); fillQty(boosterQty);

  for (let h = 3; h <= 24; h++) {
    const opt = document.createElement("option");
    opt.value = String(h);
    opt.textContent = String(h);
    hoursSel.appendChild(opt);
  }

  function getRouteById(id){ return ROUTES.find(r => r.id === id) || null; }
  function getVehicleKey(){ return vehicleSelect.value; }
  function getTripType(){ return tripTypeSelect.value; }

  function stopFee() {
    if (!addStop.checked) return 0;
    return stopType.value === "wait" ? 20 : 5;
  }

  function baseFare() {
    const r = getRouteById(routeSelect.value);
    const v = getVehicleKey();
    const t = getTripType();

    if (!r || !v) return 0;

    if (r.type === "hourly") {
      const rate = Number(r.hourlyRates?.[v] || 0);
      const hrs = Number(hoursSel.value || 3);
      return rate * hrs;
    } else {
      const p = r.prices?.[v]?.[t] ?? 0;
      return Number(p) || 0;
    }
  }

  function totalFare() {
    return baseFare() + stopFee();
  }

  function syncUIForRoute() {
    const r = getRouteById(routeSelect.value);

    // trip options
    if (r?.type === "hourly") {
      tripTypeSelect.value = "hourly";
      tripTypeSelect.querySelector('option[value="hourly"]').disabled = false;
      tripTypeSelect.querySelector('option[value="oneway"]').disabled = true;
      tripTypeSelect.querySelector('option[value="round"]').disabled = true;
    } else {
      tripTypeSelect.querySelector('option[value="hourly"]').disabled = true;
      tripTypeSelect.querySelector('option[value="oneway"]').disabled = false;
      tripTypeSelect.querySelector('option[value="round"]').disabled = false;
      if (tripTypeSelect.value === "hourly") tripTypeSelect.value = "oneway";
    }

    // show/hide hourly row
    if (r?.type === "hourly") {
      hourlyRow.style.display = "grid";
      priceLabel.textContent = "Total (USD)";
    } else {
      hourlyRow.style.display = "none";
      priceLabel.textContent = "Total price (USD)";
    }

    // show/hide return section
    const t = getTripType();
    returnSection.style.display = (t === "round") ? "block" : "none";

    refreshPrice();
  }

  function refreshPrice() {
    const r = getRouteById(routeSelect.value);
    const v = getVehicleKey();
    const t = getTripType();

    // return section toggle
    returnSection.style.display = (t === "round") ? "block" : "none";

    // hourly display
    if (r?.type === "hourly") {
      const rate = Number(r.hourlyRates?.[v] || 0);
      hourlyRateDisplay.value = rate ? `$${rate.toFixed(2)} / hr` : "";
    }

    const base = baseFare();
    const sf = stopFee();
    const tot = totalFare();

    priceDisplay.value = tot ? `$${tot.toFixed(2)}` : "$0.00";

    const parts = [];
    if (base) parts.push(`Base: $${base.toFixed(2)}`);
    if (sf) parts.push(`Stop fee: $${sf.toFixed(2)}`);
    priceBreakdown.textContent = parts.length ? parts.join(" ‚Ä¢ ") : "";
  }

  // Populate dropdowns
  function initDropdowns() {
    routeSelect.innerHTML = ROUTES.map(r => `<option value="${r.id}">${r.label}</option>`).join("");
    vehicleSelect.innerHTML = VEHICLES.map(v => `<option value="${v.key}">${v.label}</option>`).join("");

    // Defaults
    routeSelect.value = ROUTES[0].id;
    vehicleSelect.value = "SUV";
    tripTypeSelect.value = "oneway";
  }
  initDropdowns();

  // Prefill from Rates page URL (optional)
  const params = new URLSearchParams(location.search);
  const routeParam = params.get("route");
  const vehicleParam = params.get("vehicle");
  const tripParam = params.get("trip");

  if (routeParam && getRouteById(routeParam)) routeSelect.value = routeParam;

  if (vehicleParam) {
    // rates page uses Sedan/SUV/Van8/Van14 already
    const allowed = new Set(VEHICLES.map(v => v.key));
    if (allowed.has(vehicleParam)) vehicleSelect.value = vehicleParam;
  }

  if (tripParam) {
    const normalized = tripParam.toLowerCase();
    if (normalized === "round" || normalized === "roundtrip") tripTypeSelect.value = "round";
    else if (normalized === "oneway" || normalized === "one-way") tripTypeSelect.value = "oneway";
    else if (normalized === "hourly") tripTypeSelect.value = "hourly";
  }

  // Events
  routeSelect.addEventListener("change", syncUIForRoute);
  vehicleSelect.addEventListener("change", refreshPrice);
  tripTypeSelect.addEventListener("change", refreshPrice);
  hoursSel.addEventListener("change", refreshPrice);

  addStop.addEventListener("change", () => {
    stopDetails.style.display = addStop.checked ? "block" : "none";
    refreshPrice();
  });
  stopType.addEventListener("change", refreshPrice);

  countryCode.addEventListener("change", () => {
    customCodeWrap.style.display = (countryCode.value === "OTHER") ? "block" : "none";
  });

  syncUIForRoute();
  refreshPrice();

  // Short notice logic
  function getPickupDateTimeLocal() {
    const d = document.getElementById("pickupDate").value;
    const t = document.getElementById("pickupTime").value;
    if (!d || !t) return null;
    const dt = new Date(d + "T" + t);
    return isNaN(dt.getTime()) ? null : dt;
  }
  function hoursUntil(dt) {
    const now = new Date();
    return (dt.getTime() - now.getTime()) / (1000 * 60 * 60);
  }
  const urgencyNote = document.getElementById("urgencyNote");
  function refreshUrgency() {
    const dt = getPickupDateTimeLocal();
    const within8 = dt ? hoursUntil(dt) <= 8 : false;
    if (dt && within8) {
      urgencyNote.style.display = "block";
      urgencyNote.innerHTML = `<span class="danger"><strong>Short notice:</strong> pickup is within 8 hours. Please contact us to confirm availability before paying.</span>`;
    } else {
      urgencyNote.style.display = "none";
      urgencyNote.innerHTML = "";
    }
  }
  document.getElementById("pickupDate").addEventListener("change", refreshUrgency);
  document.getElementById("pickupTime").addEventListener("change", refreshUrgency);
  refreshUrgency();

  // -------------------------
  // Steps
  // -------------------------
  const p1 = document.getElementById("p1");
  const p2 = document.getElementById("p2");
  const p3 = document.getElementById("p3");
  const s1 = document.getElementById("s1");
  const s2 = document.getElementById("s2");
  const s3 = document.getElementById("s3");
  const b2 = document.getElementById("b2");
  const b3 = document.getElementById("b3");

  function setStep(n){
    p1.classList.toggle("active", n===1);
    p2.classList.toggle("active", n===2);
    p3.classList.toggle("active", n===3);
    s1.classList.toggle("active", n===1);
    s2.classList.toggle("active", n===2);
    s3.classList.toggle("active", n===3);
    b2.style.opacity = n>=2 ? "1" : ".35";
    b3.style.opacity = n>=3 ? "1" : ".35";
  }

  function getVal(id){ return (document.getElementById(id).value || "").trim(); }

  function getFullPhone() {
    let code = countryCode.value;
    if (code === "OTHER") {
      code = (customCountryCode.value || "").trim();
      if (!code.startsWith("+")) code = "+" + code;
    }
    return `${code} ${(document.getElementById("phoneNumber").value || "").trim()}`.trim();
  }

  function validateStep1(){
    const required = ["passengerName","email","pickupDate","pickupTime","pickupLocation","destination"];
    for (const id of required) {
      const el = document.getElementById(id);
      if (!el.value.trim()) { el.focus(); return {ok:false, msg:"Please complete all required fields."}; }
    }

    // phone validate
    const num = (document.getElementById("phoneNumber").value || "").trim();
    if (!num) return {ok:false, msg:"Please enter your phone number."};
    if (countryCode.value === "OTHER") {
      const cc = (customCountryCode.value || "").trim();
      if (!cc) return {ok:false, msg:"Please enter your custom country code."};
    }

    // stop validate
    if (addStop.checked) {
      if (!stopLocation.value.trim()) return {ok:false, msg:"Please enter the stop location (or uncheck Add a stop)."};
    }

    // short notice
    const dt = getPickupDateTimeLocal();
    const within8 = dt ? hoursUntil(dt) <= 8 : false;
    if (within8) return {ok:false, msg:"Pickup is within 8 hours. Please contact us before payment."};

    // round trip return info (recommended, but we‚Äôll lightly require date/time + pickup)
    if (getTripType() === "round") {
      const rd = getVal("returnDate");
      const rt = getVal("returnTime");
      const rpl = getVal("returnPickupLocation");
      const rdest = getVal("returnDestination");
      if (!rd || !rt || !rpl || !rdest) {
        return {ok:false, msg:"Please fill return date/time + return pickup + return destination for round trip."};
      }
    }

    // hourly min
    const r = getRouteById(routeSelect.value);
    if (r?.type === "hourly") {
      const hrs = Number(hoursSel.value || 0);
      if (!Number.isFinite(hrs) || hrs < 3) return {ok:false, msg:"Hourly charter requires 3 hours minimum."};
    }

    // must have non-zero total
    if (totalFare() <= 0) return {ok:false, msg:"Please select route, vehicle, and trip type."};

    return {ok:true};
  }

  function buildBookingData(cid){
    const r = getRouteById(routeSelect.value);
    const vKey = getVehicleKey();
    const vLabel = (VEHICLES.find(v => v.key === vKey)?.label) || vKey;
    const t = getTripType();

    const base = baseFare();
    const sf = stopFee();
    const tot = totalFare();

    return {
      confirmation_id: cid,
      passenger_name: getVal("passengerName"),
      email: getVal("email"),
      phone: getFullPhone(),
      passengers: getVal("passengers"),

      pickup_date: getVal("pickupDate"),
      pickup_time: getVal("pickupTime"),
      pickup_location: getVal("pickupLocation"),
      destination: getVal("destination"),
      flight: getVal("flight"),
      luggage: getVal("luggage"),

      // child seats
      child_rear: Number(rearQty.value || 0),
      child_forward: Number(forwardQty.value || 0),
      child_booster: Number(boosterQty.value || 0),

      // trip
      route_id: r?.id || "",
      route_label: r?.label || "",
      vehicle_key: vKey,
      vehicle_label: vLabel,
      trip_type: t,

      // hourly
      hourly_hours: (r?.type === "hourly") ? Number(hoursSel.value || 3) : "",
      hourly_rate: (r?.type === "hourly") ? Number(r.hourlyRates?.[vKey] || 0) : "",

      // round trip return
      return_date: getVal("returnDate"),
      return_time: getVal("returnTime"),
      return_pickup_location: getVal("returnPickupLocation"),
      return_destination: getVal("returnDestination"),
      return_flight: getVal("returnFlight"),

      // stop
      add_stop: addStop.checked ? "yes" : "no",
      stop_type: addStop.checked ? stopType.value : "",
      stop_location: addStop.checked ? getVal("stopLocation") : "",
      stop_fee: sf.toFixed(2),

      // pricing
      base_fare: base.toFixed(2),
      total_usd: tot.toFixed(2),

      notes: getVal("notes"),
    };
  }

  function esc(s){
    return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function renderSummary(data){
    const lines = [
      ["Confirmation #", data.confirmation_id],
      ["Name", data.passenger_name],
      ["Email", data.email],
      ["Phone", data.phone],
      ["Passengers", data.passengers || "-"],
      ["Pickup", `${data.pickup_date} ${data.pickup_time}`],
      ["Route", data.route_label || data.route_id],
      ["Vehicle", data.vehicle_label],
      ["Trip", data.trip_type],
    ];

    if (data.trip_type === "hourly") {
      lines.push(["Hours", String(data.hourly_hours)]);
      lines.push(["Hourly rate", `$${Number(data.hourly_rate).toFixed(2)}`]);
    }

    // return
    if (data.trip_type === "round") {
      lines.push(["Return pickup", `${data.return_date} ${data.return_time}`]);
      lines.push(["Return pickup location", data.return_pickup_location]);
      lines.push(["Return destination", data.return_destination]);
      lines.push(["Return flight", data.return_flight || "-"]);
    }

    // stop
    if (data.add_stop === "yes") {
      lines.push(["Stop", data.stop_type === "wait" ? "Stop & wait (30 min)" : "Stop only"]);
      lines.push(["Stop location", data.stop_location]);
      lines.push(["Stop fee", `$${Number(data.stop_fee).toFixed(2)}`]);
    }

    // seats
    const seats = [];
    if (data.child_rear) seats.push(`Rear-facing x${data.child_rear}`);
    if (data.child_forward) seats.push(`Forward-facing x${data.child_forward}`);
    if (data.child_booster) seats.push(`Booster x${data.child_booster}`);
    lines.push(["Child seats", seats.length ? seats.join(", ") : "-"]);

    // details
    lines.push(["Pickup location", data.pickup_location]);
    lines.push(["Destination", data.destination]);
    lines.push(["Flight", data.flight || "-"]);
    lines.push(["Luggage", data.luggage || "-"]);
    lines.push(["Notes", data.notes || "-"]);

    // pricing
    lines.push(["Base fare", `$${Number(data.base_fare).toFixed(2)}`]);
    lines.push(["Total", `$${Number(data.total_usd).toFixed(2)}`]);

    document.getElementById("summary").innerHTML = lines.map(([k,v]) => `
      <div class="line"><div class="k">${esc(k)}</div><div class="v">${esc(v)}</div></div>
    `).join("");
  }

  document.getElementById("to2").addEventListener("click", () => {
    const v = validateStep1();
    if (!v.ok) return alert(v.msg);

    const cid = "MLT-" + Date.now() + "-" + Math.random().toString(16).slice(2,8).toUpperCase();
    const data = buildBookingData(cid);

    localStorage.setItem("mltBooking:" + cid, JSON.stringify(data));
    localStorage.setItem("mltLastCid", cid);

    renderSummary(data);
    setStep(2);
  });

  document.getElementById("back1").addEventListener("click", () => setStep(1));

  document.getElementById("to3").addEventListener("click", () => {
    const cid = localStorage.getItem("mltLastCid") || "";
    const saved = cid ? localStorage.getItem("mltBooking:" + cid) : null;
    const data = saved ? JSON.parse(saved) : null;
    if (!data) return alert("Missing saved booking data. Please go back and try again.");

    document.getElementById("payNote").innerHTML =
      `You will be redirected to Square for secure payment.<br>
       <span class="muted">Confirmation #: <strong>${esc(data.confirmation_id)}</strong></span><br>
       <span class="muted">Total: <strong>$${esc(data.total_usd)}</strong></span>`;

    setStep(3);
  });

  document.getElementById("back2").addEventListener("click", () => setStep(2));

  // Pay
  const payBtn = document.getElementById("payBtn");
  const paymentMsg = document.getElementById("paymentMsg");

  payBtn.addEventListener("click", async () => {
    paymentMsg.innerHTML = "";
    payBtn.disabled = true;
    payBtn.textContent = "Creating payment link...";

    try {
      const cid = localStorage.getItem("mltLastCid") || "";
      const saved = cid ? localStorage.getItem("mltBooking:" + cid) : null;
      const booking = saved ? JSON.parse(saved) : null;

      if (!booking) throw new Error("Missing booking data. Please go back and try again.");

      const amount = Number(booking.total_usd);
      if (!Number.isFinite(amount) || amount <= 0) throw new Error("Invalid amount.");

      const redirectUrl = `${location.origin}/confirm.html?cid=${encodeURIComponent(cid)}`;

      const name =
        `MLT Transportation - ${booking.route_label} - ${booking.vehicle_label} (${booking.trip_type})`;

      const note =
        `CID:${cid} | ${booking.passenger_name} | ${booking.pickup_date} ${booking.pickup_time} | ` +
        `${booking.pickup_location} -> ${booking.destination} | ${booking.phone} | ${booking.email}`;

      const r = await fetch((API_BASE || "") + "/api/create-square-link", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount,
          currency: "USD",
          name,
          note,
          redirectUrl,
          buyerEmail: booking.email,
        }),
      });

      const data = await r.json().catch(() => ({}));

      if (!data.ok) {
        paymentMsg.innerHTML =
          `<span class="danger"><strong>Error:</strong> ${esc(data.error || "Could not create payment link.")}</span>` +
          `<div class="booking-note"><pre style="white-space:pre-wrap">${esc(JSON.stringify(data.details || data, null, 2))}</pre></div>`;
        payBtn.disabled = false;
        payBtn.textContent = "Pay with Square";
        return;
      }

      paymentMsg.innerHTML = `<span class="ok"><strong>Success:</strong> Redirecting to Square‚Ä¶</span>`;
      window.location.href = data.url;
    } catch (e) {
      paymentMsg.innerHTML = `<span class="danger"><strong>Error:</strong> ${esc(e.message || "Failed. Please try again.")}</span>`;
      payBtn.disabled = false;
      payBtn.textContent = "Pay with Square";
    }
  });
</script>

</body>
</html>
