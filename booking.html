<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Booking | MLT Orlando Transportation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Book MLT Orlando Transportation. Step-by-step booking with secure Square payment and confirmation." />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { background: #f3f4f6; color: #020617; line-height: 1.55; }
    a { color: inherit; text-decoration: none; }
    header { background: #020617; color: #fff; padding: 16px; }
    .nav { max-width: 1100px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    .brand { font-weight: 800; letter-spacing: .5px; }
    .links { display: flex; gap: 14px; flex-wrap: wrap; font-size: 14px; opacity: .95; }
    .links a { padding: 6px 10px; border-radius: 10px; }
    .links a:hover { background: rgba(255,255,255,.08); }

    main { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 18px; }
    @media (min-width: 980px) { .grid { grid-template-columns: 1.2fr .8fr; } }

    .card { background: #fff; border-radius: 16px; box-shadow: 0 10px 30px rgba(2,6,23,.08); overflow: hidden; }
    .card .head { padding: 16px 16px 12px; border-bottom: 1px solid #e5e7eb; }
    .card .head h1, .card .head h2 { font-size: 18px; margin-bottom: 6px; }
    .card .head p { font-size: 13px; color: #475569; }

    .stepper { display: flex; gap: 10px; padding: 14px 16px; border-bottom: 1px solid #e5e7eb; background: #f8fafc; }
    .stepchip { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 999px; border: 1px solid #e2e8f0; background: #fff; font-size: 12px; color: #334155; }
    .dot { width: 22px; height: 22px; border-radius: 999px; display: inline-flex; align-items: center; justify-content: center; font-weight: 800; border: 1px solid #cbd5e1; }
    .active .dot { background: #0ea5e9; border-color: #0ea5e9; color: #fff; }
    .active { border-color: rgba(14,165,233,.35); }

    form { padding: 16px; }
    .section { margin-top: 16px; }
    .section:first-child { margin-top: 0; }
    .section-title { font-weight: 750; font-size: 14px; margin-bottom: 10px; color: #0f172a; }

    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 700px) { .row.two { grid-template-columns: 1fr 1fr; } }

    label { font-size: 12px; color: #334155; margin-bottom: 6px; display: block; }
    input, select, textarea {
      width: 100%;
      padding: 12px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #fff;
      font-size: 14px;
      outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: #93c5fd; box-shadow: 0 0 0 4px rgba(59,130,246,.12); }
    textarea { min-height: 100px; resize: vertical; }

    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 12px; border-radius: 999px; font-size: 12px;
      background: #f1f5f9; color: #0f172a;
    }
    .pill strong { font-weight: 800; }
    .muted { color: #64748b; font-size: 12px; }
    .danger { color: #b91c1c; }
    .ok { color: #166534; }

    .note {
      margin-top: 10px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      padding: 12px;
      border-radius: 14px;
      font-size: 12px;
      color: #334155;
    }

    .btnrow { display: grid; gap: 10px; margin-top: 14px; }
    @media (min-width: 700px) { .btnrow.two { grid-template-columns: 1fr 1fr; } }

    button {
      width: 100%;
      border: 0;
      border-radius: 999px;
      padding: 12px 14px;
      font-weight: 800;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-next { background: #0ea5e9; color: #fff; }
    .btn-next:hover { filter: brightness(.97); }
    .btn-back { background: #e2e8f0; color: #0f172a; }
    .btn-back:hover { filter: brightness(.98); }
    .btn-pay { background: #111827; color: #fff; }
    .btn-pay[disabled] { background: #9ca3af; cursor: not-allowed; }
    .btn-pay:hover { filter: brightness(.97); }

    .step { display: none; }
    .step.show { display: block; }

    .reviewBox { border: 1px solid #e2e8f0; background: #f8fafc; border-radius: 14px; padding: 12px; }
    .reviewGrid { display: grid; grid-template-columns: 1fr; gap: 8px; }
    @media (min-width: 700px) { .reviewGrid { grid-template-columns: 1fr 1fr; } }
    .reviewItem { font-size: 12px; color: #334155; }
    .reviewItem strong { color: #0f172a; }

    .side { padding: 16px; }
    .side h3 { font-size: 14px; margin-bottom: 10px; }
    .side .box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px; border-radius: 14px; margin-bottom: 12px; }
    .side .box p { font-size: 12px; color: #334155; margin: 6px 0; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }

    .status { margin-top: 10px; font-size: 12px; }
    .status a { text-decoration: underline; }
  </style>
</head>

<body>
<header>
  <div class="nav">
    <div class="brand">MLT ORLANDO TRANSPORTATION</div>
    <nav class="links">
      <a href="index.html">Home</a>
      <a href="services.html">Services</a>
      <a href="owner.html">Owner</a>
      <a href="private-airport.html">Private Airport</a>
      <a href="child-seats.html">Child Seats</a>
      <a href="service-areas.html">Service Areas</a>
      <a href="rates.html">Rates</a>
    </nav>
  </div>
</header>

<main>
  <div class="grid">
    <!-- MAIN -->
    <div class="card">
      <div class="head">
        <h1>Book your ride</h1>
        <p>Step-by-step booking. After payment, you and MLT will receive the confirmation email.</p>
      </div>

      <div class="stepper" id="stepper">
        <div class="stepchip active" data-stepchip="1"><span class="dot">1</span><span>Trip details</span></div>
        <div class="stepchip" data-stepchip="2"><span class="dot">2</span><span>Review &amp; pay</span></div>
        <div class="stepchip" data-stepchip="3"><span class="dot">3</span><span>Confirmation</span></div>
      </div>

      <form id="bookingForm" novalidate>
        <!-- Step 1 -->
        <div class="step show" id="step1">
          <div class="section">
            <div class="section-title">Passenger info</div>
            <div class="row two">
              <div>
                <label for="passengerName">Passenger name</label>
                <input id="passengerName" name="passenger_name" type="text" placeholder="Full name" required />
              </div>
              <div>
                <label for="email">Email (same as payment)</label>
                <input id="email" name="email" type="email" placeholder="name@example.com" required />
              </div>
            </div>
            <div class="row two" style="margin-top:10px;">
              <div>
                <label for="phone">Mobile / WhatsApp number</label>
                <input id="phone" name="phone" type="tel" placeholder="(407) 000-0000" required />
              </div>
              <div>
                <label for="passengers">Number of passengers</label>
                <input id="passengers" name="passengers" type="text" placeholder="e.g. 2 adults, 2 children" />
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Pickup date &amp; time</div>
            <div class="row two">
              <div>
                <label for="pickupDate">Pickup date</label>
                <input id="pickupDate" name="pickup_date" type="date" required />
              </div>
              <div>
                <label for="pickupTime">Pickup time (local)</label>
                <input id="pickupTime" name="pickup_time" type="time" required />
              </div>
            </div>
            <div class="note" id="urgencyNote" style="display:none;"></div>
          </div>

          <div class="section">
            <div class="section-title">Route &amp; vehicle (auto-filled)</div>

            <div class="row two">
              <div>
                <label for="routeDisplay">Route</label>
                <input id="routeDisplay" type="text" placeholder="Select from Rates page" readonly />
              </div>
              <div>
                <label for="vehicleDisplay">Vehicle</label>
                <input id="vehicleDisplay" type="text" placeholder="Select from Rates page" readonly />
              </div>
            </div>

            <div class="row two" style="margin-top:10px;">
              <div>
                <label for="tripTypeDisplay">Trip type</label>
                <input id="tripTypeDisplay" type="text" placeholder="oneway / roundtrip / charter" readonly />
              </div>
              <div>
                <label for="totalPrice">Total price (USD)</label>
                <input id="totalPrice" type="text" placeholder="Auto-filled from Rates page" readonly />
              </div>
            </div>

            <div class="note">
              <div class="pill">
                <strong>Tip:</strong>
                If route/vehicle/price are empty, go to <a href="rates.html" style="text-decoration: underline;">Rates</a> and pick a route to auto-fill this page.
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">Locations &amp; trip details</div>
            <div class="row">
              <div>
                <label for="pickupLocation">Pickup location (airport, hotel, or address)</label>
                <input id="pickupLocation" name="pickup_location" type="text" placeholder="Example: MCO, Hyatt Regency Orlando, 123 Main St..." required />
              </div>
            </div>

            <div class="row two" style="margin-top:10px;">
              <div>
                <label for="flight">Airline &amp; flight number (if flying)</label>
                <input id="flight" name="flight" type="text" placeholder="Example: Delta 1234" />
              </div>
              <div>
                <label for="destination">Destination address / hotel</label>
                <input id="destination" name="destination" type="text" placeholder="Hotel name or full address" required />
              </div>
            </div>

            <div class="row two" style="margin-top:10px;">
              <div>
                <label for="luggage">Luggage details</label>
                <input id="luggage" name="luggage" type="text" placeholder="e.g. 3 large suitcases, 2 carry-ons, 1 stroller" />
              </div>
              <div>
                <label for="childSeats">Child seats</label>
                <input id="childSeats" name="child_seats" type="text" placeholder="e.g. 1 rear-facing, 1 booster" />
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <div>
                <label for="notes">Additional notes</label>
                <textarea id="notes" name="notes" placeholder="Child ages, gate info, private jet tail number, special requests..."></textarea>
              </div>
            </div>
          </div>

          <div class="btnrow">
            <button class="btn-next" id="toStep2Btn" type="button">Continue to review</button>
          </div>

          <div class="status" id="step1Status"></div>

          <div class="note">
            <p><strong>Short notice:</strong> If your pickup is within 8 hours, payment is disabled and we will confirm availability first.</p>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="step" id="step2">
          <div class="section">
            <div class="section-title">Review your booking</div>
            <div class="reviewBox">
              <div class="reviewGrid" id="reviewGrid"></div>
            </div>
          </div>

          <div class="btnrow two">
            <button class="btn-back" id="backToStep1Btn" type="button">Back</button>
            <button class="btn-pay" id="payBtn" type="button" disabled>Pay with Square</button>
          </div>

          <div class="status" id="paymentMsg"></div>

          <div class="note">
            After payment completes, Square will redirect you to our confirmation page. Then we verify the payment and email:
            <ul style="margin-top:8px; padding-left: 18px;">
              <li>You (customer) a booking confirmation</li>
              <li>MLT the full reservation details</li>
            </ul>
          </div>
        </div>

        <!-- Step 3 (visual only; actual confirmation happens on confirmation.html) -->
        <div class="step" id="step3">
          <div class="section">
            <div class="section-title">Confirmation</div>
            <p class="muted">You’ll see confirmation after payment on the confirmation page.</p>
          </div>
        </div>
      </form>
    </div>

    <!-- SIDE -->
    <aside class="card">
      <div class="head">
        <h2>Need help?</h2>
        <p>Contact us any time.</p>
      </div>
      <div class="side">
        <div class="box">
          <h3>Contact</h3>
          <p><strong>Phone:</strong> <a href="tel:14073690643" style="text-decoration: underline;">407-369-0643</a></p>
          <p><strong>Email:</strong> <a href="mailto:mltorlando@yahoo.com" style="text-decoration: underline;">mltorlando@yahoo.com</a></p>
        </div>

        <div class="box">
          <h3>How payment works</h3>
          <p>We create a Square-hosted checkout and redirect you for secure payment.</p>
          <p class="muted">If you don’t see route/vehicle/price, start from the <strong>Rates</strong> page first.</p>
        </div>

        <div class="box">
          <h3>Debug (optional)</h3>
          <p class="muted">DevTools → Console/Network</p>
          <p class="muted">API endpoint used: <span class="kbd">/api/create-square-link</span></p>
        </div>
      </div>
    </aside>
  </div>
</main>

<script>
  // -------------------------
  // URL prefills from rates page
  // route=...&vehicle=...&trip=...&price=110
  // -------------------------
  function qs(name) { return new URLSearchParams(window.location.search).get(name); }
  function setText(id, val) { const el = document.getElementById(id); if (el) el.value = val ?? ""; }
  function isFinitePositiveNumber(x) { const n = Number(x); return Number.isFinite(n) && n > 0; }

  const route = qs("route") || qs("Route") || "";
  const vehicle = qs("vehicle") || qs("Vehicle") || "";
  const trip = qs("trip") || qs("Trip") || qs("trip_type") || "";
  const priceRaw = qs("price") || qs("Price") || "";

  setText("routeDisplay", route);
  setText("vehicleDisplay", vehicle);
  setText("tripTypeDisplay", trip);
  setText("totalPrice", priceRaw ? `$${Number(priceRaw).toFixed(2)}` : "");

  // -------------------------
  // Step handling
  // -------------------------
  const form = document.getElementById("bookingForm");
  const step1 = document.getElementById("step1");
  const step2 = document.getElementById("step2");
  const step3 = document.getElementById("step3");
  const stepper = document.getElementById("stepper");

  function showStep(n) {
    step1.classList.toggle("show", n === 1);
    step2.classList.toggle("show", n === 2);
    step3.classList.toggle("show", n === 3);
    [...stepper.querySelectorAll(".stepchip")].forEach(chip => {
      chip.classList.toggle("active", chip.getAttribute("data-stepchip") === String(n));
    });
  }

  // -------------------------
  // Timing rules (8 hours)
  // -------------------------
  const payBtn = document.getElementById("payBtn");
  const paymentMsg = document.getElementById("paymentMsg");
  const urgencyNote = document.getElementById("urgencyNote");

  function getPickupDateTimeLocal() {
    const d = document.getElementById("pickupDate")?.value;
    const t = document.getElementById("pickupTime")?.value;
    if (!d || !t) return null;
    const dt = new Date(d + "T" + t);
    return isNaN(dt.getTime()) ? null : dt;
  }
  function hoursUntil(dt) {
    const now = new Date();
    return (dt.getTime() - now.getTime()) / (1000 * 60 * 60);
  }

  function refreshPayState() {
    const dt = getPickupDateTimeLocal();
    const within8 = dt ? hoursUntil(dt) <= 8 : false;

    if (dt && within8) {
      urgencyNote.style.display = "block";
      urgencyNote.innerHTML = `<span class="danger"><strong>Short notice:</strong> Your pickup is within 8 hours. Please call/text us to confirm availability before payment.</span>`;
    } else {
      urgencyNote.style.display = "none";
      urgencyNote.innerHTML = "";
    }

    const canPayByPrice = isFinitePositiveNumber(priceRaw);
    payBtn.disabled = !canPayByPrice || within8;
  }

  refreshPayState();
  document.getElementById("pickupDate")?.addEventListener("change", refreshPayState);
  document.getElementById("pickupTime")?.addEventListener("change", refreshPayState);

  // -------------------------
  // Build booking payload + localStorage
  // -------------------------
  function newBookingId() {
    // Prefer crypto.randomUUID
    if (window.crypto?.randomUUID) return window.crypto.randomUUID();
    return "mlt_" + Math.random().toString(16).slice(2) + "_" + Date.now();
  }

  function getBookingPayload(bookingId) {
    const payload = {
      bookingId,
      route, vehicle, trip,
      amount: Number(priceRaw),
      currency: "USD",
      passengerName: document.getElementById("passengerName")?.value?.trim() || "",
      email: document.getElementById("email")?.value?.trim() || "",
      phone: document.getElementById("phone")?.value?.trim() || "",
      passengers: document.getElementById("passengers")?.value?.trim() || "",
      pickupDate: document.getElementById("pickupDate")?.value || "",
      pickupTime: document.getElementById("pickupTime")?.value || "",
      pickupLocation: document.getElementById("pickupLocation")?.value?.trim() || "",
      destination: document.getElementById("destination")?.value?.trim() || "",
      flight: document.getElementById("flight")?.value?.trim() || "",
      luggage: document.getElementById("luggage")?.value?.trim() || "",
      childSeats: document.getElementById("childSeats")?.value?.trim() || "",
      notes: document.getElementById("notes")?.value?.trim() || "",
      createdAtISO: new Date().toISOString()
    };
    return payload;
  }

  function saveDraft(payload) {
    localStorage.setItem("mlt_booking_" + payload.bookingId, JSON.stringify(payload));
  }

  // -------------------------
  // Review UI
  // -------------------------
  function renderReview(payload) {
    const grid = document.getElementById("reviewGrid");
    const items = [
      ["Passenger", payload.passengerName],
      ["Email", payload.email],
      ["Phone", payload.phone],
      ["Passengers", payload.passengers || "-"],
      ["Pickup", `${payload.pickupDate} ${payload.pickupTime}`],
      ["Pickup location", payload.pickupLocation],
      ["Destination", payload.destination],
      ["Flight", payload.flight || "-"],
      ["Route", payload.route || "-"],
      ["Vehicle", payload.vehicle || "-"],
      ["Trip type", payload.trip || "-"],
      ["Total", Number.isFinite(payload.amount) ? `$${payload.amount.toFixed(2)}` : "-"],
    ];

    grid.innerHTML = items.map(([k,v]) =>
      `<div class="reviewItem"><strong>${k}:</strong> ${String(v || "-").replaceAll("<","&lt;")}</div>`
    ).join("");
  }

  // -------------------------
  // Buttons
  // -------------------------
  let currentBookingId = null;

  document.getElementById("toStep2Btn").addEventListener("click", () => {
    paymentMsg.innerHTML = "";

    // Validate form fields in step 1
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    // Require rates selection
    if (!isFinitePositiveNumber(priceRaw) || !route || !vehicle) {
      document.getElementById("step1Status").innerHTML =
        `<span class="danger">Please select your route/vehicle from the Rates page so price is filled before paying.</span>`;
      return;
    }

    currentBookingId = currentBookingId || newBookingId();
    const payload = getBookingPayload(currentBookingId);
    saveDraft(payload);
    renderReview(payload);

    refreshPayState();
    showStep(2);
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  document.getElementById("backToStep1Btn").addEventListener("click", () => {
    showStep(1);
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // -------------------------
  // Pay: create Square link, set redirect_url to confirmation.html?bookingId=...
  // -------------------------
  payBtn.addEventListener("click", async () => {
    paymentMsg.innerHTML = "";
    payBtn.disabled = true;
    payBtn.textContent = "Creating payment link...";

    try {
      if (!currentBookingId) currentBookingId = newBookingId();
      const payload = getBookingPayload(currentBookingId);
      saveDraft(payload);

      // Final checks
      if (!Number.isFinite(payload.amount) || payload.amount <= 0) {
        paymentMsg.innerHTML = `<span class="danger">Missing price. Please select your route again from the Rates page.</span>`;
        payBtn.textContent = "Pay with Square";
        refreshPayState();
        return;
      }

      const r = await fetch("/api/create-square-link", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await r.json();
      if (!r.ok || !data.ok) {
        console.log("Create link error:", data);
        paymentMsg.innerHTML = `<span class="danger">Could not create payment link. Please try again or contact us.</span>`;
        payBtn.textContent = "Pay with Square";
        refreshPayState();
        return;
      }

      paymentMsg.innerHTML = `<span class="ok"><strong>Success:</strong> Redirecting to secure payment...</span>`;
      window.location.href = data.url;

    } catch (e) {
      console.error(e);
      paymentMsg.innerHTML = `<span class="danger">Failed to create payment link. Please try again.</span>`;
      payBtn.textContent = "Pay with Square";
      refreshPayState();
    }
  });
</script>

</body>
</html>
