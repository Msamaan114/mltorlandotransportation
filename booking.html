<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Booking Details &amp; Contact | MLT Orlando Transportation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="Share your trip details with MLT Orlando Transportation so we can confirm your booking and send the correct Square payment link for your route."
  />
  <meta property="og:title" content="Booking Details &amp; Contact | MLT Orlando Transportation" />
  <meta
    property="og:description"
    content="Book private transportation in Orlando, Windermere, Lake Buena Vista, Golden Oak, Winter Park, I-Drive, SeaWorld and Port Canaveral."
  />
  <meta property="og:image" content="https://www.mltorlandotransportation.com/suv-front-main.jpeg" />
  <meta property="og:url" content="https://www.mltorlandotransportation.com/booking.html" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />

  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- Top contact bar -->
  <div class="top-bar">
    <div class="top-bar-inner">
      <span>Private Orlando transportation from MCO &amp; SFB to Disney, Universal &amp; Cape Canaveral.</span>

      <div class="top-bar-right">
        <span>
          Call: <a href="tel:14073690643">407-369-0643</a> ¬∑
          Email: <a href="mailto:mltorlando@yahoo.com">mltorlando@yahoo.com</a>
        </span>

        <div class="social-top">
          <a href="https://facebook.com/" target="_blank" rel="noopener">
            <img src="facebook-icon.jpeg" alt="Facebook" />
          </a>
          <a href="https://wa.me/14073690643" target="_blank" rel="noopener">
            <img src="whatsapp-icon.jpeg" alt="WhatsApp" />
          </a>
          <a href="https://www.instagram.com/mltorlando?igsh=ODV0Y2pocXJ0bjk4" target="_blank" rel="noopener">
            <img src="instagram-icon.jpeg" alt="Instagram" />
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Header / nav -->
  <header>
    <div class="nav">
      <a href="index.html" class="logo" style="text-decoration:none;">MLT Orlando Transportation</a>
      <nav>
        <a href="index.html">Home</a>
        <a href="services.html">Services</a>
        <a href="owner.html">Owner</a>
        <a href="private-airport.html">Private Airport</a>
        <a href="child-seats.html">Child Seats</a>
        <a href="service-areas.html">Service Areas</a>
        <a href="rates.html">Rates</a>
        <a href="cancellation.html">Cancellation</a>
        <a href="why-us.html">Why Us</a>
        <a href="booking.html">Booking</a>
      </nav>
    </div>
  </header>

  <main>
    <section id="contact">
      <a
        href="rates.html"
        class="btn-primary"
        style="text-decoration:none; display:inline-block; margin-bottom:1.5rem;"
      >
        ‚Üê Back to Rates &amp; Booking
      </a>

      <h2>Booking Details &amp; Contact</h2>
      <p class="section-intro">
        For trips <strong>within 8 hours</strong>, this form sends us a <strong>request</strong> and we must confirm
        availability before you pay. <br />
        For trips <strong>more than 8 hours away</strong>, you can submit this form and then pay securely with Square.
      </p>

      <div class="contact-wrapper">
        <!-- LEFT -->
        <div>
          <form
            id="booking-form"
            action="https://formspree.io/f/xovgzajo"
            method="POST"
          >
            <!-- Hidden field to send selected route / vehicle / price / timing info -->
            <input
              type="hidden"
              id="selected-option"
              name="Selected route / vehicle / price / timing"
              value=""
            />

            <!-- Optional: for Formspree readability -->
            <input type="hidden" id="child-seats-summary" name="Child seats summary" value="" />

            <label for="name">Passenger name</label>
            <input id="name" name="Passenger name" type="text" placeholder="Full name" required />

            <label for="email">Email (same as payment)</label>
            <input id="email" name="Email" type="email" placeholder="you@example.com" required />

            <label for="phone">Mobile / WhatsApp number</label>
            <input id="phone" name="Phone" type="tel" placeholder="+1 407-369-0643" required />

            <label for="pickup-date">Pickup date</label>
            <input id="pickup-date" name="Pickup date" type="date" required />

            <label for="pickup-time">Pickup time (local)</label>
            <input id="pickup-time" name="Pickup time" type="time" required />

            <p id="timing-banner" class="hero-note" style="margin-top:0.75rem;">
              Once you select your pickup date and time, we‚Äôll tell you if this is a short-notice request (&lt; 8 hours) or a standard booking (‚â• 8 hours).
            </p>

            <!-- ROUTE / VEHICLE / TRIP TYPE SELECTION (AFTER TIME) -->
            <div id="route-vehicle-card" class="card" style="margin:1.25rem 0; display:none;">
              <h3>Select Your Route &amp; Vehicle</h3>

              <label for="route">Route / Area</label>
              <select id="route">
                <option value="">Select a route</option>
                <option value="MCO_UNIVERSAL">MCO ‚Üî Universal / I-Drive / SeaWorld / Convention Center</option>
                <option value="MCO_DISNEY">MCO ‚Üî Disney / Lake Buena Vista / Bay Lake / Golden Oak</option>
                <option value="MCO_WINDERMERE">MCO ‚Üî Windermere / Winter Park</option>
                <option value="MCO_PORT">MCO / Orlando ‚Üî Port Canaveral</option>
                <option value="SFB_IDRIVE">SFB ‚Üî I-Drive / Convention Center / Universal / SeaWorld</option>
                <option value="SFB_DISNEY">SFB ‚Üî Disney / Lake Buena Vista / Bay Lake / Golden Oak</option>
                <option value="HOURLY">Hourly Charter (within Orlando)</option>
                <option value="CUSTOM">Other / custom route (we will confirm price by email)</option>
              </select>

              <label for="vehicle">Vehicle type</label>
              <select id="vehicle">
                <option value="">Select a vehicle</option>
                <option value="SEDAN">Sedan (up to 3) ¬∑ üß≥ 2 large ¬∑ 1 carry-on</option>
                <option value="SUV">SUV (up to 5) ¬∑ üß≥ 5 large ¬∑ 3 carry-on</option>
                <option value="VAN8">8-passenger van ¬∑ üß≥ 10 large ¬∑ 5 carry-on</option>
                <option value="VAN14">14-passenger van ¬∑ üß≥ 14 large ¬∑ 7 carry-on</option>
              </select>

              <label for="trip-type">Trip type</label>
              <select id="trip-type">
                <option value="">Select trip type</option>
                <option value="ONEWAY">One-way</option>
                <option value="ROUND">Round trip</option>
                <option value="HOURLY">Hourly (3-hour minimum)</option>
              </select>

              <!-- Charter hours dropdown (3 to 24) -->
              <div id="charter-hours-wrap" style="display:none; margin-top:0.75rem;">
                <label for="charter-hours">Charter hours</label>
                <select id="charter-hours" name="Charter hours"></select>
                <p class="hero-note" style="margin-top:0.5rem;">
                  Hourly charters have a 3-hour minimum. Select your total hours (3‚Äì24).
                </p>
              </div>

              <div class="card" style="margin-top:1rem; background:#f9fafb;">
                <p id="price-text" class="hero-note" style="margin-bottom:0;">
                  Select your route, vehicle and trip type to see the price and payment instructions.
                </p>
              </div>
            </div>

            <label for="pickup-location">Pickup location (airport, hotel, or address)</label>
            <input
              id="pickup-location"
              name="Pickup location"
              type="text"
              placeholder="Example: MCO (Orlando Intl), Hyatt Regency Orlando, 123 Main St, Orlando FL"
              required
            />

            <label for="flight">Airline &amp; flight number (if flying)</label>
            <input
              id="flight"
              name="Airline &amp; flight number"
              type="text"
              placeholder="Example: Delta 1234"
            />

            <label for="destination">Destination address / hotel</label>
            <input
              id="destination"
              name="Destination"
              type="text"
              placeholder="Hotel name or full address"
              required
            />

            <label for="passengers">Number of passengers</label>
            <input
              id="passengers"
              name="Passengers"
              type="number"
              min="1"
              max="14"
              placeholder="2 adults, 2 children"
              required
            />

            <label for="luggage">Luggage details</label>
            <input
              id="luggage"
              name="Luggage"
              type="text"
              placeholder="e.g. 3 large suitcases, 2 carry-ons, 1 stroller"
            />

            <!-- CHILD SEATS REPEATER -->
            <label>Child seats (add what you need)</label>

            <div id="seat-rows">
              <div class="seat-row" style="display:grid; grid-template-columns:1fr 90px 40px; gap:0.5rem; align-items:center;">
                <select class="seat-type" name="Child seat type[]" aria-label="Seat type">
                  <option value="">Select seat type</option>
                  <option value="Rear-facing infant seat">Rear-facing infant seat</option>
                  <option value="Forward-facing car seat">Forward-facing car seat</option>
                  <option value="Booster seat">Booster seat</option>
                </select>

                <select class="seat-qty" name="Child seat quantity[]" aria-label="Quantity">
                  <option value="">#</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                </select>

                <button type="button" class="seat-remove btn-secondary" aria-label="Remove seat selection" style="display:none; padding:0.4rem 0.6rem;">
                  √ó
                </button>
              </div>
            </div>

            <button type="button" id="add-seat-row" class="btn-secondary" style="margin-top:0.6rem;">
              + Add another seat type
            </button>

            <p class="hero-note" style="margin-top:0.6rem;">
              Example: add ‚ÄúRear-facing infant seat = 1‚Äù, then press + to add ‚ÄúBooster seat = 2‚Äù.
            </p>

            <!-- RETURN DETAILS (only when ROUND) -->
            <div id="return-details-card" class="card" style="margin-top:1.25rem; display:none;">
              <h3 style="margin-top:0;">Return trip details</h3>
              <p class="hero-note" style="margin-top:-0.25rem;">
                Fill this out only if you selected <strong>Round trip</strong>.
              </p>

              <label for="return-from">Return pickup (from where?)</label>
              <input id="return-from" name="Return pickup location" type="text" placeholder="e.g. Hotel / address" />

              <label for="return-to">Return destination (to where?)</label>
              <input id="return-to" name="Return destination" type="text" placeholder="e.g. MCO / SFB / address" />

              <label for="return-date">Return date</label>
              <input id="return-date" name="Return date" type="date" />

              <label for="return-time">Return pickup time (local)</label>
              <input id="return-time" name="Return pickup time" type="time" />

              <label for="return-notes">Return trip comments</label>
              <textarea
                id="return-notes"
                name="Return trip comments"
                placeholder="Anything we should know for the return (airline/flight, meeting point, special requests...)"
              ></textarea>
            </div>

            <label for="notes">Additional notes</label>
            <textarea
              id="notes"
              name="Notes"
              placeholder="Child ages and approximate weights, flight info, gate meeting instructions, gate code, private jet tail number, special requests..."
            ></textarea>

            <!-- TWO SEPARATE BUTTONS -->
            <button id="submit-btn" type="submit" class="btn-primary">Submit booking request</button>

            <button
              id="pay-btn"
              type="button"
              class="btn-secondary"
              disabled
              style="margin-top:0.6rem; width:100%;"
            >
              Pay with Square
            </button>

            <div id="form-status" class="hero-note" style="margin-top:0.75rem; display:none;"></div>
            <div id="pay-status" class="hero-note" style="margin-top:0.5rem; display:none;"></div>

            <p class="hero-note" style="margin-top:0.75rem;">
              If your trip is <strong>within 8 hours</strong>, this will be treated as a
              <strong>short-notice request</strong> and we will confirm availability before you pay. <br />
              If your trip is <strong>more than 8 hours away</strong>, after you submit, you can complete payment with the <strong>Pay with Square</strong> button.
            </p>
          </form>
        </div>

        <!-- RIGHT -->
        <div class="contact-details">
          <p class="contact-label">Need help before booking?</p>
          <p>Phone: <a href="tel:14073690643"><strong>407-369-0643</strong></a></p>
          <p>Email: <a href="mailto:mltorlando@yahoo.com"><strong>mltorlando@yahoo.com</strong></a></p>
          <p>
            WhatsApp:
            <a href="https://wa.me/14073690643" target="_blank" rel="noopener">
              <strong>Message on WhatsApp</strong>
            </a>
          </p>

          <p class="contact-label" style="margin-top:1rem;">Typical hours</p>
          <p>Transportation: 24/7 by reservation</p>
          <p>Messages &amp; quotes: Every day, 8:00 ‚Äì 20:00 (local time)</p>

          <p class="contact-label" style="margin-top:1rem;">Base location</p>
          <p>
            MLT Orlando Transportation<br />
            Orlando, FL<br />
            United States
          </p>

          <p class="hero-note" style="margin-top:1rem;">
            If your exact route isn‚Äôt listed in the dropdown, choose
            <strong>Other / custom route</strong> and describe your trip in the notes section. We‚Äôll confirm the
            price and send the correct Square payment link.
          </p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="social-links">
      <a href="https://facebook.com/" target="_blank" rel="noopener">
        <img src="facebook-icon.jpeg" alt="Facebook" />
      </a>
      <a href="https://wa.me/14073690643" target="_blank" rel="noopener">
        <img src="whatsapp-icon.jpeg" alt="WhatsApp" />
      </a>
      <a href="https://www.instagram.com/mltorlando?igsh=ODV0Y2pocXJ0bjk4" target="_blank" rel="noopener">
        <img src="instagram-icon.jpeg" alt="Instagram" />
      </a>
    </div>

    ¬© <span id="year"></span> MLT Orlando Transportation. All rights reserved.
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    // --- Prices only (Square links are generated by /api/create-square-link) ---
    const OPTIONS = {
      MCO_UNIVERSAL: {
        SEDAN: { ONEWAY: { price: 110 }, ROUND: { price: 210 } },
        SUV:   { ONEWAY: { price: 120 }, ROUND: { price: 230 } },
        VAN8:  { ONEWAY: { price: 140 }, ROUND: { price: 260 } },
        VAN14: { ONEWAY: { price: 170 }, ROUND: { price: 310 } },
      },
      MCO_DISNEY: {
        SEDAN: { ONEWAY: { price: 120 }, ROUND: { price: 220 } },
        SUV:   { ONEWAY: { price: 130 }, ROUND: { price: 240 } },
        VAN8:  { ONEWAY: { price: 150 }, ROUND: { price: 280 } },
        VAN14: { ONEWAY: { price: 180 }, ROUND: { price: 330 } },
      },
      MCO_WINDERMERE: {
        SEDAN: { ONEWAY: { price: 130 }, ROUND: { price: 240 } },
        SUV:   { ONEWAY: { price: 140 }, ROUND: { price: 260 } },
        VAN8:  { ONEWAY: { price: 160 }, ROUND: { price: 300 } },
        VAN14: { ONEWAY: { price: 190 }, ROUND: { price: 340 } },
      },
      MCO_PORT: {
        SEDAN: { ONEWAY: { price: 210 }, ROUND: { price: 400 } },
        SUV:   { ONEWAY: { price: 230 }, ROUND: { price: 440 } },
        VAN8:  { ONEWAY: { price: 260 }, ROUND: { price: 500 } },
        VAN14: { ONEWAY: { price: 290 }, ROUND: { price: 560 } },
      },
      SFB_IDRIVE: {
        SEDAN: { ONEWAY: { price: 160 }, ROUND: { price: 300 } },
        SUV:   { ONEWAY: { price: 175 }, ROUND: { price: 330 } },
        VAN8:  { ONEWAY: { price: 200 }, ROUND: { price: 380 } },
        VAN14: { ONEWAY: { price: 225 }, ROUND: { price: 420 } },
      },
      SFB_DISNEY: {
        SEDAN: { ONEWAY: { price: 175 }, ROUND: { price: 330 } },
        SUV:   { ONEWAY: { price: 190 }, ROUND: { price: 360 } },
        VAN8:  { ONEWAY: { price: 220 }, ROUND: { price: 420 } },
        VAN14: { ONEWAY: { price: 245 }, ROUND: { price: 470 } },
      },
      HOURLY: {
        SEDAN: { HOURLY: { price: 70 } },
        SUV:   { HOURLY: { price: 85 } },
        VAN8:  { HOURLY: { price: 95 } },
        VAN14: { HOURLY: { price: 120 } },
      },
    };

    const routeSelect = document.getElementById("route");
    const vehicleSelect = document.getElementById("vehicle");
    const tripTypeSelect = document.getElementById("trip-type");
    const pickupDateInput = document.getElementById("pickup-date");
    const pickupTimeInput = document.getElementById("pickup-time");
    const priceText = document.getElementById("price-text");
    const timingBanner = document.getElementById("timing-banner");
    const selectedOptionInput = document.getElementById("selected-option");
    const bookingForm = document.getElementById("booking-form");
    const routeVehicleCard = document.getElementById("route-vehicle-card");
    const submitBtn = document.getElementById("submit-btn");
    const formStatus = document.getElementById("form-status");

    const payBtn = document.getElementById("pay-btn");
    const payStatus = document.getElementById("pay-status");

    const charterWrap = document.getElementById("charter-hours-wrap");
    const charterHoursSelect = document.getElementById("charter-hours");

    const returnCard = document.getElementById("return-details-card");
    const returnFrom = document.getElementById("return-from");
    const returnTo = document.getElementById("return-to");
    const returnDate = document.getElementById("return-date");
    const returnTime = document.getElementById("return-time");

    // Current pay state
    let currentAmountCents = 0;
    let currentCanPayNow = false;

    // Build charter-hours options: 3 to 24
    (function buildHoursOptions() {
      if (!charterHoursSelect) return;
      charterHoursSelect.innerHTML = "";
      for (let h = 3; h <= 24; h++) {
        const opt = document.createElement("option");
        opt.value = String(h);
        opt.textContent = `${h} hours`;
        charterHoursSelect.appendChild(opt);
      }
      charterHoursSelect.value = "3";
    })();

    function syncReturnTripUI() {
      const isRound = (tripTypeSelect?.value === "ROUND");
      if (returnCard) returnCard.style.display = isRound ? "block" : "none";

      if (returnFrom) returnFrom.required = isRound;
      if (returnTo) returnTo.required = isRound;
      if (returnDate) returnDate.required = isRound;
      if (returnTime) returnTime.required = isRound;

      if (!isRound) {
        if (returnFrom) returnFrom.value = "";
        if (returnTo) returnTo.value = "";
        if (returnDate) returnDate.value = "";
        if (returnTime) returnTime.value = "";
        const rn = document.getElementById("return-notes");
        if (rn) rn.value = "";
      }
    }

    function syncTripTypeOptions() {
      const route = routeSelect.value;
      const hourlyOption = tripTypeSelect.querySelector('option[value="HOURLY"]');
      const onewayOption = tripTypeSelect.querySelector('option[value="ONEWAY"]');
      const roundOption  = tripTypeSelect.querySelector('option[value="ROUND"]');

      if (route === "HOURLY") {
        if (hourlyOption) hourlyOption.disabled = false;
        if (onewayOption) onewayOption.disabled = true;
        if (roundOption)  roundOption.disabled = true;
        if (tripTypeSelect.value !== "HOURLY") tripTypeSelect.value = "HOURLY";
      } else {
        if (hourlyOption) hourlyOption.disabled = true;
        if (onewayOption) onewayOption.disabled = false;
        if (roundOption)  roundOption.disabled = false;
        if (tripTypeSelect.value === "HOURLY") tripTypeSelect.value = "";
      }
    }

    function syncHourlyHoursUI() {
      const isHourly = (routeSelect.value === "HOURLY" && tripTypeSelect.value === "HOURLY");
      if (charterWrap) charterWrap.style.display = isHourly ? "block" : "none";
      if (charterHoursSelect) charterHoursSelect.required = isHourly;

      if (!isHourly && charterHoursSelect) charterHoursSelect.value = "3";
    }

    // --- Child seats repeater ---
    const seatRows = document.getElementById("seat-rows");
    const addSeatRowBtn = document.getElementById("add-seat-row");
    const childSeatsSummary = document.getElementById("child-seats-summary");

    function updateSeatsSummary() {
      if (!seatRows || !childSeatsSummary) return;
      const rows = seatRows.querySelectorAll(".seat-row");
      const parts = [];
      rows.forEach((row) => {
        const type = row.querySelector(".seat-type")?.value || "";
        const qty = row.querySelector(".seat-qty")?.value || "";
        if (type && qty) parts.push(`${qty} √ó ${type}`);
      });
      childSeatsSummary.value = parts.length ? parts.join("; ") : "None selected";
    }

    function toggleSeatRemoveButtons() {
      if (!seatRows) return;
      const rows = seatRows.querySelectorAll(".seat-row");
      rows.forEach((row) => {
        const btn = row.querySelector(".seat-remove");
        if (btn) btn.style.display = rows.length > 1 ? "inline-block" : "none";
      });
    }

    function makeSeatRow() {
      const row = document.createElement("div");
      row.className = "seat-row";
      row.style.display = "grid";
      row.style.gridTemplateColumns = "1fr 90px 40px";
      row.style.gap = "0.5rem";
      row.style.alignItems = "center";
      row.style.marginTop = "0.5rem";

      row.innerHTML = `
        <select class="seat-type" name="Child seat type[]" aria-label="Seat type">
          <option value="">Select seat type</option>
          <option value="Rear-facing infant seat">Rear-facing infant seat</option>
          <option value="Forward-facing car seat">Forward-facing car seat</option>
          <option value="Booster seat">Booster seat</option>
        </select>

        <select class="seat-qty" name="Child seat quantity[]" aria-label="Quantity">
          <option value="">#</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>

        <button type="button" class="seat-remove btn-secondary" aria-label="Remove seat selection" style="padding:0.4rem 0.6rem;">
          √ó
        </button>
      `;

      const typeEl = row.querySelector(".seat-type");
      const qtyEl = row.querySelector(".seat-qty");
      const removeBtn = row.querySelector(".seat-remove");

      typeEl.addEventListener("change", updateSeatsSummary);
      qtyEl.addEventListener("change", updateSeatsSummary);

      removeBtn.addEventListener("click", () => {
        row.remove();
        toggleSeatRemoveButtons();
        updateSeatsSummary();
      });

      return row;
    }

    if (addSeatRowBtn && seatRows) {
      seatRows.querySelectorAll(".seat-type, .seat-qty").forEach((el) => {
        el.addEventListener("change", updateSeatsSummary);
      });

      addSeatRowBtn.addEventListener("click", () => {
        seatRows.appendChild(makeSeatRow());
        toggleSeatRemoveButtons();
        updateSeatsSummary();
      });

      toggleSeatRemoveButtons();
      updateSeatsSummary();
    }

    function getPickupDateTime() {
      const dateValue = pickupDateInput.value;
      const timeValue = pickupTimeInput.value;
      if (!dateValue || !timeValue) return null;
      const dt = new Date(dateValue + "T" + timeValue);
      if (isNaN(dt.getTime())) return null;
      return dt;
    }

    function setPayUI() {
      if (!payBtn) return;
      const enable = !!(currentCanPayNow && currentAmountCents > 0);
      payBtn.disabled = !enable;
      payBtn.textContent = "Pay with Square";
      payBtn.title = enable
        ? ""
        : (!getPickupDateTime()
            ? "Select pickup date/time first"
            : (!currentCanPayNow
              ? "Trips within 8 hours must be confirmed first"
              : "Select route/vehicle/trip to enable payment"));
    }

    function updatePriceAndUI() {
      syncTripTypeOptions();
      syncHourlyHoursUI();
      syncReturnTripUI();

      const route = routeSelect.value;
      const vehicle = vehicleSelect.value;
      const tripType = tripTypeSelect.value;
      const pickupDateTime = getPickupDateTime();

      if (routeVehicleCard) routeVehicleCard.style.display = pickupDateTime ? "block" : "none";

      // timing
      let timingLabel = "Pickup time not selected yet";
      let timingNote = "";
      let canPayNow = false;

      if (pickupDateTime) {
        const now = new Date();
        const diffHours = (pickupDateTime - now) / (1000 * 60 * 60);

        if (diffHours < 8) {
          timingLabel = "Short notice (< 8 hours)";
          timingNote =
            " This trip is within the next 8 hours. Please submit this form as a request only and wait for our confirmation before making any payment.";
          canPayNow = false;
        } else {
          timingLabel = "Standard (‚â• 8 hours)";
          timingNote =
            " This trip is more than 8 hours away. You can submit your request and pay securely with Square.";
          canPayNow = true;
        }

        timingBanner.textContent =
          "Pickup time check: " + timingLabel + ". " +
          (diffHours > 0
            ? "Approx. " + diffHours.toFixed(1) + " hours from now."
            : "Pickup time appears to be in the past or very soon. We will review it.");
      } else {
        timingBanner.textContent =
          "Once you select your pickup date and time, we‚Äôll tell you if this is a short-notice request (< 8 hours) or a standard booking (‚â• 8 hours).";
      }

      // defaults
      currentAmountCents = 0;
      currentCanPayNow = false;

      if (route === "CUSTOM") {
        priceText.textContent =
          "Custom route selected." +
          (timingNote ? timingNote + " We will review your details and confirm the price." : " We will review your details and confirm the price.");

        selectedOptionInput.value =
          "Custom route ‚Äì price to be confirmed by MLT. Timing: " + timingLabel;

        setPayUI();
        return;
      }

      if (!route || !vehicle || !tripType) {
        priceText.textContent =
          "Please select a route, vehicle and trip type to see the price and payment instructions." +
          (timingNote || "");
        selectedOptionInput.value = "";
        setPayUI();
        return;
      }

      const routeData = OPTIONS[route];
      if (!routeData || !routeData[vehicle] || !routeData[vehicle][tripType]) {
        priceText.textContent =
          "We don't have a fixed price for that exact combination. Please describe your trip in the notes and we will confirm the price." +
          (timingNote || "");

        selectedOptionInput.value =
          "No fixed price: route=" + route + ", vehicle=" + vehicle +
          ", tripType=" + tripType + ". Timing: " + timingLabel;

        setPayUI();
        return;
      }

      const option = routeData[vehicle][tripType];

      let tripLabel = "";
      if (tripType === "ONEWAY") tripLabel = "One-way";
      else if (tripType === "ROUND") tripLabel = "Round trip";
      else if (tripType === "HOURLY") tripLabel = "Hourly (3-hour minimum)";

      // hourly totals
      if (route === "HOURLY" && tripType === "HOURLY") {
        const hours = parseInt(charterHoursSelect?.value || "3", 10);
        const safeHours = isNaN(hours) ? 3 : hours;
        const total = option.price * safeHours;

        priceText.textContent =
          `Selected: Hourly Charter within Orlando ‚Äì ${vehicle} at $${option.price}/hr √ó ${safeHours} hours = $${total}.` +
          timingNote;

        currentAmountCents = Math.round(total * 100);
        currentCanPayNow = !!(canPayNow && currentAmountCents > 0);

        selectedOptionInput.value =
          `Route: ${route}, Vehicle: ${vehicle}, Trip type: ${tripLabel}, ` +
          `Rate: $${option.price}/hr, Hours: ${safeHours}, Total: $${total}, ` +
          `Timing: ${timingLabel}`;

        setPayUI();
        return;
      }

      // non-hourly
      priceText.textContent =
        `Selected: ${tripLabel} ${vehicle} for ${route} ‚Äì $${option.price}.` +
        timingNote;

      currentAmountCents = Math.round(option.price * 100);
      currentCanPayNow = !!(canPayNow && currentAmountCents > 0);

      selectedOptionInput.value =
        `Route: ${route}, Vehicle: ${vehicle}, Trip type: ${tripLabel}, Price: $${option.price}, ` +
        `Timing: ${timingLabel}`;

      setPayUI();
    }

    // Prefill from query params (from rates buttons)
    function prefillFromQueryString() {
      const params = new URLSearchParams(window.location.search);
      if (!params || [...params.keys()].length === 0) return;

      const rawRoute = params.get("route") || "";
      const rawVehicle = params.get("vehicle") || "";
      const rawTrip = params.get("trip") || "";

      const routeMap = {
        "MCO-Universal-Idrive-Seaworld-Convention": "MCO_UNIVERSAL",
        "MCO-Disney-LBV-BayLake-GoldenOak": "MCO_DISNEY",
        "MCO-Windermere-WinterPark": "MCO_WINDERMERE",
        "MCO-Port-Canaveral": "MCO_PORT",
        "SFB-Universal-Idrive-Seaworld-Convention": "SFB_IDRIVE",
        "SFB-Disney-LBV-BayLake-GoldenOak": "SFB_DISNEY",
        "Hourly-Orlando": "HOURLY",
      };

      const vehicleMap = {
        "Sedan": "SEDAN",
        "SUV": "SUV",
        "Van8": "VAN8",
        "Van14": "VAN14",
      };

      const tripMap = {
        "oneway": "ONEWAY",
        "round": "ROUND",
        "hourly": "HOURLY",
      };

      const mappedRoute = routeMap[rawRoute] || "";
      const mappedVehicle = vehicleMap[rawVehicle] || "";
      const mappedTrip = tripMap[(rawTrip || "").toLowerCase()] || "";

      if (mappedRoute) routeSelect.value = mappedRoute;
      if (mappedVehicle) vehicleSelect.value = mappedVehicle;
      if (mappedTrip) tripTypeSelect.value = mappedTrip;

      const hoursParam = parseInt(params.get("hours") || "", 10);
      if (!isNaN(hoursParam) && hoursParam >= 3 && hoursParam <= 24 && charterHoursSelect) {
        charterHoursSelect.value = String(hoursParam);
      }
    }

    routeSelect.addEventListener("change", updatePriceAndUI);
    vehicleSelect.addEventListener("change", updatePriceAndUI);
    tripTypeSelect.addEventListener("change", updatePriceAndUI);
    pickupDateInput.addEventListener("change", updatePriceAndUI);
    pickupTimeInput.addEventListener("change", updatePriceAndUI);
    if (charterHoursSelect) charterHoursSelect.addEventListener("change", updatePriceAndUI);

    // Submit booking request to Formspree (AJAX)
    bookingForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      updateSeatsSummary();
      updatePriceAndUI();

      if (formStatus) {
        formStatus.style.display = "none";
        formStatus.textContent = "";
      }

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = "Sending...";
      }

      try {
        const formData = new FormData(bookingForm);

        const res = await fetch(bookingForm.action, {
          method: "POST",
          body: formData,
          headers: { "Accept": "application/json" }
        });

        if (!res.ok) {
          let msg = "Sorry‚Äîthere was a problem sending your request. Please try again, or call/text us.";
          try {
            const data = await res.json();
            if (data && data.errors && data.errors.length) {
              msg = data.errors.map(e => e.message).join(" ");
            }
          } catch (_) {}

          if (formStatus) {
            formStatus.style.display = "block";
            formStatus.textContent = msg;
          }
        } else {
          if (formStatus) {
            formStatus.style.display = "block";
            formStatus.textContent = "Request sent! You can pay with Square if your pickup time is ‚â• 8 hours away.";
          }
        }
      } catch (err) {
        if (formStatus) {
          formStatus.style.display = "block";
          formStatus.textContent =
            "Network error‚Äîplease check your connection and try again, or call/text us.";
        }
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit booking request";
        }
        updatePriceAndUI();
      }
    });

    // Pay with Square (creates a payment link via /api/create-square-link)
    if (payBtn) {
      payBtn.addEventListener("click", async () => {
        updatePriceAndUI();

        if (payStatus) {
          payStatus.style.display = "none";
          payStatus.textContent = "";
        }

        if (payBtn.disabled) {
          if (payStatus) {
            payStatus.style.display = "block";
            payStatus.textContent = "Payment is not available yet. Please select pickup time and a valid option (and trips must be ‚â• 8 hours away).";
          }
          return;
        }

        const route = routeSelect.value;
        const vehicle = vehicleSelect.value;
        const tripType = tripTypeSelect.value;

        let hours = null;
        if (route === "HOURLY" && tripType === "HOURLY") {
          hours = parseInt(charterHoursSelect?.value || "3", 10);
          if (isNaN(hours)) hours = 3;
        }

        payBtn.disabled = true;
        const oldText = payBtn.textContent;
        payBtn.textContent = "Creating payment link...";

        try {
          const resp = await fetch("/api/create-square-link", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              amountCents: currentAmountCents,
              route,
              vehicle,
              tripType,
              hours
            })
          });

          const data = await resp.json().catch(() => ({}));

          if (!resp.ok || !data?.ok || !data?.url) {
            console.error("Square link error:", data);
            if (payStatus) {
              payStatus.style.display = "block";
              payStatus.textContent = "Payment link error. Please try again or contact us.";
            }
            return;
          }

          window.location.href = data.url;
        } catch (err) {
          console.error(err);
          if (payStatus) {
            payStatus.style.display = "block";
            payStatus.textContent = "Network error creating payment link. Please try again.";
          }
        } finally {
          payBtn.disabled = false;
          payBtn.textContent = oldText;
          updatePriceAndUI();
        }
      });
    }

    // Initialize
    prefillFromQueryString();
    updatePriceAndUI();
    updateSeatsSummary();
  </script>
</body>
</html>
