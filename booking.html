<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Book in 3 Steps | MLT Orlando Transportation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
    body{background:#f3f4f6;color:#020617;line-height:1.55}
    a{color:inherit;text-decoration:none}
    header{background:#020617;color:#fff;padding:16px}
    .nav{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{font-weight:800;letter-spacing:.5px}
    .links{display:flex;gap:14px;flex-wrap:wrap;font-size:14px;opacity:.95}
    .links a{padding:6px 10px;border-radius:10px}
    .links a:hover{background:rgba(255,255,255,.08)}
    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr;gap:18px}
    @media(min-width:980px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,.08);overflow:hidden}
    .head{padding:16px 16px 12px;border-bottom:1px solid #e5e7eb}
    .head h1,.head h2{font-size:18px;margin-bottom:6px}
    .head p{font-size:13px;color:#475569}
    .body{padding:16px}
    .stepper{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px}
    .step{border:1px solid #e5e7eb;background:#f8fafc;border-radius:14px;padding:10px 12px;font-size:12px;color:#334155;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .step.active{border-color:#93c5fd;box-shadow:0 0 0 4px rgba(59,130,246,.10)}
    .badge{background:#0ea5e9;color:#fff;font-weight:800;border-radius:999px;padding:4px 10px;font-size:12px}
    .muted{color:#64748b;font-size:12px}
    .danger{color:#b91c1c}
    .ok{color:#166534}

    .section{margin-top:16px}
    .section:first-child{margin-top:0}
    .section-title{font-weight:750;font-size:14px;margin-bottom:10px;color:#0f172a}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:700px){.row.two{grid-template-columns:1fr 1fr}}
    label{font-size:12px;color:#334155;margin-bottom:6px;display:block}
    input,select,textarea{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font-size:14px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#93c5fd;box-shadow:0 0 0 4px rgba(59,130,246,.12)}
    textarea{min-height:100px;resize:vertical}
    .note{margin-top:10px;background:#f8fafc;border:1px solid #e2e8f0;padding:12px;border-radius:14px;font-size:12px;color:#334155}
    .btnrow{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    button{border:0;border-radius:999px;padding:12px 14px;font-weight:800;cursor:pointer;font-size:14px;flex:1;min-width:160px}
    .btn-primary{background:#0ea5e9;color:#fff}
    .btn-secondary{background:#111827;color:#fff}
    .btn-ghost{background:#e2e8f0;color:#0f172a}
    .btn-secondary[disabled]{background:#9ca3af;cursor:not-allowed}
    .panel{display:none}
    .panel.active{display:block}
    .summary{border:1px solid #e5e7eb;border-radius:14px;padding:12px;background:#fff}
    .summary .line{display:flex;justify-content:space-between;gap:12px;padding:8px 0;border-bottom:1px solid #f1f5f9;font-size:13px}
    .summary .line:last-child{border-bottom:0}
    .summary .k{color:#64748b}
    .summary .v{font-weight:700;text-align:right}
    .side{padding:16px}
    .side .box{background:#f8fafc;border:1px solid #e2e8f0;padding:12px;border-radius:14px;margin-bottom:12px}
    .side .box p{font-size:12px;color:#334155;margin:6px 0}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px}
  </style>
</head>

<body>
<header>
  <div class="nav">
    <div class="brand">MLT ORLANDO TRANSPORTATION</div>
    <nav class="links">
      <a href="index.html">Home</a>
      <a href="services.html">Services</a>
      <a href="owner.html">Owner</a>
      <a href="private-airport.html">Private Airport</a>
      <a href="child-seats.html">Child Seats</a>
      <a href="service-areas.html">Service Areas</a>
      <a href="rates.html">Rates</a>
    </nav>
  </div>
</header>

<main>
  <div class="grid">
    <div class="card">
      <div class="head">
        <h1>Book in 3 Steps</h1>
        <p>Step 1: Details → Step 2: Review → Step 3: Pay &amp; Confirm</p>
      </div>

      <div class="body">
        <div class="stepper">
          <div class="step active" id="s1"><span><strong>Step 1</strong><br><span class="muted">Trip details</span></span><span class="badge">1</span></div>
          <div class="step" id="s2"><span><strong>Step 2</strong><br><span class="muted">Review</span></span><span class="badge" id="b2" style="opacity:.35;">2</span></div>
          <div class="step" id="s3"><span><strong>Step 3</strong><br><span class="muted">Payment</span></span><span class="badge" id="b3" style="opacity:.35;">3</span></div>
        </div>

        <form id="bookingForm" novalidate>
          <!-- STEP 1 -->
          <section class="panel active" id="p1">
            <div class="section">
              <div class="section-title">Passenger info</div>
              <div class="row two">
                <div>
                  <label for="passengerName">Passenger name</label>
                  <input id="passengerName" type="text" required />
                </div>
                <div>
                  <label for="email">Email (same as payment)</label>
                  <input id="email" type="email" required />
                </div>
              </div>
              <div class="row two" style="margin-top:10px;">
                <div>
                  <label for="phone">Mobile / WhatsApp number</label>
                  <input id="phone" type="tel" required />
                </div>
                <div>
                  <label for="passengers">Number of passengers</label>
                  <input id="passengers" type="text" placeholder="e.g. 2 adults, 2 children" />
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-title">Pickup date &amp; time</div>
              <div class="row two">
                <div>
                  <label for="pickupDate">Pickup date</label>
                  <input id="pickupDate" type="date" required />
                </div>
                <div>
                  <label for="pickupTime">Pickup time (local)</label>
                  <input id="pickupTime" type="time" required />
                </div>
              </div>
              <div class="note" id="urgencyNote" style="display:none;"></div>
            </div>

            <div class="section">
              <div class="section-title">Route &amp; price (from Rates)</div>

              <div class="row two">
                <div>
                  <label>Route</label>
                  <input id="routeDisplay" readonly />
                </div>
                <div>
                  <label>Vehicle</label>
                  <input id="vehicleDisplay" readonly />
                </div>
              </div>

              <div class="row two" style="margin-top:10px;">
                <div>
                  <label>Trip type</label>
                  <input id="tripDisplay" readonly />
                </div>
                <div>
                  <label id="priceLabel">Total price (USD)</label>
                  <input id="priceDisplay" readonly />
                </div>
              </div>

              <!-- Hourly only -->
              <div class="row two" style="margin-top:10px; display:none;" id="hourlyRow">
                <div>
                  <label for="hours">Hours (3–24)</label>
                  <select id="hours"></select>
                </div>
                <div>
                  <label>Hourly rate</label>
                  <input id="hourlyRateDisplay" readonly />
                </div>
              </div>

              <div class="note">
                If route/vehicle/price are empty, go to <a href="rates.html" style="text-decoration:underline;"><strong>Rates</strong></a> and select a route first.
              </div>
            </div>

            <div class="section">
              <div class="section-title">Locations &amp; trip details</div>
              <div class="row">
                <div>
                  <label for="pickupLocation">Pickup location</label>
                  <input id="pickupLocation" type="text" required />
                </div>
              </div>

              <div class="row two" style="margin-top:10px;">
                <div>
                  <label for="flight">Airline &amp; flight number (optional)</label>
                  <input id="flight" type="text" />
                </div>
                <div>
                  <label for="destination">Destination</label>
                  <input id="destination" type="text" required />
                </div>
              </div>

              <div class="row two" style="margin-top:10px;">
                <div>
                  <label for="luggage">Luggage details (optional)</label>
                  <input id="luggage" type="text" />
                </div>
                <div>
                  <label for="childSeats">Child seats (optional)</label>
                  <input id="childSeats" type="text" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div>
                  <label for="notes">Additional notes (optional)</label>
                  <textarea id="notes"></textarea>
                </div>
              </div>
            </div>

            <div class="btnrow">
              <button class="btn-primary" type="button" id="to2">Continue to Review</button>
            </div>
          </section>

          <!-- STEP 2 -->
          <section class="panel" id="p2">
            <div class="section-title">Review your booking</div>
            <div class="summary" id="summary"></div>

            <div class="btnrow">
              <button class="btn-ghost" type="button" id="back1">Back</button>
              <button class="btn-secondary" type="button" id="to3">Confirm &amp; Continue to Payment</button>
            </div>

            <div class="note">
              After you pay, Square will redirect you back to our confirmation page.
            </div>
          </section>

          <!-- STEP 3 -->
          <section class="panel" id="p3">
            <div class="section-title">Payment</div>
            <div class="note" id="payNote"></div>

            <div class="btnrow">
              <button class="btn-ghost" type="button" id="back2">Back</button>
              <button class="btn-secondary" type="button" id="payBtn">Pay with Square</button>
            </div>

            <div class="note" id="paymentMsg"></div>
          </section>
        </form>
      </div>
    </div>

    <aside class="card">
      <div class="head">
        <h2>Need help?</h2>
        <p>Contact us any time.</p>
      </div>
      <div class="side">
        <div class="box">
          <p><strong>Phone:</strong> <a href="tel:14073690643" style="text-decoration:underline;">407-369-0643</a></p>
          <p><strong>Email:</strong> <a href="mailto:mltorlando@yahoo.com" style="text-decoration:underline;">mltorlando@yahoo.com</a></p>
        </div>

        <div class="box">
          <p class="muted"><strong>API endpoint:</strong> <span class="kbd" id="api1"></span></p>
          <p class="muted"><strong>Confirmation endpoint:</strong> <span class="kbd" id="api2"></span></p>
        </div>
      </div>
    </aside>
  </div>
</main>

<script>
  // =========================
  // SET THIS IF YOUR SITE IS NOT HOSTED ON THE SAME VERCEL PROJECT
  // =========================
  // If booking.html is on Vercel: leave as ""
  // If booking.html is on GitHub Pages: set to "https://YOUR-VERCEL-PROJECT.vercel.app"
  const API_BASE = "";

  document.getElementById("api1").textContent = (API_BASE || location.origin) + "/api/create-square-link";
  document.getElementById("api2").textContent = (API_BASE || location.origin) + "/api/confirm-booking";

  // URL params from Rates
  const params = new URLSearchParams(location.search);
  const route = params.get("route") || "";
  const vehicle = params.get("vehicle") || "";
  const trip = params.get("trip") || "";
  const priceParam = params.get("price") || ""; // on hourly this is HOURLY rate

  document.getElementById("routeDisplay").value = route;
  document.getElementById("vehicleDisplay").value = vehicle;
  document.getElementById("tripDisplay").value = trip;

  // Hourly hours dropdown
  const hourlyRow = document.getElementById("hourlyRow");
  const hoursSel = document.getElementById("hours");
  for (let h = 3; h <= 24; h++) {
    const opt = document.createElement("option");
    opt.value = String(h);
    opt.textContent = String(h);
    hoursSel.appendChild(opt);
  }

  function isFinitePositive(n){ const x = Number(n); return Number.isFinite(x) && x > 0; }

  function getPickupDateTimeLocal() {
    const d = document.getElementById("pickupDate").value;
    const t = document.getElementById("pickupTime").value;
    if (!d || !t) return null;
    const dt = new Date(d + "T" + t);
    return isNaN(dt.getTime()) ? null : dt;
  }
  function hoursUntil(dt) {
    const now = new Date();
    return (dt.getTime() - now.getTime()) / (1000 * 60 * 60);
  }

  const urgencyNote = document.getElementById("urgencyNote");
  function refreshUrgency() {
    const dt = getPickupDateTimeLocal();
    const within8 = dt ? hoursUntil(dt) <= 8 : false;
    if (dt && within8) {
      urgencyNote.style.display = "block";
      urgencyNote.innerHTML = `<span class="danger"><strong>Short notice:</strong> pickup is within 8 hours. Please contact us to confirm availability before paying.</span>`;
    } else {
      urgencyNote.style.display = "none";
      urgencyNote.innerHTML = "";
    }
  }
  document.getElementById("pickupDate").addEventListener("change", refreshUrgency);
  document.getElementById("pickupTime").addEventListener("change", refreshUrgency);
  refreshUrgency();

  function getAmountDollars() {
    if (!isFinitePositive(priceParam)) return 0;
    const base = Number(priceParam);

    if (trip === "hourly") {
      const hrs = Number(hoursSel.value || 3);
      return base * hrs;
    }
    return base;
  }

  function refreshPriceUI() {
    if (!isFinitePositive(priceParam)) {
      document.getElementById("priceDisplay").value = "";
      hourlyRow.style.display = "none";
      return;
    }

    if (trip === "hourly") {
      hourlyRow.style.display = "grid";
      document.getElementById("hourlyRateDisplay").value = `$${Number(priceParam).toFixed(2)} / hr`;
      document.getElementById("priceLabel").textContent = "Total (USD)";
      document.getElementById("priceDisplay").value = `$${getAmountDollars().toFixed(2)}`;
    } else {
      hourlyRow.style.display = "none";
      document.getElementById("priceLabel").textContent = "Total price (USD)";
      document.getElementById("priceDisplay").value = `$${getAmountDollars().toFixed(2)}`;
    }
  }
  hoursSel.addEventListener("change", refreshPriceUI);
  refreshPriceUI();

  // Step UI
  const p1 = document.getElementById("p1");
  const p2 = document.getElementById("p2");
  const p3 = document.getElementById("p3");
  const s1 = document.getElementById("s1");
  const s2 = document.getElementById("s2");
  const s3 = document.getElementById("s3");
  const b2 = document.getElementById("b2");
  const b3 = document.getElementById("b3");

  function setStep(n){
    p1.classList.toggle("active", n===1);
    p2.classList.toggle("active", n===2);
    p3.classList.toggle("active", n===3);
    s1.classList.toggle("active", n===1);
    s2.classList.toggle("active", n===2);
    s3.classList.toggle("active", n===3);
    b2.style.opacity = n>=2 ? "1" : ".35";
    b3.style.opacity = n>=3 ? "1" : ".35";
  }

  function getVal(id){ return (document.getElementById(id).value || "").trim(); }

  function validateStep1(){
    const required = ["passengerName","email","phone","pickupDate","pickupTime","pickupLocation","destination"];
    for (const id of required) {
      const el = document.getElementById(id);
      if (!el.value.trim()) { el.focus(); return {ok:false, msg:"Please complete all required fields."}; }
    }
    if (!route || !vehicle || !trip || !isFinitePositive(priceParam)) {
      return {ok:false, msg:"Please start from the Rates page so route/vehicle/price are filled in."};
    }
    const dt = getPickupDateTimeLocal();
    const within8 = dt ? hoursUntil(dt) <= 8 : false;
    if (within8) return {ok:false, msg:"Pickup is within 8 hours. Please contact us before payment."};

    if (trip === "hourly") {
      const hrs = Number(hoursSel.value || 0);
      if (!Number.isFinite(hrs) || hrs < 3) return {ok:false, msg:"Hourly charter requires 3 hours minimum."};
    }
    return {ok:true};
  }

  function buildBookingData(cid){
    return {
      confirmation_id: cid,
      passenger_name: getVal("passengerName"),
      email: getVal("email"),
      phone: getVal("phone"),
      passengers: getVal("passengers"),
      pickup_date: getVal("pickupDate"),
      pickup_time: getVal("pickupTime"),
      pickup_location: getVal("pickupLocation"),
      destination: getVal("destination"),
      flight: getVal("flight"),
      luggage: getVal("luggage"),
      child_seats: getVal("childSeats"),
      notes: getVal("notes"),
      route,
      vehicle,
      trip_type: trip,
      hourly_hours: trip === "hourly" ? Number(hoursSel.value || 3) : "",
      amount_usd: getAmountDollars().toFixed(2),
    };
  }

  function renderSummary(data){
    const lines = [
      ["Confirmation #", data.confirmation_id],
      ["Name", data.passenger_name],
      ["Email", data.email],
      ["Phone", data.phone],
      ["Passengers", data.passengers || "-"],
      ["Pickup", `${data.pickup_date} ${data.pickup_time}`],
      ["Route", data.route],
      ["Vehicle", data.vehicle],
      ["Trip", data.trip_type],
    ];
    if (trip === "hourly") lines.push(["Hours", String(data.hourly_hours)]);
    lines.push(["Total", `$${data.amount_usd}`]);
    lines.push(["Pickup location", data.pickup_location]);
    lines.push(["Destination", data.destination]);
    lines.push(["Flight", data.flight || "-"]);
    lines.push(["Luggage", data.luggage || "-"]);
    lines.push(["Child seats", data.child_seats || "-"]);
    lines.push(["Notes", data.notes || "-"]);

    document.getElementById("summary").innerHTML = lines.map(([k,v]) => `
      <div class="line"><div class="k">${k}</div><div class="v">${String(v).replaceAll("<","&lt;")}</div></div>
    `).join("");
  }

  document.getElementById("to2").addEventListener("click", () => {
    const v = validateStep1();
    if (!v.ok) return alert(v.msg);

    // create cid now
    const cid = "MLT-" + Date.now() + "-" + Math.random().toString(16).slice(2,8).toUpperCase();
    const data = buildBookingData(cid);
    localStorage.setItem("mltBooking:" + cid, JSON.stringify(data));
    localStorage.setItem("mltLastCid", cid);

    renderSummary(data);
    setStep(2);
  });

  document.getElementById("back1").addEventListener("click", () => setStep(1));

  document.getElementById("to3").addEventListener("click", () => {
    const cid = localStorage.getItem("mltLastCid") || "";
    const saved = cid ? localStorage.getItem("mltBooking:" + cid) : null;
    const data = saved ? JSON.parse(saved) : null;
    if (!data) return alert("Missing saved booking data. Please go back and try again.");

    document.getElementById("payNote").innerHTML =
      `You will be redirected to Square for secure payment. After payment, you’ll return for confirmation.<br>
       <span class="muted">Confirmation #: <strong>${data.confirmation_id}</strong></span>`;
    setStep(3);
  });

  document.getElementById("back2").addEventListener("click", () => setStep(2));

  // Pay
  const payBtn = document.getElementById("payBtn");
  const paymentMsg = document.getElementById("paymentMsg");

  payBtn.addEventListener("click", async () => {
    paymentMsg.innerHTML = "";
    payBtn.disabled = true;
    payBtn.textContent = "Creating payment link...";

    try {
      const cid = localStorage.getItem("mltLastCid") || "";
      const saved = cid ? localStorage.getItem("mltBooking:" + cid) : null;
      const booking = saved ? JSON.parse(saved) : null;

      if (!booking) throw new Error("Missing booking data. Please go back and try again.");

      const amount = Number(booking.amount_usd);
      if (!Number.isFinite(amount) || amount <= 0) throw new Error("Invalid amount. Please select a route from Rates.");

      // redirect back to confirm.html (include cid)
      const redirectUrl = `${location.origin}/confirm.html?cid=${encodeURIComponent(cid)}`;

      const lineItemName =
        `MLT Transportation - ${route} - ${vehicle} (${trip}${trip==="hourly" ? ` ${booking.hourly_hours}h` : ""})`;

      const note =
        `CID:${cid} | ${booking.passenger_name} | ${booking.pickup_date} ${booking.pickup_time} | ` +
        `${booking.pickup_location} -> ${booking.destination} | ${booking.phone} | ${booking.email}`;

      const r = await fetch((API_BASE || "") + "/api/create-square-link", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount,
          currency: "USD",
          lineItemName,
          note,
          referenceId: cid,
          redirectUrl,
          buyerEmail: booking.email,
          buyerPhone: booking.phone,
        }),
      });

      const data = await r.json().catch(() => ({}));

      if (!data.ok) {
        // Show real error so you can fix it fast
        paymentMsg.innerHTML =
          `<span class="danger"><strong>Error:</strong> ${data.error || "Could not create payment link."}</span>` +
          `<div class="note"><pre style="white-space:pre-wrap">${JSON.stringify(data.details || data, null, 2)}</pre></div>`;
        payBtn.disabled = false;
        payBtn.textContent = "Pay with Square";
        return;
      }

      paymentMsg.innerHTML = `<span class="ok"><strong>Success:</strong> Redirecting to Square…</span>`;
      window.location.href = data.url;
    } catch (e) {
      paymentMsg.innerHTML = `<span class="danger"><strong>Error:</strong> ${e.message || "Failed. Please try again."}</span>`;
      payBtn.disabled = false;
      payBtn.textContent = "Pay with Square";
    }
  });
</script>
</body>
</html>
