<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Booking Details &amp; Contact | MLT Orlando Transportation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="Share your trip details with MLT Orlando Transportation so we can confirm your booking and (if eligible) pay via Square."
  />
  <meta property="og:title" content="Booking Details &amp; Contact | MLT Orlando Transportation" />
  <meta
    property="og:description"
    content="Book private transportation in Orlando, Windermere, Lake Buena Vista, Golden Oak, Winter Park, I-Drive, SeaWorld and Port Canaveral."
  />
  <meta property="og:image" content="https://www.mltorlandotransportation.com/suv-front-main.jpeg" />
  <meta property="og:url" content="https://www.mltorlandotransportation.com/booking.html" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />

  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- Top contact bar -->
  <div class="top-bar">
    <div class="top-bar-inner">
      <span>Private Orlando transportation from MCO &amp; SFB to Disney, Universal &amp; Cape Canaveral.</span>

      <div class="top-bar-right">
        <span>
          Call: <a href="tel:14073690643">407-369-0643</a> ¬∑
          Email: <a href="mailto:mltorlando@yahoo.com">mltorlando@yahoo.com</a>
        </span>

        <div class="social-top">
          <a href="https://facebook.com/" target="_blank" rel="noopener">
            <img src="facebook-icon.jpeg" alt="Facebook" />
          </a>
          <a href="https://wa.me/14073690643" target="_blank" rel="noopener">
            <img src="whatsapp-icon.jpeg" alt="WhatsApp" />
          </a>
          <a href="https://www.instagram.com/mltorlando?igsh=ODV0Y2pocXJ0bjk4" target="_blank" rel="noopener">
            <img src="instagram-icon.jpeg" alt="Instagram" />
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Header / nav -->
  <header>
    <div class="nav">
      <a href="index.html" class="logo" style="text-decoration:none;">MLT Orlando Transportation</a>
      <nav>
        <a href="index.html">Home</a>
        <a href="services.html">Services</a>
        <a href="owner.html">Owner</a>
        <a href="private-airport.html">Private Airport</a>
        <a href="child-seats.html">Child Seats</a>
        <a href="service-areas.html">Service Areas</a>
        <a href="rates.html">Rates</a>
        <a href="cancellation.html">Cancellation</a>
        <a href="why-us.html">Why Us</a>
        <a href="booking.html">Booking</a>
      </nav>
    </div>
  </header>

  <main>
    <section id="contact">
      <a
        href="rates.html"
        class="btn-primary"
        style="text-decoration:none; display:inline-block; margin-bottom:1.5rem;"
      >
        ‚Üê Back to Rates &amp; Booking
      </a>

      <h2>Booking Details &amp; Contact</h2>
      <p class="section-intro">
        For trips <strong>within 8 hours</strong>, this form sends us a <strong>request</strong> and we must confirm
        availability before you pay. <br />
        For trips <strong>more than 8 hours away</strong>, you can submit this form and then pay through Square.
      </p>

      <div class="contact-wrapper">
        <!-- LEFT -->
        <div>
          <form
            id="booking-form"
            action="https://formspree.io/f/xovgzajo"
            method="POST"
          >
            <input
              type="hidden"
              id="selected-option"
              name="Selected route / vehicle / price / timing"
              value=""
            />

            <input type="hidden" id="child-seats-summary" name="Child seats summary" value="" />

            <label for="name">Passenger name</label>
            <input id="name" name="Passenger name" type="text" placeholder="Full name" required />

            <label for="email">Email (same as payment)</label>
            <input id="email" name="Email" type="email" placeholder="you@example.com" required />

            <label for="phone">Mobile / WhatsApp number</label>
            <input id="phone" name="Phone" type="tel" placeholder="+1 407-369-0643" required />

            <label for="pickup-date">Pickup date</label>
            <input id="pickup-date" name="Pickup date" type="date" required />

            <label for="pickup-time">Pickup time (local)</label>
            <input id="pickup-time" name="Pickup time" type="time" required />

            <p id="timing-banner" class="hero-note" style="margin-top:0.75rem;">
              Once you select your pickup date and time, we‚Äôll tell you if this is a short-notice request (&lt; 8 hours) or a standard booking (‚â• 8 hours).
            </p>

            <!-- ROUTE / VEHICLE / TRIP TYPE SELECTION (AFTER TIME) -->
            <div id="route-vehicle-card" class="card" style="margin:1.25rem 0; display:none;">
              <h3>Select Your Route &amp; Vehicle</h3>

              <label for="route">Route / Area</label>
              <select id="route">
                <option value="">Select a route</option>
                <option value="MCO_UNIVERSAL">MCO ‚Üî Universal / I-Drive / SeaWorld / Convention Center</option>
                <option value="MCO_DISNEY">MCO ‚Üî Disney / Lake Buena Vista / Bay Lake / Golden Oak</option>
                <option value="MCO_WINDERMERE">MCO ‚Üî Windermere / Winter Park</option>
                <option value="MCO_PORT">MCO / Orlando ‚Üî Port Canaveral</option>
                <option value="SFB_IDRIVE">SFB ‚Üî I-Drive / Convention Center / Universal / SeaWorld</option>
                <option value="SFB_DISNEY">SFB ‚Üî Disney / Lake Buena Vista / Bay Lake / Golden Oak</option>
                <option value="HOURLY">Hourly Charter (within Orlando)</option>
                <option value="CUSTOM">Other / custom route (we will confirm price by email)</option>
              </select>

              <label for="vehicle">Vehicle type</label>
              <select id="vehicle">
                <option value="">Select a vehicle</option>
                <option value="SEDAN">Sedan (up to 3) ¬∑ üß≥ 2 large ¬∑ 1 carry-on</option>
                <option value="SUV">SUV (up to 5) ¬∑ üß≥ 5 large ¬∑ 3 carry-on</option>
                <option value="VAN8">8-passenger van ¬∑ üß≥ 10 large ¬∑ 5 carry-on</option>
                <option value="VAN14">14-passenger van ¬∑ üß≥ 14 large ¬∑ 7 carry-on</option>
              </select>

              <label for="trip-type">Trip type</label>
              <select id="trip-type">
                <option value="">Select trip type</option>
                <option value="ONEWAY">One-way</option>
                <option value="ROUND">Round trip</option>
                <option value="HOURLY">Hourly (3-hour minimum)</option>
              </select>

              <!-- Charter hours dropdown (3 to 24, by the hour) -->
              <div id="charter-hours-wrap" style="display:none; margin-top:0.75rem;">
                <label for="charter-hours">Charter hours</label>
                <select id="charter-hours" name="Charter hours"></select>
                <p class="hero-note" style="margin-top:0.5rem;">
                  Hourly charters have a 3-hour minimum. Select your total hours (3‚Äì24).
                </p>
              </div>

              <div class="card" style="margin-top:1rem; background:#f9fafb;">
                <p id="price-text" class="hero-note" style="margin-bottom:0;">
                  Select your route, vehicle and trip type to see the price.
                </p>

                <!-- NEW: Separate Square test button -->
                <button
                  type="button"
                  id="square-pay-btn"
                  class="btn-secondary"
                  style="display:none; margin-top:0.75rem;"
                >
                  Pay with Square
                </button>

                <p id="square-status" class="hero-note" style="display:none; margin-top:0.6rem;"></p>
              </div>
            </div>

            <label for="pickup-location">Pickup location (airport, hotel, or address)</label>
            <input
              id="pickup-location"
              name="Pickup location"
              type="text"
              placeholder="Example: MCO (Orlando Intl), Hyatt Regency Orlando, 123 Main St, Orlando FL"
              required
            />

            <label for="flight">Airline &amp; flight number (if flying)</label>
            <input
              id="flight"
              name="Airline &amp; flight number"
              type="text"
              placeholder="Example: Delta 1234"
            />

            <label for="destination">Destination address / hotel</label>
            <input
              id="destination"
              name="Destination"
              type="text"
              placeholder="Hotel name or full address"
              required
            />

            <label for="passengers">Number of passengers</label>
            <input
              id="passengers"
              name="Passengers"
              type="number"
              min="1"
              max="14"
              placeholder="2 adults, 2 children"
              required
            />

            <label for="luggage">Luggage details</label>
            <input
              id="luggage"
              name="Luggage"
              type="text"
              placeholder="e.g. 3 large suitcases, 2 carry-ons, 1 stroller"
            />

            <!-- CHILD SEATS REPEATER -->
            <label>Child seats (add what you need)</label>

            <div id="seat-rows">
              <div class="seat-row" style="display:grid; grid-template-columns:1fr 90px 40px; gap:0.5rem; align-items:center;">
                <select class="seat-type" name="Child seat type[]" aria-label="Seat type">
                  <option value="">Select seat type</option>
                  <option value="Rear-facing infant seat">Rear-facing infant seat</option>
                  <option value="Forward-facing car seat">Forward-facing car seat</option>
                  <option value="Booster seat">Booster seat</option>
                </select>

                <select class="seat-qty" name="Child seat quantity[]" aria-label="Quantity">
                  <option value="">#</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                </select>

                <button type="button" class="seat-remove btn-secondary" aria-label="Remove seat selection" style="display:none; padding:0.4rem 0.6rem;">
                  √ó
                </button>
              </div>
            </div>

            <button type="button" id="add-seat-row" class="btn-secondary" style="margin-top:0.6rem;">
              + Add another seat type
            </button>

            <p class="hero-note" style="margin-top:0.6rem;">
              Example: add ‚ÄúRear-facing infant seat = 1‚Äù, then press + to add ‚ÄúBooster seat = 2‚Äù.
            </p>

            <!-- RETURN DETAILS (shown ONLY when Trip type = Round trip) -->
            <div id="return-details-card" class="card" style="margin-top:1.25rem; display:none;">
              <h3 style="margin-top:0;">Return trip details</h3>
              <p class="hero-note" style="margin-top:-0.25rem;">
                Fill this out only if you selected <strong>Round trip</strong>.
              </p>

              <label for="return-from">Return pickup (from where?)</label>
              <input id="return-from" name="Return pickup location" type="text" placeholder="e.g. Hotel / address" />

              <label for="return-to">Return destination (to where?)</label>
              <input id="return-to" name="Return destination" type="text" placeholder="e.g. MCO / SFB / address" />

              <label for="return-date">Return date</label>
              <input id="return-date" name="Return date" type="date" />

              <label for="return-time">Return pickup time (local)</label>
              <input id="return-time" name="Return pickup time" type="time" />

              <label for="return-notes">Return trip comments</label>
              <textarea
                id="return-notes"
                name="Return trip comments"
                placeholder="Anything we should know for the return (airline/flight, meeting point, special requests...)"
              ></textarea>
            </div>

            <label for="notes">Additional notes</label>
            <textarea
              id="notes"
              name="Notes"
              placeholder="Child ages and approximate weights, flight info, gate meeting instructions, gate code, private jet tail number, special requests..."
            ></textarea>

            <!-- Form submit stays separate -->
            <button id="submit-btn" type="submit" class="btn-primary">Submit booking request</button>

            <div id="form-status" class="hero-note" style="margin-top:0.75rem; display:none;"></div>

            <p class="hero-note" style="margin-top:0.75rem;">
              If your trip is <strong>within 8 hours</strong>, this will be treated as a
              <strong>short-notice request</strong> and we will confirm availability before you pay.
            </p>
          </form>
        </div>

        <!-- RIGHT -->
        <div class="contact-details">
          <p class="contact-label">Need help before booking?</p>
          <p>Phone: <a href="tel:14073690643"><strong>407-369-0643</strong></a></p>
          <p>Email: <a href="mailto:mltorlando@yahoo.com"><strong>mltorlando@yahoo.com</strong></a></p>
          <p>
            WhatsApp:
            <a href="https://wa.me/14073690643" target="_blank" rel="noopener">
              <strong>Message on WhatsApp</strong>
            </a>
          </p>

          <p class="contact-label" style="margin-top:1rem;">Typical hours</p>
          <p>Transportation: 24/7 by reservation</p>
          <p>Messages &amp; quotes: Every day, 8:00 ‚Äì 20:00 (local time)</p>

          <p class="contact-label" style="margin-top:1rem;">Base location</p>
          <p>
            MLT Orlando Transportation<br />
            Orlando, FL<br />
            United States
          </p>

          <p class="hero-note" style="margin-top:1rem;">
            If your exact route isn‚Äôt listed in the dropdown, choose
            <strong>Other / custom route</strong> and describe your trip in the notes section. We‚Äôll confirm the
            price and send the correct payment instructions.
          </p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="social-links">
      <a href="https://facebook.com/" target="_blank" rel="noopener">
        <img src="facebook-icon.jpeg" alt="Facebook" />
      </a>
      <a href="https://wa.me/14073690643" target="_blank" rel="noopener">
        <img src="whatsapp-icon.jpeg" alt="WhatsApp" />
      </a>
      <a href="https://www.instagram.com/mltorlando?igsh=ODV0Y2pocXJ0bjk4" target="_blank" rel="noopener">
        <img src="instagram-icon.jpeg" alt="Instagram" />
      </a>
    </div>

    ¬© <span id="year"></span> MLT Orlando Transportation. All rights reserved.
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    // IMPORTANT: This is your Vercel API base domain (Hosted Checkout endpoint should live here)
    const API_BASE = "https://mlt-payments-api.vercel.app";

    // Prices for DISPLAY only (backend should also calculate/validate).
    const PRICES = {
      MCO_UNIVERSAL: {
        SEDAN: { ONEWAY: 110, ROUND: 210 },
        SUV:   { ONEWAY: 120, ROUND: 230 },
        VAN8:  { ONEWAY: 140, ROUND: 260 },
        VAN14: { ONEWAY: 170, ROUND: 310 },
      },
      MCO_DISNEY: {
        SEDAN: { ONEWAY: 120, ROUND: 220 },
        SUV:   { ONEWAY: 130, ROUND: 240 },
        VAN8:  { ONEWAY: 150, ROUND: 280 },
        VAN14: { ONEWAY: 180, ROUND: 330 },
      },
      MCO_WINDERMERE: {
        SEDAN: { ONEWAY: 130, ROUND: 240 },
        SUV:   { ONEWAY: 140, ROUND: 260 },
        VAN8:  { ONEWAY: 160, ROUND: 300 },
        VAN14: { ONEWAY: 190, ROUND: 340 },
      },
      MCO_PORT: {
        SEDAN: { ONEWAY: 210, ROUND: 400 },
        SUV:   { ONEWAY: 230, ROUND: 440 },
        VAN8:  { ONEWAY: 260, ROUND: 500 },
        VAN14: { ONEWAY: 290, ROUND: 560 },
      },
      SFB_IDRIVE: {
        SEDAN: { ONEWAY: 160, ROUND: 300 },
        SUV:   { ONEWAY: 175, ROUND: 330 },
        VAN8:  { ONEWAY: 200, ROUND: 380 },
        VAN14: { ONEWAY: 225, ROUND: 420 },
      },
      SFB_DISNEY: {
        SEDAN: { ONEWAY: 175, ROUND: 330 },
        SUV:   { ONEWAY: 190, ROUND: 360 },
        VAN8:  { ONEWAY: 220, ROUND: 420 },
        VAN14: { ONEWAY: 245, ROUND: 470 },
      },
      HOURLY: {
        SEDAN: { HOURLY: 70 },
        SUV:   { HOURLY: 85 },
        VAN8:  { HOURLY: 95 },
        VAN14: { HOURLY: 120 },
      },
    };

    const routeSelect = document.getElementById("route");
    const vehicleSelect = document.getElementById("vehicle");
    const tripTypeSelect = document.getElementById("trip-type");
    const pickupDateInput = document.getElementById("pickup-date");
    const pickupTimeInput = document.getElementById("pickup-time");
    const priceText = document.getElementById("price-text");
    const timingBanner = document.getElementById("timing-banner");
    const selectedOptionInput = document.getElementById("selected-option");
    const bookingForm = document.getElementById("booking-form");
    const routeVehicleCard = document.getElementById("route-vehicle-card");
    const submitBtn = document.getElementById("submit-btn");
    const formStatus = document.getElementById("form-status");

    const squarePayBtn = document.getElementById("square-pay-btn");
    const squareStatus = document.getElementById("square-status");

    // Hourly hours dropdown
    const charterWrap = document.getElementById("charter-hours-wrap");
    const charterHoursSelect = document.getElementById("charter-hours");

    // Return trip fields (shown only for ROUND)
    const returnCard = document.getElementById("return-details-card");
    const returnFrom = document.getElementById("return-from");
    const returnTo = document.getElementById("return-to");
    const returnDate = document.getElementById("return-date");
    const returnTime = document.getElementById("return-time");

    // Build charter-hours options: 3 to 24
    (function buildHoursOptions() {
      if (!charterHoursSelect) return;
      charterHoursSelect.innerHTML = "";
      for (let h = 3; h <= 24; h++) {
        const opt = document.createElement("option");
        opt.value = String(h);
        opt.textContent = `${h} hours`;
        charterHoursSelect.appendChild(opt);
      }
      charterHoursSelect.value = "3";
    })();

    function getPickupDateTime() {
      const dateValue = pickupDateInput.value;
      const timeValue = pickupTimeInput.value;
      if (!dateValue || !timeValue) return null;

      const dt = new Date(dateValue + "T" + timeValue);
      if (isNaN(dt.getTime())) return null;
      return dt;
    }

    function prettyVehicle(code) {
      if (code === "SEDAN") return "Sedan";
      if (code === "SUV") return "SUV";
      if (code === "VAN8") return "8-passenger van";
      if (code === "VAN14") return "14-passenger van";
      return code || "";
    }

    function prettyTrip(code) {
      if (code === "ONEWAY") return "One-way";
      if (code === "ROUND") return "Round trip";
      if (code === "HOURLY") return "Hourly (3-hour minimum)";
      return code || "";
    }

    function syncTripTypeOptions() {
      const route = routeSelect.value;

      const hourlyOption = tripTypeSelect.querySelector('option[value="HOURLY"]');
      const onewayOption = tripTypeSelect.querySelector('option[value="ONEWAY"]');
      const roundOption  = tripTypeSelect.querySelector('option[value="ROUND"]');

      if (route === "HOURLY") {
        if (hourlyOption) hourlyOption.disabled = false;
        if (onewayOption) onewayOption.disabled = true;
        if (roundOption)  roundOption.disabled = true;
        if (tripTypeSelect.value !== "HOURLY") tripTypeSelect.value = "HOURLY";
      } else {
        if (hourlyOption) hourlyOption.disabled = true;
        if (onewayOption) onewayOption.disabled = false;
        if (roundOption)  roundOption.disabled = false;
        if (tripTypeSelect.value === "HOURLY") tripTypeSelect.value = "";
      }
    }

    function syncHourlyHoursUI() {
      const isHourly = (routeSelect.value === "HOURLY" && tripTypeSelect.value === "HOURLY");
      if (charterWrap) charterWrap.style.display = isHourly ? "block" : "none";
      if (charterHoursSelect) charterHoursSelect.required = isHourly;
      if (!isHourly && charterHoursSelect) charterHoursSelect.value = "3";
    }

    function syncReturnTripUI() {
      const isRound = (tripTypeSelect?.value === "ROUND");
      if (returnCard) returnCard.style.display = isRound ? "block" : "none";

      if (returnFrom) returnFrom.required = isRound;
      if (returnTo) returnTo.required = isRound;
      if (returnDate) returnDate.required = isRound;
      if (returnTime) returnTime.required = isRound;

      if (!isRound) {
        if (returnFrom) returnFrom.value = "";
        if (returnTo) returnTo.value = "";
        if (returnDate) returnDate.value = "";
        if (returnTime) returnTime.value = "";
        const rn = document.getElementById("return-notes");
        if (rn) rn.value = "";
      }
    }

    function getDisplayedTotal(route, vehicle, tripType) {
      if (!route || !vehicle || !tripType) return { hasFixedPrice: false, total: null, unit: null, hours: null };

      const routeData = PRICES[route];
      const unit = routeData?.[vehicle]?.[tripType];
      if (typeof unit !== "number") return { hasFixedPrice: false, total: null, unit: null, hours: null };

      if (route === "HOURLY" && tripType === "HOURLY") {
        const h = Math.max(3, Math.min(24, parseInt(charterHoursSelect?.value || "3", 10) || 3));
        return { hasFixedPrice: true, unit, total: unit * h, hours: h };
      }

      return { hasFixedPrice: true, unit, total: unit, hours: null };
    }

    // Payment eligibility flags
    let currentCanPayNow = false;     // time >= 8 hours
    let currentHasFixedPrice = false; // we have a price
    let currentIsCustom = false;      // custom route
    let currentSelectionReady = false;

    function setSquareStatus(msg) {
      if (!squareStatus) return;
      if (!msg) {
        squareStatus.style.display = "none";
        squareStatus.textContent = "";
      } else {
        squareStatus.style.display = "block";
        squareStatus.textContent = msg;
      }
    }

    function updateUI() {
      syncTripTypeOptions();
      syncHourlyHoursUI();
      syncReturnTripUI();

      const pickupDateTime = getPickupDateTime();

      if (routeVehicleCard) routeVehicleCard.style.display = pickupDateTime ? "block" : "none";

      // reset flags
      currentCanPayNow = false;
      currentHasFixedPrice = false;
      currentIsCustom = false;
      currentSelectionReady = false;

      setSquareStatus("");

      let timingLabel = "Pickup time not selected yet";
      let timingNote = "";
      let canPayNow = false;

      if (pickupDateTime) {
        const now = new Date();
        const diffHours = (pickupDateTime - now) / (1000 * 60 * 60);

        if (diffHours < 8) {
          timingLabel = "Short notice (< 8 hours)";
          timingNote = " This trip is within the next 8 hours. Please submit as a request only and wait for confirmation before paying.";
          canPayNow = false;
        } else {
          timingLabel = "Standard (‚â• 8 hours)";
          timingNote = " This trip is more than 8 hours away. You can pay with Square once your option is selected.";
          canPayNow = true;
        }

        timingBanner.textContent =
          "Pickup time check: " + timingLabel + ". " +
          (diffHours > 0
            ? "Approx. " + diffHours.toFixed(1) + " hours from now."
            : "Pickup time appears to be in the past or very soon. We will review it.");
      } else {
        timingBanner.textContent =
          "Once you select your pickup date and time, we‚Äôll tell you if this is a short-notice request (< 8 hours) or a standard booking (‚â• 8 hours).";
      }

      const route = routeSelect.value;
      const vehicle = vehicleSelect.value;
      const tripType = tripTypeSelect.value;

      currentIsCustom = (route === "CUSTOM");

      if (currentIsCustom) {
        priceText.textContent =
          "Custom route selected." +
          (timingNote ? timingNote + " We will confirm price by email." : " We will confirm price by email.");

        selectedOptionInput.value =
          "Custom route ‚Äì price to be confirmed. Timing: " + timingLabel;

        currentSelectionReady = true;
      } else if (!route || !vehicle || !tripType) {
        priceText.textContent =
          "Please select a route, vehicle and trip type to see the price." + (timingNote || "");
        selectedOptionInput.value = "";
      } else {
        const pricing = getDisplayedTotal(route, vehicle, tripType);
        currentHasFixedPrice = pricing.hasFixedPrice;

        if (!currentHasFixedPrice) {
          priceText.textContent =
            "We don't have a fixed price for that exact combination. Please describe your trip in the notes and we will confirm price." +
            (timingNote || "");

          selectedOptionInput.value =
            `No fixed price: route=${route}, vehicle=${vehicle}, tripType=${tripType}. Timing: ${timingLabel}`;
        } else {
          const vehicleLabel = prettyVehicle(vehicle);
          const tripLabel = prettyTrip(tripType);

          if (route === "HOURLY" && tripType === "HOURLY") {
            priceText.textContent =
              `Selected: Hourly Charter ‚Äì ${vehicleLabel} at $${pricing.unit}/hr √ó ${pricing.hours} hours = $${pricing.total}.` +
              timingNote;

            selectedOptionInput.value =
              `Route: ${route}, Vehicle: ${vehicle}, Trip type: ${tripLabel}, Rate: $${pricing.unit}/hr, Hours: ${pricing.hours}, Total: $${pricing.total}, Timing: ${timingLabel}`;
          } else {
            priceText.textContent =
              `Selected: ${tripLabel} ${vehicleLabel} for ${route} ‚Äì $${pricing.total}.` +
              timingNote;

            selectedOptionInput.value =
              `Route: ${route}, Vehicle: ${vehicle}, Trip type: ${tripLabel}, Price: $${pricing.total}, Timing: ${timingLabel}`;
          }
        }

        currentSelectionReady = true;
      }

      currentCanPayNow = !!(pickupDateTime && canPayNow);

      // Show Square pay button only if eligible AND fixed-price AND not custom
      const showPayBtn = currentCanPayNow && currentHasFixedPrice && !currentIsCustom;

      if (squarePayBtn) {
        squarePayBtn.style.display = showPayBtn ? "inline-block" : "none";
        squarePayBtn.disabled = false;
      }
    }

    // Prefill from Rates query params
    function prefillFromQueryString() {
      const params = new URLSearchParams(window.location.search);
      if (!params || [...params.keys()].length === 0) return;

      const rawRoute = params.get("route") || "";
      const rawVehicle = params.get("vehicle") || "";
      const rawTrip = params.get("trip") || "";

      const routeMap = {
        "MCO-Universal-Idrive-Seaworld-Convention": "MCO_UNIVERSAL",
        "MCO-Disney-LBV-BayLake-GoldenOak": "MCO_DISNEY",
        "MCO-Windermere-WinterPark": "MCO_WINDERMERE",
        "MCO-Port-Canaveral": "MCO_PORT",
        "SFB-Universal-Idrive-Seaworld-Convention": "SFB_IDRIVE",
        "SFB-Disney-LBV-BayLake-GoldenOak": "SFB_DISNEY",
        "Hourly-Orlando": "HOURLY",
      };

      const vehicleMap = {
        "Sedan": "SEDAN",
        "SUV": "SUV",
        "Van8": "VAN8",
        "Van14": "VAN14",
      };

      const tripMap = {
        "oneway": "ONEWAY",
        "round": "ROUND",
        "hourly": "HOURLY",
      };

      const mappedRoute = routeMap[rawRoute] || "";
      const mappedVehicle = vehicleMap[rawVehicle] || "";
      const mappedTrip = tripMap[(rawTrip || "").toLowerCase()] || "";

      if (mappedRoute) routeSelect.value = mappedRoute;
      if (mappedVehicle) vehicleSelect.value = mappedVehicle;
      if (mappedTrip) tripTypeSelect.value = mappedTrip;

      const hoursParam = parseInt(params.get("hours") || "", 10);
      if (!isNaN(hoursParam) && hoursParam >= 3 && hoursParam <= 24 && charterHoursSelect) {
        charterHoursSelect.value = String(hoursParam);
      }
    }

    // --- Child seats repeater ---
    const seatRows = document.getElementById("seat-rows");
    const addSeatRowBtn = document.getElementById("add-seat-row");
    const childSeatsSummary = document.getElementById("child-seats-summary");

    function updateSeatsSummary() {
      if (!seatRows || !childSeatsSummary) return;

      const rows = seatRows.querySelectorAll(".seat-row");
      const parts = [];

      rows.forEach((row) => {
        const type = row.querySelector(".seat-type")?.value || "";
        const qty = row.querySelector(".seat-qty")?.value || "";
        if (type && qty) parts.push(`${qty} √ó ${type}`);
      });

      childSeatsSummary.value = parts.length ? parts.join("; ") : "None selected";
    }

    function toggleSeatRemoveButtons() {
      if (!seatRows) return;
      const rows = seatRows.querySelectorAll(".seat-row");
      rows.forEach((row) => {
        const btn = row.querySelector(".seat-remove");
        if (btn) btn.style.display = rows.length > 1 ? "inline-block" : "none";
      });
    }

    function makeSeatRow() {
      const row = document.createElement("div");
      row.className = "seat-row";
      row.style.display = "grid";
      row.style.gridTemplateColumns = "1fr 90px 40px";
      row.style.gap = "0.5rem";
      row.style.alignItems = "center";
      row.style.marginTop = "0.5rem";

      row.innerHTML = `
        <select class="seat-type" name="Child seat type[]" aria-label="Seat type">
          <option value="">Select seat type</option>
          <option value="Rear-facing infant seat">Rear-facing infant seat</option>
          <option value="Forward-facing car seat">Forward-facing car seat</option>
          <option value="Booster seat">Booster seat</option>
        </select>

        <select class="seat-qty" name="Child seat quantity[]" aria-label="Quantity">
          <option value="">#</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>

        <button type="button" class="seat-remove btn-secondary" aria-label="Remove seat selection" style="padding:0.4rem 0.6rem;">
          √ó
        </button>
      `;

      const typeEl = row.querySelector(".seat-type");
      const qtyEl = row.querySelector(".seat-qty");
      const removeBtn = row.querySelector(".seat-remove");

      typeEl.addEventListener("change", updateSeatsSummary);
      qtyEl.addEventListener("change", updateSeatsSummary);

      removeBtn.addEventListener("click", () => {
        row.remove();
        toggleSeatRemoveButtons();
        updateSeatsSummary();
      });

      return row;
    }

    if (addSeatRowBtn && seatRows) {
      seatRows.querySelectorAll(".seat-type, .seat-qty").forEach((el) => {
        el.addEventListener("change", updateSeatsSummary);
      });

      addSeatRowBtn.addEventListener("click", () => {
        seatRows.appendChild(makeSeatRow());
        toggleSeatRemoveButtons();
        updateSeatsSummary();
      });

      toggleSeatRemoveButtons();
      updateSeatsSummary();
    }

    async function createPaymentLinkOrThrow() {
      const route = routeSelect.value;
      const vehicle = vehicleSelect.value;
      const tripType = tripTypeSelect.value;
      const hours = parseInt(charterHoursSelect?.value || "3", 10) || 3;
      const email = document.getElementById("email")?.value || "";

      const payload = { route, vehicle, tripType, hours, customerEmail: email };

      const resp = await fetch(`${API_BASE}/api/create-payment-link`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await resp.json().catch(() => ({}));

      if (!resp.ok) {
        throw new Error(data.error || `Square link error (HTTP ${resp.status})`);
      }
      if (!data.url) {
        throw new Error("Missing payment link URL from API.");
      }
      return data.url;
    }

    // Separate Square button click
    if (squarePayBtn) {
      squarePayBtn.addEventListener("click", async () => {
        setSquareStatus("");

        if (!currentSelectionReady) {
          setSquareStatus("Please complete your pickup time and fare selection first.");
          return;
        }
        if (!currentCanPayNow) {
          setSquareStatus("This is a short-notice trip (< 8 hours). Please wait for confirmation before paying.");
          return;
        }
        if (!currentHasFixedPrice || currentIsCustom) {
          setSquareStatus("This option does not have a fixed online price. Please submit the request and we‚Äôll confirm.");
          return;
        }

        squarePayBtn.disabled = true;
        squarePayBtn.textContent = "Creating Square link...";

        try {
          const url = await createPaymentLinkOrThrow();
          setSquareStatus("Redirecting to Square...");
          window.location.href = url;
        } catch (err) {
          setSquareStatus(err?.message || "Could not create payment link. Please try again.");
        } finally {
          squarePayBtn.disabled = false;
          squarePayBtn.textContent = "Pay with Square";
        }
      });
    }

    // Form submit: ONLY sends request (no Square redirect)
    bookingForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      updateSeatsSummary();
      updateUI();

      if (formStatus) {
        formStatus.style.display = "none";
        formStatus.textContent = "";
      }

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = "Sending...";
      }

      try {
        const formData = new FormData(bookingForm);

        const res = await fetch(bookingForm.action, {
          method: "POST",
          body: formData,
          headers: { "Accept": "application/json" }
        });

        if (!res.ok) {
          let msg = "Sorry‚Äîthere was a problem sending your request. Please try again, or call/text us.";
          try {
            const data = await res.json();
            if (data && data.errors && data.errors.length) {
              msg = data.errors.map(e => e.message).join(" ");
            }
          } catch (_) {}

          if (formStatus) {
            formStatus.style.display = "block";
            formStatus.textContent = msg;
          }
          return;
        }

        if (formStatus) {
          formStatus.style.display = "block";
          formStatus.textContent = "Request sent! We‚Äôll confirm availability and follow up by email/text.";
        }

      } catch (err) {
        if (formStatus) {
          formStatus.style.display = "block";
          formStatus.textContent =
            (err && err.message)
              ? err.message
              : "Network error‚Äîplease check your connection and try again, or call/text us.";
        }
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit booking request";
        }
      }
    });

    // Listeners
    routeSelect.addEventListener("change", updateUI);
    vehicleSelect.addEventListener("change", updateUI);
    tripTypeSelect.addEventListener("change", updateUI);
    pickupDateInput.addEventListener("change", updateUI);
    pickupTimeInput.addEventListener("change", updateUI);
    if (charterHoursSelect) charterHoursSelect.addEventListener("change", updateUI);

    // Init
    prefillFromQueryString();
    updateUI();
    updateSeatsSummary();
  </script>
</body>
</html>
